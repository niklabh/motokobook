<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Mastering Motoko!</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Mastering Motoko!</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#mastering-motoko" id="toc-mastering-motoko">Mastering
Motoko</a>
<ul>
<li><a href="#table-of-contents" id="toc-table-of-contents">Table of
Contents</a></li>
</ul></li>
<li><a href="#preface" id="toc-preface">Preface</a></li>
<li><a href="#foreword" id="toc-foreword">Foreword</a></li>
<li><a href="#chapter-1-introduction-to-the-internet-computer-protocol"
id="toc-chapter-1-introduction-to-the-internet-computer-protocol">Chapter
1: Introduction to the Internet Computer Protocol</a>
<ul>
<li><a href="#introduction-to-the-internet-computer-protocol-icp"
id="toc-introduction-to-the-internet-computer-protocol-icp">1.0
Introduction to the Internet Computer Protocol (ICP)</a></li>
<li><a href="#the-necessity-of-the-actor-model"
id="toc-the-necessity-of-the-actor-model">1.1 The Necessity of the Actor
Model</a></li>
<li><a href="#the-canister-environment"
id="toc-the-canister-environment">1.2 The Canister Environment</a></li>
<li><a href="#the-development-lifecycle"
id="toc-the-development-lifecycle">1.3 The Development
Lifecycle</a></li>
<li><a href="#setting-up-your-local-development-environment"
id="toc-setting-up-your-local-development-environment">1.4 Setting Up
Your Local Development Environment</a></li>
</ul></li>
<li><a href="#chapter-2-motoko-fundamentals"
id="toc-chapter-2-motoko-fundamentals">Chapter 2: Motoko
Fundamentals</a>
<ul>
<li><a href="#hello-world" id="toc-hello-world">2.1 Hello,
World!</a></li>
<li><a href="#basic-syntax" id="toc-basic-syntax">2.2 Basic Syntax</a>
<ul>
<li><a href="#comments" id="toc-comments">2.2.1 Comments</a></li>
<li><a href="#expressions-and-blocks"
id="toc-expressions-and-blocks">2.2.2 Expressions and Blocks</a></li>
<li><a href="#identifiers-and-naming"
id="toc-identifiers-and-naming">2.2.3 Identifiers and Naming</a></li>
</ul></li>
<li><a href="#types" id="toc-types">2.3 Types</a>
<ul>
<li><a href="#primitive-types" id="toc-primitive-types">2.3.1 Primitive
Types</a></li>
<li><a href="#composite-types" id="toc-composite-types">2.3.2 Composite
Types</a></li>
<li><a href="#function-types" id="toc-function-types">2.3.3 Function
Types</a></li>
<li><a href="#async-types" id="toc-async-types">2.3.4 Async
Types</a></li>
<li><a href="#generic-types" id="toc-generic-types">2.3.5 Generic
Types</a></li>
</ul></li>
<li><a href="#declarations" id="toc-declarations">2.4 Declarations</a>
<ul>
<li><a href="#immutable-declarations-let"
id="toc-immutable-declarations-let">2.4.1 Immutable Declarations
(<code>let</code>)</a></li>
<li><a href="#mutable-declarations-var"
id="toc-mutable-declarations-var">2.4.2 Mutable Declarations
(<code>var</code>)</a></li>
<li><a href="#function-declarations"
id="toc-function-declarations">2.4.3 Function Declarations</a></li>
<li><a href="#type-declarations" id="toc-type-declarations">2.4.4 Type
Declarations</a></li>
</ul></li>
<li><a href="#control-flow" id="toc-control-flow">2.5 Control Flow</a>
<ul>
<li><a href="#conditionals" id="toc-conditionals">2.5.1
Conditionals</a></li>
<li><a href="#loops" id="toc-loops">2.5.2 Loops</a></li>
<li><a href="#switch-and-pattern-matching"
id="toc-switch-and-pattern-matching">2.5.3 Switch and Pattern
Matching</a></li>
</ul></li>
<li><a href="#actors-and-async-data" id="toc-actors-and-async-data">2.6
Actors and Async Data</a>
<ul>
<li><a href="#understanding-actors" id="toc-understanding-actors">2.6.1
Understanding Actors</a></li>
<li><a href="#public-and-private-functions"
id="toc-public-and-private-functions">2.6.2 Public and Private
Functions</a></li>
<li><a href="#async-and-await" id="toc-async-and-await">2.6.3 Async and
Await</a></li>
<li><a href="#actor-classes" id="toc-actor-classes">2.6.4 Actor
Classes</a></li>
<li><a href="#caller-identity" id="toc-caller-identity">2.6.5 Caller
Identity</a></li>
</ul></li>
<li><a href="#mutable-state" id="toc-mutable-state">2.7 Mutable
State</a>
<ul>
<li><a href="#mutable-variables" id="toc-mutable-variables">2.7.1
Mutable Variables</a></li>
<li><a href="#mutable-collections" id="toc-mutable-collections">2.7.2
Mutable Collections</a></li>
<li><a href="#state-transitions" id="toc-state-transitions">2.7.3 State
Transitions</a></li>
</ul></li>
<li><a href="#messaging" id="toc-messaging">2.8 Messaging</a>
<ul>
<li><a href="#update-vs-query-messages"
id="toc-update-vs-query-messages">2.8.1 Update vs Query
Messages</a></li>
<li><a href="#one-way-messages" id="toc-one-way-messages">2.8.2 One-way
Messages</a></li>
<li><a href="#inter-canister-calls" id="toc-inter-canister-calls">2.8.3
Inter-Canister Calls</a></li>
<li><a href="#error-handling-in-messages"
id="toc-error-handling-in-messages">2.8.4 Error Handling in
Messages</a></li>
</ul></li>
<li><a href="#modules-and-imports" id="toc-modules-and-imports">2.9
Modules and Imports</a>
<ul>
<li><a href="#defining-modules" id="toc-defining-modules">2.9.1 Defining
Modules</a></li>
<li><a href="#importing-local-modules"
id="toc-importing-local-modules">2.9.2 Importing Local Modules</a></li>
<li><a href="#importing-from-base-library"
id="toc-importing-from-base-library">2.9.3 Importing from Base
Library</a></li>
<li><a href="#module-patterns" id="toc-module-patterns">2.9.4 Module
Patterns</a></li>
</ul></li>
<li><a href="#pattern-matching" id="toc-pattern-matching">2.10 Pattern
Matching</a>
<ul>
<li><a href="#basic-patterns" id="toc-basic-patterns">2.10.1 Basic
Patterns</a></li>
<li><a href="#tuple-patterns" id="toc-tuple-patterns">2.10.2 Tuple
Patterns</a></li>
<li><a href="#record-patterns" id="toc-record-patterns">2.10.3 Record
Patterns</a></li>
<li><a href="#variant-patterns" id="toc-variant-patterns">2.10.4 Variant
Patterns</a></li>
<li><a href="#array-patterns" id="toc-array-patterns">2.10.5 Array
Patterns</a></li>
<li><a href="#guards" id="toc-guards">2.10.6 Guards</a></li>
</ul></li>
<li><a href="#error-handling" id="toc-error-handling">2.11 Error
Handling</a>
<ul>
<li><a href="#try-catch" id="toc-try-catch">2.11.1 Try-Catch</a></li>
<li><a href="#result-type" id="toc-result-type">2.11.2 Result
Type</a></li>
<li><a href="#option-type" id="toc-option-type">2.11.3 Option
Type</a></li>
<li><a href="#assert-and-debug" id="toc-assert-and-debug">2.11.4 Assert
and Debug</a></li>
<li><a href="#error-propagation" id="toc-error-propagation">2.11.5 Error
Propagation</a></li>
</ul></li>
<li><a href="#data-persistence" id="toc-data-persistence">2.12 Data
Persistence</a>
<ul>
<li><a href="#stable-variables" id="toc-stable-variables">2.12.1 Stable
Variables</a></li>
<li><a href="#stable-types" id="toc-stable-types">2.12.2 Stable
Types</a></li>
<li><a href="#upgrade-hooks" id="toc-upgrade-hooks">2.12.3 Upgrade
Hooks</a></li>
<li><a href="#migration-patterns" id="toc-migration-patterns">2.12.4
Migration Patterns</a></li>
</ul></li>
<li><a href="#garbage-collection" id="toc-garbage-collection">2.13
Garbage Collection</a>
<ul>
<li><a href="#memory-management" id="toc-memory-management">2.13.1
Memory Management</a></li>
<li><a href="#memory-optimization" id="toc-memory-optimization">2.13.2
Memory Optimization</a></li>
<li><a href="#monitoring-memory-usage"
id="toc-monitoring-memory-usage">2.13.3 Monitoring Memory Usage</a></li>
</ul></li>
<li><a href="#orthogonal-persistence"
id="toc-orthogonal-persistence">2.14 Orthogonal Persistence</a>
<ul>
<li><a href="#understanding-orthogonal-persistence"
id="toc-understanding-orthogonal-persistence">2.14.1 Understanding
Orthogonal Persistence</a></li>
<li><a href="#stable-vs-regular-variables"
id="toc-stable-vs-regular-variables">2.14.2 Stable vs Regular
Variables</a></li>
<li><a href="#persistence-lifecycle"
id="toc-persistence-lifecycle">2.14.3 Persistence Lifecycle</a></li>
<li><a href="#best-practices" id="toc-best-practices">2.14.4 Best
Practices</a></li>
</ul></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
</ul></li>
<li><a href="#chapter-3-type-system-and-safety"
id="toc-chapter-3-type-system-and-safety">Chapter 3: Type System and
Safety</a>
<ul>
<li><a href="#nominal-vs.-structural-typing"
id="toc-nominal-vs.-structural-typing">3.1 Nominal vs. Structural
Typing</a></li>
<li><a href="#the-billion-dollar-mistake-option-types"
id="toc-the-billion-dollar-mistake-option-types">3.2 The Billion Dollar
Mistake: Option Types</a></li>
<li><a href="#more-primitive-types" id="toc-more-primitive-types">3.3
More Primitive Types</a></li>
<li><a href="#composite-types-1" id="toc-composite-types-1">3.4
Composite Types</a></li>
<li><a href="#type-aliases" id="toc-type-aliases">3.5 Type
Aliases</a></li>
<li><a href="#generics" id="toc-generics">3.6 Generics</a></li>
<li><a href="#type-inference" id="toc-type-inference">3.7 Type
Inference</a></li>
</ul></li>
<li><a href="#chapter-4-motoko-memory-architecture"
id="toc-chapter-4-motoko-memory-architecture">Chapter 4: Motoko Memory
Architecture</a>
<ul>
<li><a href="#the-stable-heap" id="toc-the-stable-heap">4.1 The Stable
Heap</a></li>
<li><a href="#the-legacy-solution-stable-variables"
id="toc-the-legacy-solution-stable-variables">4.2 The Legacy Solution:
Stable Variables</a></li>
<li><a href="#the-modern-standard-enhanced-orthogonal-persistence-eop"
id="toc-the-modern-standard-enhanced-orthogonal-persistence-eop">4.3 The
Modern Standard: Enhanced Orthogonal Persistence (EOP)</a></li>
<li><a href="#implementing-persistence-in-openpatron"
id="toc-implementing-persistence-in-openpatron">4.4 Implementing
Persistence in OpenPatron</a></li>
</ul></li>
<li><a href="#chapter-5-identity-and-access-control"
id="toc-chapter-5-identity-and-access-control">Chapter 5: Identity and
Access Control</a>
<ul>
<li><a href="#internet-identity-and-principals"
id="toc-internet-identity-and-principals">5.1 Internet Identity and
Principals</a></li>
<li><a href="#the-frontend-backend-handshake"
id="toc-the-frontend-backend-handshake">5.2 The Frontend-Backend
Handshake</a></li>
<li><a href="#storing-user-profiles" id="toc-storing-user-profiles">5.3
Storing User Profiles</a></li>
<li><a href="#implementing-user-profiles"
id="toc-implementing-user-profiles">5.4 Implementing User
Profiles</a></li>
<li><a href="#access-control-patterns"
id="toc-access-control-patterns">5.5 Access Control Patterns</a></li>
<li><a href="#roles-and-permissions" id="toc-roles-and-permissions">5.6
Roles and Permissions</a></li>
<li><a href="#security-considerations"
id="toc-security-considerations">5.7 Security Considerations</a></li>
<li><a href="#frontend-integration" id="toc-frontend-integration">5.8
Frontend Integration</a></li>
<li><a href="#complete-openpatron-identity-implementation"
id="toc-complete-openpatron-identity-implementation">5.9 Complete
OpenPatron Identity Implementation</a></li>
<li><a href="#testing-and-deployment"
id="toc-testing-and-deployment">5.10 Testing and Deployment</a></li>
</ul></li>
<li><a href="#chapter-6-tokenomics-and-ledger-integration"
id="toc-chapter-6-tokenomics-and-ledger-integration">Chapter 6:
Tokenomics and Ledger Integration</a>
<ul>
<li><a href="#inter-canister-ledger-interactions"
id="toc-inter-canister-ledger-interactions">6.1 Inter-Canister Ledger
Interactions</a></li>
<li><a href="#the-deposit-pattern-vs.-approvetransferfrom"
id="toc-the-deposit-pattern-vs.-approvetransferfrom">6.2 The Deposit
Pattern vs. Approve/TransferFrom</a></li>
<li><a href="#deterministic-subaccount-derivation"
id="toc-deterministic-subaccount-derivation">6.3 Deterministic
Subaccount Derivation</a></li>
<li><a href="#verifying-deposits-against-the-ledger"
id="toc-verifying-deposits-against-the-ledger">6.4 Verifying Deposits
Against the Ledger</a></li>
<li><a href="#withdrawals-refunds-and-creator-payouts"
id="toc-withdrawals-refunds-and-creator-payouts">6.5 Withdrawals,
Refunds, and Creator Payouts</a></li>
<li><a href="#supporting-multiple-tokens-icrc-1-vs.-icrc-2"
id="toc-supporting-multiple-tokens-icrc-1-vs.-icrc-2">6.6 Supporting
Multiple Tokens (ICRC-1 vs. ICRC-2)</a></li>
<li><a href="#local-testing-with-the-ledger-canister"
id="toc-local-testing-with-the-ledger-canister">6.7 Local Testing with
the Ledger Canister</a></li>
<li><a href="#operational-safeguards"
id="toc-operational-safeguards">6.8 Operational Safeguards</a></li>
</ul></li>
<li><a href="#chapter-7-autonomous-subscriptions-via-timers"
id="toc-chapter-7-autonomous-subscriptions-via-timers">Chapter 7:
Autonomous Subscriptions via Timers</a>
<ul>
<li><a href="#the-timer-api" id="toc-the-timer-api">7.1 The Timer
API</a></li>
<li><a href="#efficiency-and-virtual-transactions"
id="toc-efficiency-and-virtual-transactions">7.2 Efficiency and
“Virtual” Transactions</a></li>
<li><a href="#scheduling-windows-and-drift"
id="toc-scheduling-windows-and-drift">7.3 Scheduling Windows and
Drift</a></li>
<li><a href="#modeling-the-subscription-queue"
id="toc-modeling-the-subscription-queue">7.4 Modeling the Subscription
Queue</a></li>
<li><a href="#failure-modes-and-recovery"
id="toc-failure-modes-and-recovery">7.5 Failure Modes and
Recovery</a></li>
<li><a href="#manual-overrides-and-observability"
id="toc-manual-overrides-and-observability">7.6 Manual Overrides and
Observability</a></li>
<li><a href="#testing-timer-logic-without-waiting"
id="toc-testing-timer-logic-without-waiting">7.7 Testing Timer Logic
Without Waiting</a></li>
</ul></li>
<li><a href="#chapter-8-asynchronous-safety-and-reentrancy"
id="toc-chapter-8-asynchronous-safety-and-reentrancy">Chapter 8:
Asynchronous Safety and Reentrancy</a>
<ul>
<li><a href="#the-await-gap" id="toc-the-await-gap">8.1 The Await
Gap</a></li>
<li><a href="#the-solution-optimistic-accounting-vs.-locks"
id="toc-the-solution-optimistic-accounting-vs.-locks">8.2 The Solution:
Optimistic Accounting vs. Locks</a></li>
<li><a href="#visualizing-the-await-gap"
id="toc-visualizing-the-await-gap">8.3 Visualizing the Await
Gap</a></li>
<li><a href="#guarding-with-pending-operations"
id="toc-guarding-with-pending-operations">8.4 Guarding with Pending
Operations</a></li>
<li><a href="#idempotent-external-calls"
id="toc-idempotent-external-calls">8.5 Idempotent External
Calls</a></li>
<li><a href="#testing-for-reentrancy-bugs"
id="toc-testing-for-reentrancy-bugs">8.6 Testing for Reentrancy
Bugs</a></li>
<li><a href="#chapter-9-external-integrations"
id="toc-chapter-9-external-integrations">Chapter 9: External
Integrations</a>
<ul>
<li><a href="#http-outcalls" id="toc-http-outcalls">9.1 HTTP
Outcalls</a></li>
<li><a href="#native-bitcoin-integration"
id="toc-native-bitcoin-integration">9.2 Native Bitcoin
Integration</a></li>
<li><a href="#ckbtc-the-practical-solution"
id="toc-ckbtc-the-practical-solution">9.3 ckBTC: The Practical
Solution</a></li>
<li><a href="#summary-1" id="toc-summary-1">9.4 Summary</a></li>
</ul></li>
<li><a href="#chapter-10-frontend-integration-asset-storage"
id="toc-chapter-10-frontend-integration-asset-storage">Chapter 10:
Frontend Integration &amp; Asset Storage</a>
<ul>
<li><a href="#the-asset-canister" id="toc-the-asset-canister">10.1 The
Asset Canister</a></li>
<li><a href="#connecting-frontend-to-backend"
id="toc-connecting-frontend-to-backend">10.2 Connecting Frontend to
Backend</a></li>
<li><a href="#certified-variables-and-security"
id="toc-certified-variables-and-security">10.3 Certified Variables and
Security</a></li>
<li><a href="#custom-domains" id="toc-custom-domains">10.4 Custom
Domains</a></li>
<li><a href="#summary-2" id="toc-summary-2">10.5 Summary</a></li>
</ul></li>
</ul></li>
<li><a href="#chapter-11-ecosystem-tools-and-testing"
id="toc-chapter-11-ecosystem-tools-and-testing">Chapter 11: Ecosystem
Tools and Testing</a>
<ul>
<li><a href="#dependency-management-with-mops"
id="toc-dependency-management-with-mops">9.1 Dependency Management with
Mops</a></li>
<li><a href="#testing-strategies" id="toc-testing-strategies">9.2
Testing Strategies</a></li>
<li><a href="#integration-testing-with-pocketic"
id="toc-integration-testing-with-pocketic">9.3 Integration Testing with
PocketIC</a></li>
<li><a href="#property-based-testing"
id="toc-property-based-testing">9.4 Property-Based Testing</a></li>
<li><a href="#debugging-techniques" id="toc-debugging-techniques">9.5
Debugging Techniques</a></li>
<li><a href="#continuous-integration"
id="toc-continuous-integration">9.6 Continuous Integration</a></li>
<li><a href="#best-practices-1" id="toc-best-practices-1">9.7 Best
Practices</a></li>
<li><a href="#performance-testing" id="toc-performance-testing">9.8
Performance Testing</a></li>
</ul></li>
<li><a href="#chapter-12-the-economics-of-deployment"
id="toc-chapter-12-the-economics-of-deployment">Chapter 12: The
Economics of Deployment</a>
<ul>
<li><a href="#understanding-cycles-the-fuel-of-the-internet-computer"
id="toc-understanding-cycles-the-fuel-of-the-internet-computer">10.1
Understanding Cycles: The Fuel of the Internet Computer</a></li>
<li><a href="#building-a-sustainable-economic-model"
id="toc-building-a-sustainable-economic-model">10.2 Building a
Sustainable Economic Model</a></li>
<li><a href="#deployment-process-and-best-practices"
id="toc-deployment-process-and-best-practices">10.3 Deployment Process
and Best Practices</a></li>
<li><a href="#the-black-hole-and-immutability"
id="toc-the-black-hole-and-immutability">10.4 The Black Hole and
Immutability</a></li>
<li><a href="#monitoring-and-maintenance"
id="toc-monitoring-and-maintenance">10.5 Monitoring and
Maintenance</a></li>
<li><a href="#cost-optimization-strategies"
id="toc-cost-optimization-strategies">10.6 Cost Optimization
Strategies</a></li>
<li><a href="#upgrade-strategies" id="toc-upgrade-strategies">10.7
Upgrade Strategies</a></li>
<li><a href="#case-study-openpatron-deployment-costs"
id="toc-case-study-openpatron-deployment-costs">10.8 Case Study:
OpenPatron Deployment Costs</a></li>
<li><a href="#summary-3" id="toc-summary-3">10.9 Summary</a></li>
</ul></li>
<li><a href="#chapter-13-the-service-nervous-system-sns"
id="toc-chapter-13-the-service-nervous-system-sns">Chapter 13: The
Service Nervous System (SNS)</a>
<ul>
<li><a href="#the-architecture-of-sns"
id="toc-the-architecture-of-sns">11.1 The Architecture of SNS</a></li>
<li><a href="#neurons-the-foundation-of-governance"
id="toc-neurons-the-foundation-of-governance">11.2 Neurons: The
Foundation of Governance</a></li>
<li><a href="#proposal-types-and-governance"
id="toc-proposal-types-and-governance">11.3 Proposal Types and
Governance</a></li>
<li><a href="#voting-mechanisms" id="toc-voting-mechanisms">11.4 Voting
Mechanisms</a></li>
<li><a href="#token-economics-and-distribution"
id="toc-token-economics-and-distribution">11.5 Token Economics and
Distribution</a></li>
<li><a href="#practical-implementation-sns-enabling-openpatron"
id="toc-practical-implementation-sns-enabling-openpatron">11.6 Practical
Implementation: SNS-Enabling OpenPatron</a></li>
<li><a href="#integrating-sns-governance-into-your-dapp"
id="toc-integrating-sns-governance-into-your-dapp">11.7 Integrating SNS
Governance into Your Dapp</a></li>
<li><a href="#benefits-and-trade-offs"
id="toc-benefits-and-trade-offs">11.8 Benefits and Trade-offs</a></li>
<li><a href="#best-practices-for-sns-launch"
id="toc-best-practices-for-sns-launch">11.9 Best Practices for SNS
Launch</a></li>
<li><a href="#case-study-openpatron-sns-journey"
id="toc-case-study-openpatron-sns-journey">11.10 Case Study: OpenPatron
SNS Journey</a></li>
<li><a href="#the-future-of-sns" id="toc-the-future-of-sns">11.11 The
Future of SNS</a></li>
<li><a href="#summary-4" id="toc-summary-4">11.12 Summary</a></li>
</ul></li>
<li><a href="#chapter-14-troubleshooting-and-best-practices"
id="toc-chapter-14-troubleshooting-and-best-practices">Chapter 14:
Troubleshooting and Best Practices</a>
<ul>
<li><a href="#common-compiler-errors"
id="toc-common-compiler-errors">12.1 Common Compiler Errors</a></li>
<li><a href="#debugging-techniques-1"
id="toc-debugging-techniques-1">12.2 Debugging Techniques</a></li>
<li><a href="#best-practices-2" id="toc-best-practices-2">12.3 Best
Practices</a></li>
<li><a href="#performance-optimization"
id="toc-performance-optimization">12.4 Performance Optimization</a></li>
<li><a href="#testing-strategies-1" id="toc-testing-strategies-1">12.5
Testing Strategies</a></li>
<li><a href="#common-pitfalls-and-solutions"
id="toc-common-pitfalls-and-solutions">12.6 Common Pitfalls and
Solutions</a></li>
<li><a href="#monitoring-and-maintenance-1"
id="toc-monitoring-and-maintenance-1">12.7 Monitoring and
Maintenance</a></li>
<li><a href="#summary-5" id="toc-summary-5">12.8 Summary</a></li>
</ul></li>
<li><a href="#resources" id="toc-resources">Resources</a>
<ul>
<li><a href="#official-documentation"
id="toc-official-documentation">Official Documentation</a>
<ul>
<li><a href="#motoko-language" id="toc-motoko-language">Motoko
Language</a></li>
<li><a href="#internet-computer-protocol"
id="toc-internet-computer-protocol">Internet Computer Protocol</a></li>
</ul></li>
<li><a href="#service-nervous-system-sns"
id="toc-service-nervous-system-sns">Service Nervous System
(SNS)</a></li>
<li><a href="#community-and-learning-resources"
id="toc-community-and-learning-resources">Community and Learning
Resources</a>
<ul>
<li><a href="#official-community-channels"
id="toc-official-community-channels">Official Community
Channels</a></li>
<li><a href="#learning-platforms" id="toc-learning-platforms">Learning
Platforms</a></li>
<li><a href="#example-projects" id="toc-example-projects">Example
Projects</a></li>
</ul></li>
<li><a href="#development-tools" id="toc-development-tools">Development
Tools</a>
<ul>
<li><a href="#ides-and-extensions" id="toc-ides-and-extensions">IDEs and
Extensions</a></li>
</ul></li>
<li><a href="#staying-updated" id="toc-staying-updated">Staying
Updated</a></li>
<li><a href="#contributing-to-this-resource-list"
id="toc-contributing-to-this-resource-list">Contributing to This
Resource List</a></li>
<li><a href="#about-this-book" id="toc-about-this-book">About This
Book</a>
<ul>
<li><a href="#technical-specifications"
id="toc-technical-specifications">Technical Specifications</a></li>
<li><a href="#contributing" id="toc-contributing">Contributing</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="mastering-motoko">Mastering Motoko</h1>
<p><strong>The Definitive Guide to Decentralized Application Engineering
on the Internet Computer</strong></p>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><strong>Preface</strong></li>
<li><strong>Foreword</strong></li>
<li><strong>Chapter 1</strong>: Introduction to the Internet Computer
Protocol</li>
<li><strong>Chapter 2</strong>: Motoko Fundamentals</li>
<li><strong>Chapter 3</strong>: Type System and Safety</li>
<li><strong>Chapter 4</strong>: Motoko Memory Architecture</li>
<li><strong>Chapter 5</strong>: Identity and Access Control</li>
<li><strong>Chapter 6</strong>: Tokenomics and Ledger Integration</li>
<li><strong>Chapter 7</strong>: Autonomous Subscriptions via Timers</li>
<li><strong>Chapter 8</strong>: Asynchronous Safety and Reentrancy</li>
<li><strong>Chapter 9</strong>: External Integrations</li>
<li><strong>Chapter 11</strong>: Frontend Integration &amp; Asset
Storage</li>
<li><strong>Chapter 12</strong>: The Economics of Deployment</li>
<li><strong>Chapter 13</strong>: The Service Nervous System (SNS)</li>
<li><strong>Chapter 14</strong>: Troubleshooting and Best Practices</li>
<li><strong>Resources</strong>: Official Documentation and Links</li>
</ul>
<hr />
<hr />
<h1 id="preface">Preface</h1>
<p>The evolution of blockchain technology has progressed from simple
value transfer (Bitcoin) to programmable smart contracts (Ethereum), and
now to the third generation: the Internet Computer Protocol (ICP). This
platform represents a paradigm shift from fragmented architectures—where
smart contracts, storage, and frontend interfaces are decoupled—to a
unified “World Computer” model. In this environment, software exists as
autonomous “canisters,” computational units that bundle WebAssembly
(Wasm) bytecode with memory pages, capable of serving web assets
directly to users while performing complex backend logic.</p>
<p>This comprehensive report serves as the authoritative manual for
<strong>Motoko</strong>, the domain-specific language designed by
DFINITY to exploit the unique capabilities of the Internet Computer.
While the platform supports other languages such as Rust, Motoko is
purpose-built to abstract the complexities of the underlying actor-based
model and orthogonal persistence.</p>
<p>Structured as an exhaustive technical resource, this document guides
the reader from the theoretical underpinnings of the Actor Model to the
practical implementation of “OpenPatron,” a fully decentralized,
censorship-resistant membership platform. Through this case study, we
analyze advanced patterns in identity management, recurring payment
systems (tokenomics), asynchronous messaging safety, and the emerging
standard of Enhanced Orthogonal Persistence (EOP).</p>
<p>The Internet Computer is not just a blockchain; it is a cloud
replacement. And Motoko is its native language. The tools and patterns
detailed in this report provide the necessary foundation to build the
next generation of sovereign, unstoppable web applications.</p>
<hr />
<h1 id="foreword">Foreword</h1>
<p>For over a decade, blockchain developers have been constrained by an
uncomfortable truth: we weren’t really building “decentralized”
applications. We were building fragmented systems where the smart
contract lived on-chain, the frontend was hosted on AWS, and the data
sat in Firebase. We called this “Web3,” but in practice, we were simply
adding expensive append-only databases to Web2 architectures.</p>
<p>The promise was autonomy. The reality was dependency.</p>
<p>I’ve spent years navigating this landscape—writing Solidity contracts
that could barely store a kilobyte without triggering outrageous gas
fees, architecting systems where a single Amazon outage would render a
“decentralized” application completely inaccessible, and explaining to
users why their transaction failed because they didn’t pay enough for
computation. Each compromise felt necessary. Each workaround felt
clever. But collectively, they represented a fundamental betrayal of the
blockchain vision.</p>
<p>When I first encountered the Internet Computer Protocol, my initial
reaction was skepticism. Another “Ethereum killer”? Another promise of
infinite scalability? The industry had become saturated with ambitious
whitepapers that dissolved upon contact with reality.</p>
<p>Then I wrote my first Motoko program.</p>
<p>What you’re about to read is not a gentle introduction to “blockchain
development.” This book assumes you understand why decentralization
matters and are frustrated that current tools make it nearly impossible
to achieve. The author doesn’t waste time relitigating the merits of
smart contracts or explaining what a blockchain is. Instead, this text
operates at a higher level of discourse: <em>How do we build software
that is truly autonomous, truly persistent, and truly
sovereign?</em></p>
<p>The answer, it turns out, requires unlearning nearly everything we
know about backend development.</p>
<p>Motoko is deceptively familiar. Its syntax borrows from TypeScript,
Swift, and Rust. A JavaScript developer can read a basic Motoko function
and understand its intent within minutes. But beneath this familiar
surface lies a radically different computational model. There are no
databases because state <em>is</em> memory, and memory <em>is</em>
persistent. There are no cron jobs because canisters can schedule their
own execution. There are no load balancers because the protocol handles
replication and consensus automatically.</p>
<p>This is the paradigm shift that most developers miss. They approach
Motoko as “JavaScript for blockchain” and immediately encounter
friction. Why can’t I just read another actor’s variables? Why does
every function return a Promise? Why am I thinking about “cycles”
instead of dollars per month?</p>
<p>The answer to all these questions is the same: <em>You’re not writing
an application. You’re writing an autonomous agent that will execute in
a hostile, asynchronous, distributed environment where every assumption
about traditional computing is inverted.</em></p>
<p>This book teaches you to think like that agent.</p>
<p>The structure is deliberate. Part I establishes the theoretical
foundations—not as academic exercise, but as essential mental models.
You cannot write safe asynchronous code without understanding the Actor
Model. You cannot architect scalable systems without understanding
orthogonal persistence. These aren’t “nice to know” topics; they’re
load-bearing concepts that will determine whether your canister survives
in production or traps during its first upgrade.</p>
<p>Parts II and III form the technical core, systematically dissecting
Motoko’s type system, memory model, and persistence mechanisms. This
section alone is worth the price of admission. The author doesn’t just
explain <em>how</em> stable variables work; they explain <em>why</em>
the traditional approach fails at scale and how Enhanced Orthogonal
Persistence (EOP) resolves the upgrade problem that has bricked
countless canisters.</p>
<p>But theory without application is sterile. This is why Parts IV
through VI build “OpenPatron,” a production-grade decentralized
subscription platform. This case study is brilliant in its specificity.
Rather than building yet another token swap or NFT marketplace, the
author tackles one of the hardest problems in crypto: recurring
payments. This requires solving identity (Internet Identity
integration), tokenomics (ICRC-1 ledger interactions), asynchronous
safety (reentrancy protection), and autonomous execution (timer-based
subscription processing).</p>
<p>By the time you finish implementing OpenPatron, you won’t just
understand Motoko—you’ll understand distributed systems engineering.</p>
<p>I want to be clear about who this book is <em>not</em> for. If you’re
looking for a weekend tutorial that holds your hand through deploying a
“Hello World” dapp, this isn’t it. There are gentler introductions
available, and they serve an important purpose. This book assumes you’re
serious. It assumes you’re willing to read a paragraph three times to
fully grasp the implications of an await statement. It assumes you care
about the difference between a TrieMap and a StableBTreeMap because
you’re building something that needs to scale to millions of users.</p>
<p>This is a manual for professionals.</p>
<p>The Internet Computer is the first blockchain that actually delivers
on the original promise: software that runs forever, costs almost
nothing, and cannot be shut down. Motoko is the language designed from
first principles to exploit this environment. And this book is the
definitive guide to mastering both.</p>
<p>If you’re ready to build the infrastructure for a truly decentralized
future—not as a slogan, but as an engineering discipline—turn the
page.</p>
<p>The Actor Model awaits.</p>
<hr />
<h1
id="chapter-1-introduction-to-the-internet-computer-protocol">Chapter 1:
Introduction to the Internet Computer Protocol</h1>
<p>To master Motoko, one must first understand the hostile and
asynchronous environment in which it executes. The Internet Computer
does not function like a traditional server, nor does it mimic the
synchronous state transitions of the Ethereum Virtual Machine (EVM). It
operates as a distributed operating system hosting autonomous
agents.</p>
<h3 id="introduction-to-the-internet-computer-protocol-icp">1.0
Introduction to the Internet Computer Protocol (ICP)</h3>
<p>The Internet Computer Protocol (ICP), developed by the DFINITY
Foundation, represents the third generation of blockchain technology.
Unlike first-generation blockchains like Bitcoin (focused on value
transfer) or second-generation platforms like Ethereum (introducing
programmable smart contracts), ICP aims to create a “World Computer”—a
global, tamper-proof computational platform that can host full-stack
applications entirely on-chain.</p>
<p>At its core, ICP is a decentralized network of independent data
centers running specialized node machines. These nodes form “subnets,”
each functioning as a sovereign blockchain capable of processing smart
contracts at web speed. The protocol uses advanced cryptographic
techniques, including <strong>Chain-Key Cryptography</strong>, to enable
seamless communication between subnets and direct interaction with the
web. This allows ICP to scale horizontally by adding more subnets,
theoretically supporting billions of users without the performance
bottlenecks seen in monolithic blockchains like Ethereum.</p>
<p>ICP’s native token, also called ICP, serves multiple purposes:
governance (through the Network Nervous System), payment for
computational resources (via “cycles”), and staking for neuron-based
voting. However, unlike gas models in other chains, ICP employs a
“reverse gas model” where developers pre-pay for canister resources,
making user interactions feel free and instantaneous.</p>
<h4 id="a-new-paradigm-for-writing-applications">A New Paradigm for
Writing Applications</h4>
<p>Traditional web applications follow a client-server model: frontend
code runs in the browser, backend logic on centralized servers (e.g.,
AWS), and data in databases (e.g., PostgreSQL). This architecture is
efficient but vulnerable—servers can be hacked, censored, or shut down
by authorities or corporations.</p>
<p>Blockchain applications on platforms like Ethereum attempt to
decentralize the backend via smart contracts, but they remain
fragmented: contracts handle logic and state, but storage is expensive
(leading to off-chain solutions like IPFS), frontends are hosted
centrally, and scalability is limited by global consensus.</p>
<p>ICP introduces a paradigm shift by unifying the entire application
stack on-chain: - <strong>Canisters as Autonomous Units:</strong>
Applications are deployed as “canisters”—self-contained bundles of
WebAssembly code and persistent memory. A single canister can serve HTTP
requests, process backend logic, and store data, eliminating the need
for separate servers or databases. - <strong>Direct Web
Serving:</strong> Canisters can host and serve web assets (HTML, CSS,
JS) directly to browsers via certified HTTP responses, verified through
chain-key signatures. This makes dApps indistinguishable from Web2 apps
in speed and user experience. - <strong>Infinite Scalability:</strong>
Each canister runs on its own subnet, and subnets operate in parallel.
This “sharded” architecture allows ICP to scale by adding hardware, not
by optimizing a single chain. - <strong>Built-in Persistence:</strong>
State is automatically preserved across upgrades via orthogonal
persistence, abstracting away the complexities of data
serialization.</p>
<p>In essence, writing applications on ICP feels like developing for a
global, unstoppable cloud platform. Developers focus on business logic
rather than infrastructure, with the protocol handling replication,
security, and availability.</p>
<h4 id="why-icp-is-superior-for-decentralized-applications-dapps">Why
ICP is Superior for Decentralized Applications (dApps)</h4>
<p>ICP addresses the core limitations of previous blockchain platforms,
making it profoundly better for building dApps: - <strong>True
Decentralization:</strong> Unlike Ethereum dApps that rely on
centralized frontends (e.g., via Cloudflare) or off-chain storage, ICP
dApps run entirely on-chain. This provides censorship resistance—once
deployed, a canister cannot be taken down without consensus from the
entire network. - <strong>Performance and Cost Efficiency:</strong>
Transactions (messages) on ICP are processed in seconds with negligible
cost to users. Subnets enable parallel execution, avoiding the
“blockchain trilemma” where scalability sacrifices decentralization or
security. For context, ICP can handle over 250,000 queries per second
across its network, far surpassing Ethereum’s ~15 transactions per
second. - <strong>Developer-Friendly Economics:</strong> The reverse gas
model shifts costs to developers, who can subsidize users or implement
sustainable tokenomics. Cycles, burned for computation, create
deflationary pressure on ICP tokens, aligning incentives. -
<strong>Enhanced Security Features:</strong> Chain-key cryptography
enables unique capabilities like threshold signatures for secure
randomness and direct Bitcoin/Ethereum integration without oracles.
Canisters are replicated across geographically diverse nodes, mitigating
single points of failure. - <strong>Web3-Native Experiences:</strong>
dApps on ICP can use Internet Identity for seamless, privacy-preserving
authentication (no passwords or seed phrases needed). This lowers
barriers for mainstream adoption, as users interact with dApps like any
website.</p>
<p>Relevant Innovations: - <strong>Network Nervous System
(NNS):</strong> ICP’s on-chain governance DAO, where staked ICP holders
vote on proposals to upgrade the protocol or add subnets. -
<strong>Boundary Nodes:</strong> Act as gateways, handling HTTP traffic
and providing DDoS protection while preserving decentralization. -
<strong>Integration with Legacy Systems:</strong> ICP supports direct
calls to Bitcoin and Ethereum, enabling hybrid applications that
leverage multiple chains.</p>
<p>By mastering ICP’s model, developers can build dApps that are not
just “blockchain-enabled” but fundamentally reimagined as autonomous,
global services. This foundation sets the stage for understanding the
Actor Model and canisters, which are the building blocks of ICP
applications.</p>
<p>The fundamental unit of deployment on the Internet Computer is the
<strong>Canister Smart Contract</strong>. A canister is not merely a
script; it is a persistent process that encapsulates both its code
(Wasm) and its state (Memory). This architecture is heavily influenced
by the <strong>Actor Model</strong>, a conceptual model of concurrent
computation that originated in the 1970s but has found its ideal
implementation in the distributed nature of the ICP.</p>
<h3 id="the-necessity-of-the-actor-model">1.1 The Necessity of the Actor
Model</h3>
<p>In traditional software development, concurrency is often managed
through threads sharing the same memory space. This approach
necessitates complex locking mechanisms (mutexes, semaphores) to prevent
race conditions, where two processes attempt to modify the same data
simultaneously. In a distributed blockchain environment, shared memory
is impossible.</p>
<p>Motoko adopts the Actor Model to resolve this. An actor is a
self-contained unit of state and behavior.</p>
<ul>
<li><p><strong>Encapsulation:</strong> The state of an actor (variables,
data structures) is strictly private. No external entity—neither a user
nor another canister—can read or write to this state directly.</p></li>
<li><p><strong>Message Passing:</strong> Communication occurs solely
through asynchronous message passing. To request an action or data, an
external entity sends a message (a function call) to the actor.</p></li>
<li><p><strong>Sequential Processing:</strong> The actor processes its
mailbox of messages sequentially, one at a time. This guarantees that
within the execution of a single message, the developer has exclusive
access to the state, eliminating the need for locks.</p></li>
</ul>
<h3 id="the-canister-environment">1.2 The Canister Environment</h3>
<p>Every Motoko program compiles into a WebAssembly module that runs
inside a canister. The Internet Computer Protocol ensures that this
execution is deterministic and replicated across multiple nodes in a
subnet.</p>
<p><strong>Table 1: Comparison of Execution Models</strong></p>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 29%" />
<col style="width: 29%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>Traditional Server (AWS)</th>
<th>Ethereum Smart Contract</th>
<th>Internet Computer Canister</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>State Storage</strong></td>
<td>External Database (SQL/NoSQL)</td>
<td>Merkle Patricia Trie (expensive)</td>
<td>Orthogonal Persistence (Memory Pages)</td>
</tr>
<tr>
<td><strong>Concurrency</strong></td>
<td>Multi-threaded (Complex)</td>
<td>Serial/Atomic (Global Lock)</td>
<td>Actor Model (Async Inter-canister)</td>
</tr>
<tr>
<td><strong>Cost Model</strong></td>
<td>Monthly Server Rental</td>
<td>User pays Gas per Transaction</td>
<td>Developer pays “Cycles” (Reverse Gas)</td>
</tr>
<tr>
<td><strong>Frontend</strong></td>
<td>Hosted separately (S3/Nginx)</td>
<td>Hosted separately (IPFS/Centralized)</td>
<td>Served directly from Canister</td>
</tr>
</tbody>
</table>
<h3 id="the-development-lifecycle">1.3 The Development Lifecycle</h3>
<p>The development workflow relies on the DFINITY Canister SDK,
specifically the <code>dfx</code> command-line interface. This toolchain
manages the entire lifecycle of a canister, from creation to compilation
and deployment.</p>
<p>When initializing a new project (<code>dfx new open_patron</code>),
the <code>dfx.json</code> configuration file becomes the central nervous
system of the application. It defines the network topology, the distinct
canisters (backend logic vs. frontend assets), and their
dependencies.</p>
<p><strong>The Local Replica:</strong></p>
<p>Developing directly on the mainnet is costly and slow. The
<code>dfx start --clean --background</code> command launches a local
replica—a full simulation of the Internet Computer blockchain running on
the developer’s machine. This environment mocks the subnet consensus,
generates local canister IDs, and provides a local ledger for testing
token integration.</p>
<h3 id="setting-up-your-local-development-environment">1.4 Setting Up
Your Local Development Environment</h3>
<p>To write and deploy Motoko programs, you must establish a development
environment on your local machine. This section provides step-by-step
instructions for installing and configuring the necessary tools.</p>
<h4 id="system-requirements">1.4.1 System Requirements</h4>
<p>Before installation, ensure your system meets the following minimum
requirements:</p>
<p><strong>Operating System:</strong> - macOS 12.* Monterey or later -
Ubuntu 20.04 LTS or later - Windows 10/11 with Windows Subsystem for
Linux 2 (WSL2)</p>
<p><strong>Hardware:</strong> - Minimum 4GB RAM (8GB recommended for
running local replica) - 10GB available disk space - x86-64 processor
(Apple Silicon/M1/M2 supported via Rosetta 2)</p>
<p><strong>Network:</strong> - Stable internet connection for
downloading dependencies and deploying to mainnet</p>
<h4 id="installing-the-dfinity-canister-sdk-dfx">1.4.2 Installing the
DFINITY Canister SDK (dfx)</h4>
<p>The <code>dfx</code> command-line tool is the cornerstone of Motoko
development. It manages project scaffolding, local replicas, canister
compilation, and deployment.</p>
<p><strong>For macOS and Linux:</strong></p>
<p>Open a terminal and execute the following command:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sh</span> <span class="at">-ci</span> <span class="st">&quot;</span><span class="va">$(</span><span class="ex">curl</span> <span class="at">-fsSL</span> https://internetcomputer.org/install.sh<span class="va">)</span><span class="st">&quot;</span></span></code></pre></div>
<p>This script will: 1. Download the latest stable version of
<code>dfx</code> 2. Install it to
<code>~/.local/share/dfinity/bin/</code> 3. Add the binary to your
PATH</p>
<p><strong>Verifying the Installation:</strong></p>
<p>After installation completes, verify the version:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> <span class="at">--version</span></span></code></pre></div>
<p>You should see output similar to:</p>
<pre><code>dfx 0.16.1</code></pre>
<p><strong>For Windows (WSL2):</strong></p>
<ol type="1">
<li>First, install WSL2 if not already present. Open PowerShell as
Administrator:</li>
</ol>
<div class="sourceCode" id="cb4"><pre
class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>wsl <span class="op">--</span>install</span></code></pre></div>
<ol start="2" type="1">
<li>Restart your computer and set up Ubuntu from the Microsoft
Store</li>
<li>Launch Ubuntu and run the same installation script as Linux:</li>
</ol>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sh</span> <span class="at">-ci</span> <span class="st">&quot;</span><span class="va">$(</span><span class="ex">curl</span> <span class="at">-fsSL</span> https://internetcomputer.org/install.sh<span class="va">)</span><span class="st">&quot;</span></span></code></pre></div>
<p><strong>Installing a Specific Version:</strong></p>
<p>If you need a particular version of <code>dfx</code> for
compatibility:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">DFX_VERSION</span><span class="op">=</span>0.16.1 <span class="fu">sh</span> <span class="at">-ci</span> <span class="st">&quot;</span><span class="va">$(</span><span class="ex">curl</span> <span class="at">-fsSL</span> https://internetcomputer.org/install.sh<span class="va">)</span><span class="st">&quot;</span></span></code></pre></div>
<p><strong>Updating dfx:</strong></p>
<p>To update to the latest version:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> upgrade</span></code></pre></div>
<h4 id="installing-node.js-and-npm-optional-but-recommended">1.4.3
Installing Node.js and npm (Optional but Recommended)</h4>
<p>While Motoko backend development doesn’t require Node.js, most
projects include a JavaScript/TypeScript frontend. Additionally, some
tooling and asset management depends on npm.</p>
<p><strong>Using Node Version Manager (nvm) - Recommended:</strong></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install nvm</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-o-</span> https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh <span class="kw">|</span> <span class="fu">bash</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload shell configuration</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc  <span class="co"># or ~/.zshrc for zsh</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Node.js LTS</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ex">nvm</span> install <span class="at">--lts</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="ex">nvm</span> use <span class="at">--lts</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify installation</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="ex">node</span> <span class="at">--version</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> <span class="at">--version</span></span></code></pre></div>
<p><strong>Alternative: Direct Installation</strong></p>
<p>Visit <a href="https://nodejs.org/">nodejs.org</a> and download the
LTS version for your platform.</p>
<h4 id="creating-your-first-motoko-project">1.4.4 Creating Your First
Motoko Project</h4>
<p>With <code>dfx</code> installed, you can scaffold a new project:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new project named &quot;hello_world&quot;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> new hello_world</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate into the project directory</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> hello_world</span></code></pre></div>
<p>During project creation, <code>dfx</code> will prompt you to select a
frontend framework. For pure Motoko learning, choose “No JS template” or
“SvelteKit” for a more complete setup.</p>
<p><strong>Project Structure:</strong></p>
<pre><code>hello_world/
├── dfx.json              # Project configuration
├── src/
│   ├── hello_world_backend/
│   │   └── main.mo       # Motoko backend code
│   └── hello_world_frontend/
│       ├── assets/       # Static assets (HTML, CSS, images)
│       └── src/          # Frontend JavaScript/TypeScript
├── .dfx/                 # Build artifacts (gitignored)
└── canister_ids.json     # Canister identifiers (after deployment)</code></pre>
<p><strong>Understanding dfx.json:</strong></p>
<p>The <code>dfx.json</code> file is the manifest for your project.
Here’s an annotated example:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;canisters&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hello_world_backend&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;src/hello_world_backend/main.mo&quot;</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;motoko&quot;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hello_world_frontend&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;hello_world_backend&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;src/hello_world_frontend/assets&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;assets&quot;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;defaults&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;build&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;packtool&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="dv">1</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<ul>
<li><strong>canisters:</strong> Defines each canister in your
project</li>
<li><strong>main:</strong> Entry point for the Motoko code</li>
<li><strong>type:</strong> “motoko” for backend, “assets” for static
frontend</li>
<li><strong>dependencies:</strong> Declares inter-canister
dependencies</li>
<li><strong>version:</strong> Schema version for
<code>dfx.json</code></li>
</ul>
<h4 id="starting-the-local-replica">1.4.5 Starting the Local
Replica</h4>
<p>Before deploying canisters, you must start a local Internet Computer
replica:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> start <span class="at">--background</span></span></code></pre></div>
<p><strong>Flags:</strong> - <code>--background</code>: Runs the replica
in the background, freeing your terminal - <code>--clean</code>: Wipes
all state (useful for fresh starts)</p>
<p><strong>What Happens:</strong></p>
<p>The local replica simulates a subnet on your machine, running on
<code>http://127.0.0.1:4943</code> (replica) and
<code>http://127.0.0.1:4943/?canisterId=&lt;id&gt;</code> for frontend
access.</p>
<p><strong>Checking Status:</strong></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> ping</span></code></pre></div>
<p>Expected output:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;certified_height&quot;</span><span class="fu">:</span> <span class="dv">1234</span><span class="fu">,</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;healthy&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;replica_health_status&quot;</span><span class="fu">:</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Stopping the Replica:</strong></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> stop</span></code></pre></div>
<h4 id="deploying-your-first-canister">1.4.6 Deploying Your First
Canister</h4>
<p>With the replica running, deploy your canisters:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy</span></code></pre></div>
<p>This command: 1. Compiles <code>main.mo</code> to WebAssembly 2.
Generates canister IDs 3. Installs the Wasm module on the local replica
4. Deploys frontend assets</p>
<p><strong>Output Example:</strong></p>
<pre><code>Deploying all canisters.
Creating canisters...
Creating canister hello_world_backend...
hello_world_backend canister created with canister id: rrkah-fqaaa-aaaaa-aaaaq-cai
Creating canister hello_world_frontend...
hello_world_frontend canister created with canister id: ryjl3-tyaaa-aaaaa-aaaba-cai
Installing canisters...
Installing code for canister hello_world_backend...
Installing code for canister hello_world_frontend...</code></pre>
<p><strong>Interacting with Your Canister:</strong></p>
<p>If your <code>main.mo</code> contains a public function like:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> func <span class="fu">greet</span>(<span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;Hello, &quot;</span> # name # <span class="st">&quot;!&quot;</span><span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>You can call it from the command line:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister call hello_world_backend greet <span class="st">&#39;(&quot;World&quot;)&#39;</span></span></code></pre></div>
<p>Output:</p>
<pre><code>(&quot;Hello, World!&quot;)</code></pre>
<h4 id="essential-dfx-commands">1.4.7 Essential dfx Commands</h4>
<p>Master these commands for efficient development:</p>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 59%" />
</colgroup>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dfx new &lt;name&gt;</code></td>
<td>Create a new project</td>
</tr>
<tr>
<td><code>dfx start [--background] [--clean]</code></td>
<td>Start local replica</td>
</tr>
<tr>
<td><code>dfx stop</code></td>
<td>Stop local replica</td>
</tr>
<tr>
<td><code>dfx deploy [canister]</code></td>
<td>Deploy all canisters (or specific one)</td>
</tr>
<tr>
<td><code>dfx build</code></td>
<td>Compile canisters without deploying</td>
</tr>
<tr>
<td><code>dfx canister call &lt;canister&gt; &lt;method&gt; &lt;args&gt;</code></td>
<td>Invoke canister function</td>
</tr>
<tr>
<td><code>dfx canister status &lt;canister&gt;</code></td>
<td>Check canister memory/cycles</td>
</tr>
<tr>
<td><code>dfx canister delete &lt;canister&gt;</code></td>
<td>Remove canister from replica</td>
</tr>
<tr>
<td><code>dfx identity list</code></td>
<td>View available identities</td>
</tr>
<tr>
<td><code>dfx identity use &lt;name&gt;</code></td>
<td>Switch active identity</td>
</tr>
<tr>
<td><code>dfx ledger account-id</code></td>
<td>Show your account identifier</td>
</tr>
</tbody>
</table>
<p><strong>Example Workflow:</strong></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start fresh</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> start <span class="at">--clean</span> <span class="at">--background</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make changes to main.mo</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ...edit code...</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Rebuild and redeploy</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Test changes</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister call hello_world_backend greet <span class="st">&#39;(&quot;Motoko&quot;)&#39;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop when done</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> stop</span></code></pre></div>
<h4 id="configuring-your-code-editor">1.4.8 Configuring Your Code
Editor</h4>
<p>For optimal Motoko development, configure your editor with proper
syntax highlighting and language server support.</p>
<p><strong>Visual Studio Code (Recommended):</strong></p>
<ol type="1">
<li>Install VS Code from <a
href="https://code.visualstudio.com/">code.visualstudio.com</a></li>
<li>Install the Motoko extension:
<ul>
<li>Open Extensions (Cmd+Shift+X / Ctrl+Shift+X)</li>
<li>Search for “Motoko”</li>
<li>Install the official extension by DFINITY Foundation</li>
</ul></li>
</ol>
<p><strong>Features:</strong> - Syntax highlighting - Code completion -
Inline error checking - Go to definition - Code formatting</p>
<p><strong>Vim/Neovim:</strong></p>
<p>Install the Motoko syntax plugin:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For vim-plug</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Plug</span> <span class="st">&#39;dfinity/motoko.vim&#39;</span></span></code></pre></div>
<p><strong>IntelliJ IDEA:</strong></p>
<p>Currently no official plugin, but you can configure: 1. Settings →
Editor → File Types 2. Add new file type pattern: <code>*.mo</code> 3.
Associate with JavaScript for basic highlighting</p>
<p><strong>Configuring Language Server Protocol (LSP):</strong></p>
<p>For advanced IDE features, the Motoko language server provides: -
Type inference hints - Refactoring support - Jump to definition across
canisters</p>
<p>The language server is included with <code>dfx</code> and
automatically used by supported editors.</p>
<h4 id="understanding-identities-and-wallets">1.4.9 Understanding
Identities and Wallets</h4>
<p><code>dfx</code> manages cryptographic identities for authentication.
Each identity has: - A <strong>Principal ID</strong>: Your unique
identifier on ICP (like an address) - A <strong>Private Key</strong>:
Stored securely in <code>~/.config/dfx/identity/</code></p>
<p><strong>Viewing Your Default Identity:</strong></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity whoami</span></code></pre></div>
<p>Output: <code>default</code></p>
<p><strong>Getting Your Principal:</strong></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity get-principal</span></code></pre></div>
<p>Output (example):</p>
<pre><code>tsqwz-udeik-5migd-ehrev-pvoqv-szx2g-akh5s-fkyqc-zy6q7-qpqai-eqe</code></pre>
<p><strong>Creating New Identities:</strong></p>
<p>For testing multi-user scenarios:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new identity</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity new alice</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity new bob</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Switch to alice</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity use alice</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy as alice</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Switch back to default</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity use default</span></code></pre></div>
<p><strong>Cycles Wallet:</strong></p>
<p>On the mainnet, you’ll need cycles to power canisters. Create a
cycles wallet:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> identity <span class="at">--network</span> ic get-wallet</span></code></pre></div>
<p>(This requires ICP tokens to be converted to cycles via the NNS.)</p>
<h4 id="troubleshooting-common-issues">1.4.10 Troubleshooting Common
Issues</h4>
<p><strong>Issue: “dfx: command not found”</strong></p>
<p>Solution: Add dfx to your PATH:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;export PATH=&quot;$PATH:$HOME/.local/share/dfinity/bin&quot;&#39;</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span></code></pre></div>
<p><strong>Issue: “Replica failed to start”</strong></p>
<p>Solutions: - Ensure port 4943 is not in use:
<code>lsof -ti:4943</code> - Kill conflicting processes:
<code>dfx stop &amp;&amp; dfx start --clean</code> - Check for firewall
restrictions</p>
<p><strong>Issue: “Cannot connect to replica”</strong></p>
<p>Solution: Verify replica is running:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> ping</span></code></pre></div>
<p>If it fails, restart:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> start <span class="at">--background</span></span></code></pre></div>
<p><strong>Issue: “Canister method not found”</strong></p>
<p>Cause: Code changes not deployed.</p>
<p>Solution:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy <span class="at">--mode</span> reinstall</span></code></pre></div>
<p><strong>Issue: Memory errors when deploying</strong></p>
<p>Cause: Insufficient cycles or memory quota.</p>
<p>Solution: For local development, restart with clean state:</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> start <span class="at">--clean</span> <span class="at">--background</span></span></code></pre></div>
<h4 id="next-steps">1.4.11 Next Steps</h4>
<p>With your environment configured, you’re ready to dive into Motoko
programming:</p>
<ol type="1">
<li>Experiment with the default <code>main.mo</code> template</li>
<li>Read the generated canister interface in
<code>.dfx/local/canisters/</code></li>
<li>Explore the Candid UI at
<code>http://127.0.0.1:4943/?canisterId=&lt;candid_ui_id&gt;</code></li>
<li>Modify functions and observe how type signatures affect
deployment</li>
</ol>
<p>The subsequent chapters will dissect Motoko’s type system,
asynchronous patterns, and advanced canister architectures. The
foundational knowledge of the Actor Model and the operational mechanics
of <code>dfx</code> are essential prerequisites for mastering these
concepts.</p>
<hr />
<hr />
<h1 id="chapter-2-motoko-fundamentals">Chapter 2: Motoko
Fundamentals</h1>
<p>Motoko is a strongly typed, functional-first programming language
specifically designed for the Internet Computer. Its syntax draws
inspiration from JavaScript, Swift, and Rust, but its semantics are
meticulously crafted to leverage the unique capabilities and constraints
of the Internet Computer Protocol (ICP). This chapter provides a
comprehensive introduction to Motoko’s fundamental concepts, syntax, and
programming patterns.</p>
<p>Before building sophisticated decentralized applications, you must
master Motoko’s core building blocks. This chapter walks through the
essential language features that form the foundation of all Motoko
programs: from basic syntax and type systems to advanced concepts like
actors, asynchronous programming, and orthogonal persistence.</p>
<h2 id="hello-world">2.1 Hello, World!</h2>
<p>Every programming journey begins with a simple “Hello, World!”
program. In Motoko, this introduces you to the actor model and basic
output.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">greet</span>(<span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Hello, &quot;</span> # name # <span class="st">&quot;!&quot;</span><span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This minimal program demonstrates several key concepts: -
<strong>Actor</strong>: The fundamental unit of computation on the
Internet Computer - <strong>Public function</strong>: Exposed as a
canister endpoint - <strong>Async</strong>: All public functions must
return async values - <strong>Text concatenation</strong>: Using the
<code>#</code> operator</p>
<h2 id="basic-syntax">2.2 Basic Syntax</h2>
<p>Motoko’s syntax is designed to be familiar yet precise. Understanding
these foundational elements is crucial for writing correct and efficient
code.</p>
<h3 id="comments">2.2.1 Comments</h3>
<p>Motoko supports both single-line and multi-line comments:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This is a single-line comment</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* This is a </span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">   multi-line comment */</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// Documentation comment for functions</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">example</span>() <span class="op">:</span> <span class="kw">async</span> () {}<span class="op">;</span></span></code></pre></div>
<h3 id="expressions-and-blocks">2.2.2 Expressions and Blocks</h3>
<p>Motoko is an <strong>expression-oriented language</strong>—nearly
everything evaluates to a value. Code blocks return the value of their
last expression.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> result <span class="op">=</span> {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> x <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> y <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    x <span class="op">+</span> y  <span class="co">// Returns 30 (no semicolon!)</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> noValue <span class="op">=</span> {</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> x <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> y <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">+</span> y<span class="op">;</span>  <span class="co">// Returns () because of semicolon</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>The Semicolon Rule</strong>: The semicolon <code>;</code> is
a separator, not a terminator. If the last expression in a block ends
with a semicolon, the block returns <code>()</code> (Unit type, similar
to void).</p>
<h3 id="identifiers-and-naming">2.2.3 Identifiers and Naming</h3>
<ul>
<li><strong>Variables and functions</strong>: Use camelCase
(<code>myVariable</code>, <code>calculateTotal</code>)</li>
<li><strong>Types and modules</strong>: Use PascalCase
(<code>UserAccount</code>, <code>HashMapModule</code>)</li>
<li><strong>Constants</strong>: Can use UPPER_CASE by convention</li>
<li><strong>Reserved keywords</strong>: <code>actor</code>,
<code>async</code>, <code>await</code>, <code>break</code>,
<code>case</code>, <code>catch</code>, <code>class</code>,
<code>continue</code>, <code>debug</code>, <code>else</code>,
<code>false</code>, <code>for</code>, <code>func</code>,
<code>if</code>, <code>in</code>, <code>import</code>, <code>let</code>,
<code>loop</code>, <code>module</code>, <code>null</code>,
<code>object</code>, <code>public</code>, <code>private</code>,
<code>return</code>, <code>shared</code>, <code>switch</code>,
<code>true</code>, <code>try</code>, <code>type</code>,
<code>var</code>, <code>while</code></li>
</ul>
<div class="sourceCode" id="cb36"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> userName <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span>        <span class="co">// Valid</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> user_name <span class="op">=</span> <span class="st">&quot;Bob&quot;</span><span class="op">;</span>         <span class="co">// Valid</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> MAX_RETRIES <span class="op">=</span> <span class="dv">3</span><span class="op">;</span>           <span class="co">// Valid</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">// let 123abc = &quot;Invalid&quot;;     // Invalid: cannot start with digit</span></span></code></pre></div>
<h2 id="types">2.3 Types</h2>
<p>Motoko’s type system is its greatest strength, providing compile-time
guarantees that prevent entire categories of bugs. The language is
<strong>strongly typed</strong> and uses <strong>type inference</strong>
to reduce verbosity while maintaining safety.</p>
<h3 id="primitive-types">2.3.1 Primitive Types</h3>
<h4 id="numeric-types">Numeric Types</h4>
<div class="sourceCode" id="cb37"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Natural numbers (non-negative, unbounded)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> count <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> large <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">1_000_000_000</span><span class="op">;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Integers (signed, unbounded)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> temperature <span class="op">:</span> Int <span class="op">=</span> <span class="op">-</span><span class="dv">15</span><span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> delta <span class="op">:</span> Int <span class="op">=</span> <span class="op">+</span><span class="dv">100</span><span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Fixed-width unsigned integers</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> byte <span class="op">:</span> Nat8 <span class="op">=</span> <span class="dv">255</span><span class="op">;</span>          <span class="co">// 0 to 255</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> port <span class="op">:</span> Nat16 <span class="op">=</span> <span class="dv">8080</span><span class="op">;</span>        <span class="co">// 0 to 65,535</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> id <span class="op">:</span> Nat32 <span class="op">=</span> <span class="dv">4_294_967_295</span><span class="op">;</span> <span class="co">// 0 to 2^32-1</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> bigId <span class="op">:</span> Nat64 <span class="op">=</span> <span class="dv">18_446_744_073_709_551_615</span><span class="op">;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Fixed-width signed integers</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> smallInt <span class="op">:</span> Int8 <span class="op">=</span> <span class="op">-</span><span class="dv">128</span><span class="op">;</span>     <span class="co">// -128 to 127</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> medInt <span class="op">:</span> Int16 <span class="op">=</span> <span class="op">-</span><span class="dv">32_768</span><span class="op">;</span>   <span class="co">// -32,768 to 32,767</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> normalInt <span class="op">:</span> Int32 <span class="op">=</span> <span class="op">-</span><span class="dv">2_147_483_648</span><span class="op">;</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> bigInt <span class="op">:</span> Int64 <span class="op">=</span> <span class="op">-</span><span class="dv">9_223_372_036_854_775_808</span><span class="op">;</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Floating-point (64-bit IEEE 754)</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> pi <span class="op">:</span> Float <span class="op">=</span> <span class="fl">3.14159</span><span class="op">;</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> scientific <span class="op">:</span> Float <span class="op">=</span> <span class="fl">1.23e-4</span><span class="op">;</span></span></code></pre></div>
<p><strong>Key Points</strong>: - <code>Nat</code> and <code>Int</code>
are <strong>unbounded</strong> (arbitrary precision) - Use fixed-width
types (<code>Nat32</code>, <code>Int64</code>) for performance-critical
code - Overflow behavior: unbounded types never overflow; fixed-width
types trap</p>
<h4 id="boolean-type">Boolean Type</h4>
<div class="sourceCode" id="cb38"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> isActive <span class="op">:</span> Bool <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> hasPermission <span class="op">:</span> Bool <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> result <span class="op">=</span> isActive and hasPermission<span class="op">;</span>  <span class="co">// false</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> canProceed <span class="op">=</span> isActive or hasPermission<span class="op">;</span>  <span class="co">// true</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> inverted <span class="op">=</span> not isActive<span class="op">;</span>  <span class="co">// false</span></span></code></pre></div>
<h4 id="text-and-character-types">Text and Character Types</h4>
<div class="sourceCode" id="cb39"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Text (UTF-8 strings)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> greeting <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;Hello, Motoko!&quot;</span><span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> emoji <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;🚀&quot;</span><span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> multiline <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;Line 1</span><span class="sc">\n</span><span class="st">Line 2</span><span class="sc">\n</span><span class="st">Line 3&quot;</span><span class="op">;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Character (single Unicode scalar value)</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> letter <span class="op">:</span> Char <span class="op">=</span> <span class="st">&#39;M&#39;</span><span class="op">;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> unicode <span class="op">:</span> Char <span class="op">=</span> <span class="st">&#39;∑&#39;</span><span class="op">;</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Text concatenation</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> fullName <span class="op">=</span> <span class="st">&quot;Alice&quot;</span> # <span class="st">&quot; &quot;</span> # <span class="st">&quot;Smith&quot;</span><span class="op">;</span>  <span class="co">// &quot;Alice Smith&quot;</span></span></code></pre></div>
<h4 id="special-types">Special Types</h4>
<div class="sourceCode" id="cb40"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Blob (immutable byte arrays)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> data <span class="op">:</span> <span class="bu">Blob</span> <span class="op">=</span> <span class="st">&quot;</span><span class="sc">\00\01\02\03</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> empty <span class="op">:</span> <span class="bu">Blob</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Principal (unique identifiers for users and canisters)</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> user <span class="op">:</span> Principal <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;aaaaa-aa&quot;</span>)<span class="op">;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> canisterId <span class="op">:</span> Principal <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromActor</span>(myActor)<span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Unit type (like void)</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> nothing <span class="op">:</span> () <span class="op">=</span> ()<span class="op">;</span></span></code></pre></div>
<h3 id="composite-types">2.3.2 Composite Types</h3>
<h4 id="arrays">Arrays</h4>
<p>Arrays in Motoko are <strong>immutable by default</strong> and have
fixed size.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Immutable array</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> numbers <span class="op">:</span> [Nat] <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> names <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> [<span class="st">&quot;Alice&quot;</span><span class="op">,</span> <span class="st">&quot;Bob&quot;</span><span class="op">,</span> <span class="st">&quot;Charlie&quot;</span>]<span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> empty <span class="op">:</span> [Int] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Array access</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> first <span class="op">=</span> numbers[<span class="dv">0</span>]<span class="op">;</span>  <span class="co">// 1</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> last <span class="op">=</span> numbers[numbers<span class="op">.</span><span class="fu">size</span>() <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span>  <span class="co">// 5</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Mutable array (requires explicit initialization)</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> mutable <span class="op">:</span> [<span class="kw">var</span> Nat] <span class="op">=</span> [<span class="kw">var</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>mutable[<span class="dv">0</span>] <span class="op">:=</span> <span class="dv">10</span><span class="op">;</span>  <span class="co">// Now [10, 2, 3]</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Array initialization</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> zeros <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">init</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">100</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span>  <span class="co">// 100 zeros</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> indices <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">tabulate</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> <span class="fu">func</span>(i) <span class="op">=</span> i)<span class="op">;</span>  <span class="co">// [0,1,2,...,9]</span></span></code></pre></div>
<h4 id="tuples">Tuples</h4>
<p>Tuples are anonymous records with positional fields.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple tuple</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> coordinates <span class="op">:</span> (Float<span class="op">,</span> Float) <span class="op">=</span> (<span class="fl">10.5</span><span class="op">,</span> <span class="fl">20.3</span>)<span class="op">;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> person <span class="op">:</span> (<span class="bu">Text</span><span class="op">,</span> Nat) <span class="op">=</span> (<span class="st">&quot;Alice&quot;</span><span class="op">,</span> <span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Accessing tuple elements</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> x <span class="op">=</span> coordinates<span class="op">.</span><span class="dv">0</span><span class="op">;</span>  <span class="co">// 10.5</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> y <span class="op">=</span> coordinates<span class="op">.</span><span class="dv">1</span><span class="op">;</span>  <span class="co">// 20.3</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Pattern matching with tuples</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> (name<span class="op">,</span> age) <span class="op">=</span> person<span class="op">;</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Nested tuples</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> complex <span class="op">:</span> (Nat<span class="op">,</span> (<span class="bu">Text</span><span class="op">,</span> Bool)) <span class="op">=</span> (<span class="dv">42</span><span class="op">,</span> (<span class="st">&quot;active&quot;</span><span class="op">,</span> <span class="kw">true</span>))<span class="op">;</span></span></code></pre></div>
<h4 id="records">Records</h4>
<p>Records are structured types with named fields.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Type definition</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>type User <span class="op">=</span> {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">age</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating records</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> alice <span class="op">:</span> User <span class="op">=</span> {</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    age <span class="op">=</span> <span class="dv">30</span><span class="op">;</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    email <span class="op">=</span> <span class="st">&quot;alice@example.com&quot;</span><span class="op">;</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Accessing fields</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> userName <span class="op">=</span> alice<span class="op">.</span><span class="at">name</span><span class="op">;</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> userAge <span class="op">=</span> alice<span class="op">.</span><span class="at">age</span><span class="op">;</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Record with mutable fields</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>type Counter <span class="op">=</span> {</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">count</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> myCounter <span class="op">:</span> Counter <span class="op">=</span> {</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">&quot;Main Counter&quot;</span><span class="op">;</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>myCounter<span class="op">.</span><span class="at">count</span> <span class="op">:=</span> myCounter<span class="op">.</span><span class="at">count</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span></code></pre></div>
<h4 id="variants">Variants</h4>
<p>Variants are tagged unions (sum types), similar to enums in other
languages but more powerful.</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple variant (enum-like)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>type Color <span class="op">=</span> {</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    #Red<span class="op">;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    #Green<span class="op">;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    #Blue<span class="op">;</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> favorite <span class="op">:</span> Color <span class="op">=</span> #Blue<span class="op">;</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Variant with associated data</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>type Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Ok</span> <span class="op">:</span> T<span class="op">;</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Err</span> <span class="op">:</span> <span class="cn">E</span><span class="op">;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> success <span class="op">:</span> Result<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> <span class="op">=</span> #<span class="fu">Ok</span>(<span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> failure <span class="op">:</span> Result<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> <span class="op">=</span> #<span class="fu">Err</span>(<span class="st">&quot;Division by zero&quot;</span>)<span class="op">;</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Complex variant</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>type PaymentMethod <span class="op">=</span> {</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    #Cash<span class="op">;</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">CreditCard</span> <span class="op">:</span> { <span class="dt">number</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span> <span class="dt">cvv</span> <span class="op">:</span> Nat }<span class="op">;</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Crypto</span> <span class="op">:</span> { <span class="dt">wallet</span> <span class="op">:</span> Principal<span class="op">;</span> <span class="dt">amount</span> <span class="op">:</span> Nat }<span class="op">;</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> payment <span class="op">=</span> #<span class="fu">CreditCard</span>({</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    number <span class="op">=</span> <span class="st">&quot;1234-5678-9012-3456&quot;</span><span class="op">;</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    cvv <span class="op">=</span> <span class="dv">123</span><span class="op">;</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h4 id="options">Options</h4>
<p>The <code>Option</code> type represents values that may or may not
exist, eliminating null pointer errors.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Option type</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>type OptionalNat <span class="op">=</span> <span class="op">?</span>Nat<span class="op">;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> hasValue <span class="op">:</span> <span class="op">?</span>Nat <span class="op">=</span> <span class="op">?</span><span class="dv">42</span><span class="op">;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> noValue <span class="op">:</span> <span class="op">?</span>Nat <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Checking for values</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> (hasValue) {</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="kw">null</span> { Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;No value&quot;</span>)<span class="op">;</span> }<span class="op">;</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> (<span class="op">?</span>value) { Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Value: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(value))<span class="op">;</span> }<span class="op">;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Option in records</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>type User <span class="op">=</span> {</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">email</span> <span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">;</span>  <span class="co">// Optional email</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> bob <span class="op">=</span> { name <span class="op">=</span> <span class="st">&quot;Bob&quot;</span><span class="op">;</span> email <span class="op">=</span> <span class="kw">null</span> }<span class="op">;</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> alice <span class="op">=</span> { name <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span> email <span class="op">=</span> <span class="op">?</span><span class="st">&quot;alice@example.com&quot;</span> }<span class="op">;</span></span></code></pre></div>
<h3 id="function-types">2.3.3 Function Types</h3>
<p>Functions are first-class values with explicit types.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Function type signature</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>type MathOperation <span class="op">=</span> (Nat<span class="op">,</span> Nat) <span class="op">-&gt;</span> Nat<span class="op">;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Function implementation</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> add <span class="op">:</span> MathOperation <span class="op">=</span> <span class="fu">func</span>(a<span class="op">,</span> b) { a <span class="op">+</span> b }<span class="op">;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> multiply <span class="op">:</span> MathOperation <span class="op">=</span> <span class="fu">func</span>(a<span class="op">,</span> b) { a <span class="op">*</span> b }<span class="op">;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Higher-order functions</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>func <span class="fu">applyOperation</span>(op <span class="op">:</span> MathOperation<span class="op">,</span> x <span class="op">:</span> Nat<span class="op">,</span> y <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">op</span>(x<span class="op">,</span> y)<span class="op">;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> result <span class="op">=</span> <span class="fu">applyOperation</span>(add<span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span>  <span class="co">// 8</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Generic function types</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>type Transformer<span class="op">&lt;</span>A<span class="op">,</span> B<span class="op">&gt;</span> <span class="op">=</span> A <span class="op">-&gt;</span> B<span class="op">;</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> toString <span class="op">:</span> Transformer<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> <span class="op">=</span> Nat<span class="op">.</span><span class="at">toText</span><span class="op">;</span></span></code></pre></div>
<h3 id="async-types">2.3.4 Async Types</h3>
<p>Async types represent values that will be available in the future,
essential for inter-canister calls.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Async function</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">fetchData</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulated async operation</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Calling async functions</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">processData</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetchData</span>()<span class="op">;</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;Received: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(data)<span class="op">;</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="generic-types">2.3.5 Generic Types</h3>
<p>Generics enable code reuse while maintaining type safety.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Generic function</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>func identity<span class="op">&lt;</span>T<span class="op">&gt;</span>(x <span class="op">:</span> T) <span class="op">:</span> T {</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    x<span class="op">;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> num <span class="op">=</span> identity<span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> text <span class="op">=</span> identity<span class="op">&lt;</span><span class="bu">Text</span><span class="op">&gt;</span>(<span class="st">&quot;hello&quot;</span>)<span class="op">;</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Generic type</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>type Container<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">value</span> <span class="op">:</span> T<span class="op">;</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isEmpty</span> <span class="op">:</span> Bool<span class="op">;</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> numContainer <span class="op">:</span> Container<span class="op">&lt;</span>Nat<span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    value <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    isEmpty <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Generic with constraints</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>func compare<span class="op">&lt;</span>T<span class="op">&gt;</span>(a <span class="op">:</span> T<span class="op">,</span> b <span class="op">:</span> T<span class="op">,</span> eq <span class="op">:</span> (T<span class="op">,</span> T) <span class="op">-&gt;</span> Bool) <span class="op">:</span> Bool {</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">eq</span>(a<span class="op">,</span> b)<span class="op">;</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="declarations">2.4 Declarations</h2>
<p>Declarations introduce new names into scope. Motoko distinguishes
between immutable and mutable bindings.</p>
<h3 id="immutable-declarations-let">2.4.1 Immutable Declarations
(<code>let</code>)</h3>
<p>The default and recommended way to declare values.</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> name <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> age <span class="op">=</span> <span class="dv">30</span><span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> isActive <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Type inference</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> inferred <span class="op">=</span> <span class="dv">42</span><span class="op">;</span>  <span class="co">// Type: Nat</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Explicit type annotation</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> explicit <span class="op">:</span> Int <span class="op">=</span> <span class="op">-</span><span class="dv">42</span><span class="op">;</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple bindings (pattern matching)</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> (x<span class="op">,</span> y) <span class="op">=</span> (<span class="dv">10</span><span class="op">,</span> <span class="dv">20</span>)<span class="op">;</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> {name <span class="op">=</span> userName<span class="op">;</span> age <span class="op">=</span> userAge} <span class="op">=</span> {name <span class="op">=</span> <span class="st">&quot;Bob&quot;</span><span class="op">;</span> age <span class="op">=</span> <span class="dv">25</span>}<span class="op">;</span></span></code></pre></div>
<h3 id="mutable-declarations-var">2.4.2 Mutable Declarations
(<code>var</code>)</h3>
<p>Use <code>var</code> for values that need to change. Mutation uses
the <code>:=</code> operator.</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>counter <span class="op">:=</span> counter <span class="op">+</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">// 1</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>counter <span class="op">:=</span> counter <span class="op">*</span> <span class="dv">2</span><span class="op">;</span>  <span class="co">// 2</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Compound assignment</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>total <span class="op">+=</span> <span class="dv">50</span><span class="op">;</span>   <span class="co">// 150</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>total <span class="op">-=</span> <span class="dv">30</span><span class="op">;</span>   <span class="co">// 120</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>total <span class="op">*=</span> <span class="dv">2</span><span class="op">;</span>    <span class="co">// 240</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>total <span class="op">/=</span> <span class="dv">4</span><span class="op">;</span>    <span class="co">// 60</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Mutable in data structures</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>type Account <span class="op">=</span> {</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">owner</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> account <span class="op">=</span> {</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> balance <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    owner <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>account<span class="op">.</span><span class="at">balance</span> <span class="op">:=</span> account<span class="op">.</span><span class="at">balance</span> <span class="op">-</span> <span class="dv">100</span><span class="op">;</span></span></code></pre></div>
<h3 id="function-declarations">2.4.3 Function Declarations</h3>
<p>Functions can be declared in multiple ways.</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Named function (private by default)</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>func <span class="fu">add</span>(a <span class="op">:</span> Nat<span class="op">,</span> b <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Public function (within actor)</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">publicAdd</span>(a <span class="op">:</span> Nat<span class="op">,</span> b <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> (a <span class="op">+</span> b)<span class="op">;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Shared function (accessible from other canisters)</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">sharedAdd</span>(a <span class="op">:</span> Nat<span class="op">,</span> b <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Query function (fast, read-only)</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared query func <span class="fu">getBalance</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    balance<span class="op">;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Anonymous function (lambda)</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> multiply <span class="op">=</span> <span class="fu">func</span>(a <span class="op">:</span> Nat<span class="op">,</span> b <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>    a <span class="op">*</span> b<span class="op">;</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Function with generic parameters</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>func map<span class="op">&lt;</span>A<span class="op">,</span> B<span class="op">&gt;</span>(arr <span class="op">:</span> [A]<span class="op">,</span> f <span class="op">:</span> A <span class="op">-&gt;</span> B) <span class="op">:</span> [B] {</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Array</span><span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>A<span class="op">,</span> B<span class="op">&gt;</span>(arr<span class="op">,</span> f)<span class="op">;</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="type-declarations">2.4.4 Type Declarations</h3>
<p>Define custom types for better code organization.</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Type alias</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>type UserId <span class="op">=</span> Principal<span class="op">;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>type Balance <span class="op">=</span> Nat<span class="op">;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Record type</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>type Account <span class="op">=</span> {</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span> <span class="op">:</span> UserId<span class="op">;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">balance</span> <span class="op">:</span> Balance<span class="op">;</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isActive</span> <span class="op">:</span> Bool<span class="op">;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Variant type</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>type TransactionStatus <span class="op">=</span> {</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    #Pending<span class="op">;</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    #Completed<span class="op">;</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Failed</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Generic type</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>type Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Ok</span> <span class="op">:</span> T<span class="op">;</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Err</span> <span class="op">:</span> <span class="cn">E</span><span class="op">;</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="control-flow">2.5 Control Flow</h2>
<p>Motoko provides familiar control flow constructs, all designed as
expressions that return values.</p>
<h3 id="conditionals">2.5.1 Conditionals</h3>
<p>The <code>if-else</code> construct is an expression that must return
the same type from both branches.</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple conditional</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> status <span class="op">=</span> <span class="cf">if</span> (balance <span class="op">&gt;</span> <span class="dv">0</span>) <span class="st">&quot;Active&quot;</span> <span class="cf">else</span> <span class="st">&quot;Inactive&quot;</span><span class="op">;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Multi-line conditional</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> message <span class="op">=</span> <span class="cf">if</span> (age <span class="op">&lt;</span> <span class="dv">18</span>) {</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Minor&quot;</span><span class="op">;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (age <span class="op">&lt;</span> <span class="dv">65</span>) {</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Adult&quot;</span><span class="op">;</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Senior&quot;</span><span class="op">;</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Conditional with side effects</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (isValid) {</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">processData</span>()<span class="op">;</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logError</span>()<span class="op">;</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Nested conditionals</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> category <span class="op">=</span> <span class="cf">if</span> (score <span class="op">&gt;=</span> <span class="dv">90</span>) {</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Excellent&quot;</span><span class="op">;</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (score <span class="op">&gt;=</span> <span class="dv">75</span>) <span class="st">&quot;Good&quot;</span> <span class="cf">else</span> <span class="st">&quot;Needs Improvement&quot;</span><span class="op">;</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="loops">2.5.2 Loops</h3>
<p>Motoko supports several looping constructs for iteration.</p>
<h4 id="for-loops">For Loops</h4>
<p>Iterate over collections using iterators.</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Iter <span class="st">&quot;mo:base/Iter&quot;</span><span class="op">;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Iterate over array</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> numbers <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (num <span class="kw">in</span> numbers<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(Nat<span class="op">.</span><span class="fu">toText</span>(num))<span class="op">;</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Iterate with index</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ((index<span class="op">,</span> value) <span class="kw">in</span> numbers<span class="op">.</span><span class="fu">vals</span>() <span class="op">|&gt;</span> Iter<span class="op">.</span><span class="fu">enumerate</span>(_)) {</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(Nat<span class="op">.</span><span class="fu">toText</span>(index) # <span class="st">&quot;: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(value))<span class="op">;</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Iterate over range</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="kw">in</span> Iter<span class="op">.</span><span class="fu">range</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">9</span>)) {</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(Nat<span class="op">.</span><span class="fu">toText</span>(i))<span class="op">;</span>  <span class="co">// 0 to 9</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Iterate over text characters</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> text <span class="op">=</span> <span class="st">&quot;Hello&quot;</span><span class="op">;</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (char <span class="kw">in</span> text<span class="op">.</span><span class="fu">chars</span>()) {</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(Char<span class="op">.</span><span class="fu">toText</span>(char))<span class="op">;</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="while-loops">While Loops</h4>
<p>Execute code while a condition is true.</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (counter <span class="op">&lt;</span> <span class="dv">5</span>) {</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(Nat<span class="op">.</span><span class="fu">toText</span>(counter))<span class="op">;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    counter <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Infinite loop with break</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> running <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (running) {</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Do something</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shouldStop) {</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">running</span> <span class="op">:=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="loop-while">Loop-While</h4>
<p>Execute code at least once, then check condition.</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> attempts <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>loop {</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    attempts <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Attempt: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(attempts))<span class="op">;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">while</span> (attempts <span class="op">&lt;</span> <span class="dv">3</span>)<span class="op">;</span></span></code></pre></div>
<h4 id="loop-with-break-and-continue">Loop with Break and Continue</h4>
<div class="sourceCode" id="cb57"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Infinite loop with break</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>loop {</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (count <span class="op">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (count <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span><span class="op">;</span>  <span class="co">// Skip even numbers</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(Nat<span class="op">.</span><span class="fu">toText</span>(count))<span class="op">;</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="switch-and-pattern-matching">2.5.3 Switch and Pattern
Matching</h3>
<p>The <code>switch</code> statement provides exhaustive pattern
matching, ensuring all cases are handled.</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Basic switch on variant</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>type Status <span class="op">=</span> { #Active<span class="op">;</span> #Suspended<span class="op">;</span> #Closed }<span class="op">;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>func <span class="fu">describeStatus</span>(status <span class="op">:</span> Status) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (status) {</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#Active) <span class="st">&quot;Account is active&quot;</span><span class="op">;</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#Suspended) <span class="st">&quot;Account is suspended&quot;</span><span class="op">;</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#Closed) <span class="st">&quot;Account is closed&quot;</span><span class="op">;</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Switch with data extraction</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>type Result <span class="op">=</span> { #<span class="dt">Ok</span> <span class="op">:</span> Nat<span class="op">;</span> #<span class="dt">Err</span> <span class="op">:</span> <span class="bu">Text</span> }<span class="op">;</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>func <span class="fu">handleResult</span>(result <span class="op">:</span> Result) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (result) {</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Ok</span>(value)) <span class="st">&quot;Success: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(value)<span class="op">;</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Err</span>(message)) <span class="st">&quot;Error: &quot;</span> # message<span class="op">;</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Switch on Option</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>func <span class="fu">processOption</span>(opt <span class="op">:</span> <span class="op">?</span>Nat) <span class="op">:</span> Nat {</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (opt) {</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="kw">null</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="op">?</span>value) value <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Switch on tuples</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>func <span class="fu">describe</span>(point <span class="op">:</span> (Int<span class="op">,</span> Int)) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (point) {</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>) <span class="st">&quot;Origin&quot;</span><span class="op">;</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (x<span class="op">,</span> <span class="dv">0</span>) <span class="st">&quot;X-axis at &quot;</span> # Int<span class="op">.</span><span class="fu">toText</span>(x)<span class="op">;</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="dv">0</span><span class="op">,</span> y) <span class="st">&quot;Y-axis at &quot;</span> # Int<span class="op">.</span><span class="fu">toText</span>(y)<span class="op">;</span></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (x<span class="op">,</span> y) <span class="st">&quot;Point at (&quot;</span> # Int<span class="op">.</span><span class="fu">toText</span>(x) # <span class="st">&quot;, &quot;</span> # Int<span class="op">.</span><span class="fu">toText</span>(y) # <span class="st">&quot;)&quot;</span><span class="op">;</span></span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Complex pattern matching</span></span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>type Shape <span class="op">=</span> {</span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Circle</span> <span class="op">:</span> { <span class="dt">radius</span> <span class="op">:</span> Float }<span class="op">;</span></span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Rectangle</span> <span class="op">:</span> { <span class="dt">width</span> <span class="op">:</span> Float<span class="op">;</span> <span class="dt">height</span> <span class="op">:</span> Float }<span class="op">;</span></span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Triangle</span> <span class="op">:</span> { <span class="dt">base</span> <span class="op">:</span> Float<span class="op">;</span> <span class="dt">height</span> <span class="op">:</span> Float }<span class="op">;</span></span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>func <span class="fu">area</span>(shape <span class="op">:</span> Shape) <span class="op">:</span> Float {</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (shape) {</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Circle</span>({radius})) <span class="fl">3.14159</span> <span class="op">*</span> radius <span class="op">*</span> radius<span class="op">;</span></span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Rectangle</span>({width<span class="op">;</span> height})) width <span class="op">*</span> height<span class="op">;</span></span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Triangle</span>({base<span class="op">;</span> height})) <span class="fl">0.5</span> <span class="op">*</span> base <span class="op">*</span> height<span class="op">;</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="actors-and-async-data">2.6 Actors and Async Data</h2>
<p>Actors are the fundamental building blocks of Internet Computer
applications. They encapsulate state and provide asynchronous
message-passing interfaces.</p>
<h3 id="understanding-actors">2.6.1 Understanding Actors</h3>
<p>An actor in Motoko represents a <strong>canister</strong>—a smart
contract running on the Internet Computer. Each actor: - Has its own
isolated state - Communicates asynchronously with other actors -
Processes messages one at a time (no concurrency issues) - Can be
upgraded while preserving state</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple actor</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>actor Counter {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">count</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">increment</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="kw">get</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="public-and-private-functions">2.6.2 Public and Private
Functions</h3>
<div class="sourceCode" id="cb60"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>actor MyActor {</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">privateState</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Private function (not exposed)</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">privateHelper</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        n <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Public shared function (update call - goes through consensus)</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">updateState</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">privateState</span> <span class="op">:=</span> <span class="fu">privateHelper</span>(n)<span class="op">;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> privateState<span class="op">;</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Public query function (read-only - fast, no consensus)</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getState</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> privateState<span class="op">;</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>Key Differences</strong>: - <strong>Update calls</strong>
(<code>public shared func</code>): Modify state, go through consensus,
take ~2 seconds - <strong>Query calls</strong>
(<code>public query func</code>): Read-only, do not modify state, return
in milliseconds - <strong>Private functions</strong>
(<code>func</code>): Only callable within the actor, synchronous</p>
<h3 id="async-and-await">2.6.3 Async and Await</h3>
<p>All inter-actor communication is asynchronous. Use <code>await</code>
to wait for async results.</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>actor AsyncExample {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call another actor</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">callOtherActor</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> otherActor <span class="op">=</span> <span class="fu">actor</span>(<span class="st">&quot;canister-id&quot;</span>) <span class="op">:</span> actor {</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">getValue</span> <span class="op">:</span> () <span class="op">-&gt;</span> <span class="kw">async</span> Nat<span class="op">;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> otherActor<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Multiple async calls</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">multipleCallsSequential</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> actor1 <span class="op">=</span> <span class="fu">actor</span>(<span class="st">&quot;id-1&quot;</span>) <span class="op">:</span> actor { <span class="kw">get</span> <span class="op">:</span> () <span class="op">-&gt;</span> <span class="kw">async</span> Nat }<span class="op">;</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> actor2 <span class="op">=</span> <span class="fu">actor</span>(<span class="st">&quot;id-2&quot;</span>) <span class="op">:</span> actor { <span class="kw">get</span> <span class="op">:</span> () <span class="op">-&gt;</span> <span class="kw">async</span> Nat }<span class="op">;</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> val1 <span class="op">=</span> <span class="cf">await</span> actor1<span class="op">.</span><span class="fu">get</span>()<span class="op">;</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> val2 <span class="op">=</span> <span class="cf">await</span> actor2<span class="op">.</span><span class="fu">get</span>()<span class="op">;</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> val1 <span class="op">+</span> val2<span class="op">;</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Error handling with async</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">safeCall</span>() <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>Nat {</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> other <span class="op">=</span> <span class="fu">actor</span>(<span class="st">&quot;id&quot;</span>) <span class="op">:</span> actor { <span class="kw">get</span> <span class="op">:</span> () <span class="op">-&gt;</span> <span class="kw">async</span> Nat }<span class="op">;</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> other<span class="op">.</span><span class="fu">get</span>()<span class="op">;</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="op">?</span>result<span class="op">;</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="actor-classes">2.6.4 Actor Classes</h3>
<p>Actor classes are templates for creating multiple actor
instances.</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Actor class definition</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>actor <span class="kw">class</span> <span class="fu">Counter</span>(initValue <span class="op">:</span> Nat) {</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> count <span class="op">=</span> initValue<span class="op">;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">increment</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="kw">get</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> count<span class="op">;</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage (in a management canister)</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Counter <span class="st">&quot;counter&quot;</span><span class="op">;</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>actor Manager {</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">createCounter</span>(<span class="dt">init</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Principal {</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> newCounter <span class="op">=</span> <span class="cf">await</span> Counter<span class="op">.</span><span class="fu">Counter</span>(init)<span class="op">;</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Principal<span class="op">.</span><span class="fu">fromActor</span>(newCounter)<span class="op">;</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="caller-identity">2.6.5 Caller Identity</h3>
<p>Access the caller’s principal in shared functions.</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>actor Auth {</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">owner</span> <span class="op">:</span> Principal <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;aaaaa-aa&quot;</span>)<span class="op">;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">setOwner</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">owner</span> <span class="op">:=</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">restrictedAction</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (msg<span class="op">.</span><span class="at">caller</span> <span class="op">==</span> owner) {</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;Access granted&quot;</span><span class="op">;</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;Access denied&quot;</span><span class="op">;</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared <span class="fu">query</span>(msg) func <span class="fu">whoAmI</span>() <span class="op">:</span> <span class="kw">async</span> Principal {</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="mutable-state">2.7 Mutable State</h2>
<p>Managing mutable state is crucial for building stateful applications.
Motoko provides clear semantics for mutation.</p>
<h3 id="mutable-variables">2.7.1 Mutable Variables</h3>
<div class="sourceCode" id="cb64"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>actor StateExample {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mutable scalar</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">counter</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;Default&quot;</span><span class="op">;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">isActive</span> <span class="op">:</span> Bool <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mutable in records</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    type Account <span class="op">=</span> {</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">owner</span> <span class="op">:</span> Principal<span class="op">;</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">account</span> <span class="op">:</span> Account <span class="op">=</span> {</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> balance <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>        owner <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;aaaaa-aa&quot;</span>)<span class="op">;</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">updateBalance</span>(<span class="dt">amount</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        account<span class="op">.</span><span class="at">balance</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mutable arrays</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">items</span> <span class="op">:</span> [<span class="kw">var</span> Nat] <span class="op">=</span> [<span class="kw">var</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">updateItem</span>(<span class="dt">index</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">value</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>        items[index] <span class="op">:=</span> value<span class="op">;</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="mutable-collections">2.7.2 Mutable Collections</h3>
<p>Use specialized data structures for efficient mutable
collections.</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Hash <span class="st">&quot;mo:base/Hash&quot;</span><span class="op">;</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Nat <span class="st">&quot;mo:base/Nat&quot;</span><span class="op">;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>actor Collections {</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dynamic array (Buffer)</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> buffer <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addItem</span>(<span class="dt">item</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span><span class="fu">add</span>(item)<span class="op">;</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getSize</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// HashMap (mutable key-value store)</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> map <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> Nat<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Hash<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">putValue</span>(<span class="dt">key</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">value</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getValue</span>(<span class="dt">key</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span><span class="bu">Text</span> {</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">get</span>(key)<span class="op">;</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="state-transitions">2.7.3 State Transitions</h3>
<p>Pattern for safe state transitions.</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>actor StateMachine {</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    type State <span class="op">=</span> {</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>        #Idle<span class="op">;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>        #Processing<span class="op">;</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>        #Complete<span class="op">;</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>        #<span class="dt">Failed</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">currentState</span> <span class="op">:</span> State <span class="op">=</span> #Idle<span class="op">;</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">startProcessing</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (currentState) {</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#Idle) {</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>                <span class="dt">currentState</span> <span class="op">:=</span> #Processing<span class="op">;</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">ok</span>(())<span class="op">;</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (_) {</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">err</span>(<span class="st">&quot;Cannot start: not in idle state&quot;</span>)<span class="op">;</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">completeProcessing</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (currentState) {</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#Processing) {</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>                <span class="dt">currentState</span> <span class="op">:=</span> #Complete<span class="op">;</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">ok</span>(())<span class="op">;</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (_) {</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">err</span>(<span class="st">&quot;Cannot complete: not processing&quot;</span>)<span class="op">;</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getState</span>() <span class="op">:</span> <span class="kw">async</span> State {</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>        currentState<span class="op">;</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="messaging">2.8 Messaging</h2>
<p>Messaging is how actors communicate. Understanding message types and
patterns is essential for building robust applications.</p>
<h3 id="update-vs-query-messages">2.8.1 Update vs Query Messages</h3>
<div class="sourceCode" id="cb67"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>actor Messaging {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">data</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update message: modifies state, goes through consensus (~2s)</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">update</span>(<span class="dt">value</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span> <span class="op">:=</span> value<span class="op">;</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Query message: read-only, fast (~100ms)</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared query func <span class="fu">query</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>        data<span class="op">;</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Composite query (calling other queries)</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared composite query func <span class="fu">compositeQuery</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Can call other query functions</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> <span class="fu">query</span>()<span class="op">;</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>        result <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="one-way-messages">2.8.2 One-way Messages</h3>
<p>Use one-way messages when you don’t need a response.</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>actor Logger {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">logs</span> <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// One-way message (fire and forget)</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">log</span>(<span class="dt">message</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// No return value needed</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">logs</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(logs<span class="op">,</span> [message])<span class="op">;</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="inter-canister-calls">2.8.3 Inter-Canister Calls</h3>
<div class="sourceCode" id="cb69"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>actor Caller {</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define remote actor interface</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    type RemoteActor <span class="op">=</span> actor {</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">getData</span> <span class="op">:</span> () <span class="op">-&gt;</span> <span class="kw">async</span> Nat<span class="op">;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">setData</span> <span class="op">:</span> (Nat) <span class="op">-&gt;</span> <span class="kw">async</span> ()<span class="op">;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">callRemote</span>(<span class="dt">canisterId</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">remote</span> <span class="op">:</span> RemoteActor <span class="op">=</span> <span class="fu">actor</span>(canisterId)<span class="op">;</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Call remote function</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> currentValue <span class="op">=</span> <span class="cf">await</span> remote<span class="op">.</span><span class="fu">getData</span>()<span class="op">;</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update remote state</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> remote<span class="op">.</span><span class="fu">setData</span>(currentValue <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> currentValue <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="error-handling-in-messages">2.8.4 Error Handling in
Messages</h3>
<div class="sourceCode" id="cb70"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>actor ErrorHandling {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">riskyOperation</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> remote <span class="op">=</span> <span class="fu">actor</span>(<span class="st">&quot;unknown-id&quot;</span>) <span class="op">:</span> actor {</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>                <span class="dt">compute</span> <span class="op">:</span> () <span class="op">-&gt;</span> <span class="kw">async</span> Nat<span class="op">;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> remote<span class="op">.</span><span class="fu">compute</span>()<span class="op">;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">ok</span>(result)<span class="op">;</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">err</span>(<span class="st">&quot;Failed to call remote: &quot;</span> # <span class="bu">Error</span><span class="op">.</span><span class="fu">message</span>(e))<span class="op">;</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="modules-and-imports">2.9 Modules and Imports</h2>
<p>Modules organize code into reusable, composable units. Motoko
supports both local modules and package imports.</p>
<h3 id="defining-modules">2.9.1 Defining Modules</h3>
<div class="sourceCode" id="cb71"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">// MathUtils.mo</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>module {</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">add</span>(<span class="dt">a</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span> <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        a <span class="op">+</span> b<span class="op">;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">multiply</span>(<span class="dt">a</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span> <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        a <span class="op">*</span> b<span class="op">;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">square</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">multiply</span>(n<span class="op">,</span> n)<span class="op">;</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="importing-local-modules">2.9.2 Importing Local Modules</h3>
<div class="sourceCode" id="cb72"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Main.mo</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> MathUtils <span class="st">&quot;./MathUtils&quot;</span><span class="op">;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">calculate</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> sum <span class="op">=</span> MathUtils<span class="op">.</span><span class="fu">add</span>(<span class="dv">5</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> product <span class="op">=</span> MathUtils<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span><span class="op">,</span> <span class="dv">7</span>)<span class="op">;</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sum <span class="op">+</span> product<span class="op">;</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="importing-from-base-library">2.9.3 Importing from Base
Library</h3>
<p>The Motoko base library provides essential utilities.</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Nat <span class="st">&quot;mo:base/Nat&quot;</span><span class="op">;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Iter <span class="st">&quot;mo:base/Iter&quot;</span><span class="op">;</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Result <span class="st">&quot;mo:base/Result&quot;</span><span class="op">;</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Option <span class="st">&quot;mo:base/Option&quot;</span><span class="op">;</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>actor Example {</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">demonstrateBase</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Array operations</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> numbers <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">;</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> doubled <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>Nat<span class="op">,</span> Nat<span class="op">&gt;</span>(numbers<span class="op">,</span> <span class="fu">func</span>(n) <span class="op">=</span> n <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Text operations</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> upper <span class="op">=</span> <span class="bu">Text</span><span class="op">.</span><span class="fu">toUppercase</span>(<span class="st">&quot;hello&quot;</span>)<span class="op">;</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Iteration</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (n <span class="kw">in</span> Iter<span class="op">.</span><span class="fu">range</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">9</span>)) {</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">print</span>(Nat<span class="op">.</span><span class="fu">toText</span>(n))<span class="op">;</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="module-patterns">2.9.4 Module Patterns</h3>
<div class="sourceCode" id="cb74"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Nested modules</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>module OuterModule {</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> module InnerModule {</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> func <span class="fu">helper</span>() <span class="op">:</span> Nat { <span class="dv">42</span> }<span class="op">;</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">useInner</span>() <span class="op">:</span> Nat {</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        InnerModule<span class="op">.</span><span class="fu">helper</span>() <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Module with private state</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>module Counter {</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">count</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">increment</span>() <span class="op">:</span> Nat {</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>        count<span class="op">;</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="kw">get</span>() <span class="op">:</span> Nat {</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>        count<span class="op">;</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Importing specific items</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { map<span class="op">;</span> filter } <span class="op">=</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span></code></pre></div>
<h2 id="pattern-matching">2.10 Pattern Matching</h2>
<p>Pattern matching is one of Motoko’s most powerful features, enabling
elegant and safe data destructuring.</p>
<h3 id="basic-patterns">2.10.1 Basic Patterns</h3>
<div class="sourceCode" id="cb75"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Literal patterns</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>func <span class="fu">isZero</span>(n <span class="op">:</span> Nat) <span class="op">:</span> Bool {</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (n) {</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="dv">0</span>) <span class="kw">true</span><span class="op">;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (_) <span class="kw">false</span><span class="op">;</span>  <span class="co">// wildcard</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Variable binding</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>func <span class="fu">describe</span>(opt <span class="op">:</span> <span class="op">?</span>Nat) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (opt) {</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="kw">null</span> <span class="st">&quot;No value&quot;</span><span class="op">;</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="op">?</span>n) <span class="st">&quot;Value: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(n)<span class="op">;</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="tuple-patterns">2.10.2 Tuple Patterns</h3>
<div class="sourceCode" id="cb76"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>func <span class="fu">swapIfNeeded</span>(pair <span class="op">:</span> (Nat<span class="op">,</span> Nat)) <span class="op">:</span> (Nat<span class="op">,</span> Nat) {</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (pair) {</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ((a<span class="op">,</span> b)) <span class="cf">if</span> (a <span class="op">&gt;</span> b) (b<span class="op">,</span> a)<span class="op">;</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ((a<span class="op">,</span> b)) (a<span class="op">,</span> b)<span class="op">;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Nested tuples</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>func <span class="fu">processNested</span>(data <span class="op">:</span> (Nat<span class="op">,</span> (<span class="bu">Text</span><span class="op">,</span> Bool))) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (data) {</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ((n<span class="op">,</span> (s<span class="op">,</span> <span class="kw">true</span>))) <span class="st">&quot;Active: &quot;</span> # s # <span class="st">&quot; = &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(n)<span class="op">;</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ((n<span class="op">,</span> (s<span class="op">,</span> <span class="kw">false</span>))) <span class="st">&quot;Inactive: &quot;</span> # s<span class="op">;</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="record-patterns">2.10.3 Record Patterns</h3>
<div class="sourceCode" id="cb77"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>type User <span class="op">=</span> {</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">age</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isAdmin</span> <span class="op">:</span> Bool<span class="op">;</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>func <span class="fu">greetUser</span>(user <span class="op">:</span> User) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (user) {</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ({ name<span class="op">;</span> isAdmin <span class="op">=</span> <span class="kw">true</span> }) <span class="st">&quot;Hello, Admin &quot;</span> # name<span class="op">;</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ({ name<span class="op">;</span> age }) <span class="cf">if</span> (age <span class="op">&lt;</span> <span class="dv">18</span>) <span class="st">&quot;Hello, young &quot;</span> # name<span class="op">;</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ({ name }) <span class="st">&quot;Hello, &quot;</span> # name<span class="op">;</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Partial record matching</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>func <span class="fu">getUsername</span>(user <span class="op">:</span> User) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> { name } <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    name<span class="op">;</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="variant-patterns">2.10.4 Variant Patterns</h3>
<div class="sourceCode" id="cb78"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>type Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Ok</span> <span class="op">:</span> T<span class="op">;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Err</span> <span class="op">:</span> <span class="cn">E</span><span class="op">;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>func unwrapOr<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span>(result <span class="op">:</span> Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;,</span> <span class="im">default</span> <span class="op">:</span> T) <span class="op">:</span> T {</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (result) {</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Ok</span>(value)) value<span class="op">;</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Err</span>(_)) <span class="im">default</span><span class="op">;</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Nested variant matching</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>type Payment <span class="op">=</span> {</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Cash</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Card</span> <span class="op">:</span> { <span class="dt">number</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span> <span class="dt">amount</span> <span class="op">:</span> Nat }<span class="op">;</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    #<span class="dt">Crypto</span> <span class="op">:</span> { <span class="dt">token</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span> <span class="dt">amount</span> <span class="op">:</span> Nat }<span class="op">;</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>func <span class="fu">processPayment</span>(payment <span class="op">:</span> Payment) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (payment) {</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Cash</span>(amount)) <span class="st">&quot;Cash: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(amount)<span class="op">;</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Card</span>({ amount })) <span class="st">&quot;Card: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(amount)<span class="op">;</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Crypto</span>({ token<span class="op">;</span> amount })) token # <span class="st">&quot;: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(amount)<span class="op">;</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="array-patterns">2.10.5 Array Patterns</h3>
<div class="sourceCode" id="cb79"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>func <span class="fu">describeList</span>(list <span class="op">:</span> [Nat]) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (list<span class="op">.</span><span class="fu">size</span>()) {</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="dv">0</span>) <span class="st">&quot;Empty list&quot;</span><span class="op">;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="dv">1</span>) <span class="st">&quot;Single element: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(list[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (_) <span class="st">&quot;Multiple elements, first: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(list[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="guards">2.10.6 Guards</h3>
<p>Use guards (<code>if</code>) for additional conditions.</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>func <span class="fu">categorize</span>(n <span class="op">:</span> Int) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (n) {</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (x) <span class="cf">if</span> (x <span class="op">&lt;</span> <span class="dv">0</span>) <span class="st">&quot;Negative&quot;</span><span class="op">;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="dv">0</span>) <span class="st">&quot;Zero&quot;</span><span class="op">;</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (x) <span class="cf">if</span> (x <span class="op">&gt;</span> <span class="dv">0</span> and x <span class="op">&lt;=</span> <span class="dv">10</span>) <span class="st">&quot;Small positive&quot;</span><span class="op">;</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (_) <span class="st">&quot;Large positive&quot;</span><span class="op">;</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>type Account <span class="op">=</span> {</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">isVIP</span> <span class="op">:</span> Bool<span class="op">;</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>func <span class="fu">checkWithdrawal</span>(account <span class="op">:</span> Account<span class="op">,</span> amount <span class="op">:</span> Nat) <span class="op">:</span> Bool {</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (account) {</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ({ balance<span class="op">;</span> isVIP <span class="op">=</span> <span class="kw">true</span> }) <span class="cf">if</span> (balance <span class="op">&gt;=</span> amount) <span class="kw">true</span><span class="op">;</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> ({ balance<span class="op">;</span> isVIP <span class="op">=</span> <span class="kw">false</span> }) <span class="cf">if</span> (balance <span class="op">&gt;=</span> amount <span class="op">+</span> <span class="dv">10</span>) <span class="kw">true</span><span class="op">;</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (_) <span class="kw">false</span><span class="op">;</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="error-handling">2.11 Error Handling</h2>
<p>Robust error handling is critical for production applications. Motoko
provides multiple mechanisms for dealing with errors.</p>
<h3 id="try-catch">2.11.1 Try-Catch</h3>
<p>Handle runtime errors with try-catch blocks.</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Error</span> <span class="st">&quot;mo:base/Error&quot;</span><span class="op">;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>actor ErrorHandling {</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">divide</span>(<span class="dt">a</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (b <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;Division by zero&quot;</span>)<span class="op">;</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">ok</span>(a <span class="op">/</span> b)<span class="op">;</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">err</span>(<span class="bu">Error</span><span class="op">.</span><span class="fu">message</span>(e))<span class="op">;</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">multipleOperations</span>() <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>Nat {</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> step1 <span class="op">=</span> <span class="cf">await</span> <span class="fu">remoteCall1</span>()<span class="op">;</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> step2 <span class="op">=</span> <span class="cf">await</span> <span class="fu">remoteCall2</span>(step1)<span class="op">;</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> step3 <span class="op">=</span> <span class="cf">await</span> <span class="fu">remoteCall3</span>(step2)<span class="op">;</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">?</span>step3<span class="op">;</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Error: &quot;</span> # <span class="bu">Error</span><span class="op">.</span><span class="fu">message</span>(e))<span class="op">;</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">null</span><span class="op">;</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Helper functions (example)</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">remoteCall1</span>() <span class="op">:</span> <span class="kw">async</span> Nat { <span class="dv">10</span> }<span class="op">;</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">remoteCall2</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat { n <span class="op">*</span> <span class="dv">2</span> }<span class="op">;</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">remoteCall3</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat { n <span class="op">+</span> <span class="dv">5</span> }<span class="op">;</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="result-type">2.11.2 Result Type</h3>
<p>Use the <code>Result</code> type for explicit error handling.</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Result <span class="st">&quot;mo:base/Result&quot;</span><span class="op">;</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>type Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span> <span class="op">=</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>actor ResultExample {</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    type <span class="bu">Error</span> <span class="op">=</span> {</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>        #NotFound<span class="op">;</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        #<span class="dt">InvalidInput</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        #Unauthorized<span class="op">;</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">validateInput</span>(<span class="dt">input</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> Result<span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (input<span class="op">.</span><span class="fu">size</span>() <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #<span class="fu">err</span>(#<span class="fu">InvalidInput</span>(<span class="st">&quot;Empty input&quot;</span>))<span class="op">;</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (input<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> <span class="dv">100</span>) {</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #<span class="fu">err</span>(#<span class="fu">InvalidInput</span>(<span class="st">&quot;Input too long&quot;</span>))<span class="op">;</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>(input)<span class="op">;</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">findUser</span>(<span class="dt">id</span> <span class="op">:</span> Nat) <span class="op">:</span> Result<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulated lookup</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (id <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">err</span>(#NotFound)<span class="op">;</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">ok</span>({ name <span class="op">=</span> <span class="st">&quot;User &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(id)<span class="op">;</span> age <span class="op">=</span> <span class="dv">25</span> })<span class="op">;</span></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">processUser</span>(<span class="dt">id</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">input</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (<span class="fu">validateInput</span>(input)) {</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">err</span>(e)) #<span class="fu">err</span>(e)<span class="op">;</span></span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">ok</span>(validInput)) {</span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">switch</span> (<span class="fu">findUser</span>(id)) {</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">case</span> (#<span class="fu">err</span>(e)) #<span class="fu">err</span>(e)<span class="op">;</span></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">case</span> (#<span class="fu">ok</span>(user)) {</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>                        #<span class="fu">ok</span>(<span class="st">&quot;Processed &quot;</span> # validInput # <span class="st">&quot; for &quot;</span> # user<span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>                    }<span class="op">;</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="option-type">2.11.3 Option Type</h3>
<p>Use <code>Option</code> for operations that may not return a
value.</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Option <span class="st">&quot;mo:base/Option&quot;</span><span class="op">;</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>actor OptionExample {</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">safeDivide</span>(<span class="dt">a</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="op">?</span>Nat {</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (b <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">null</span><span class="op">;</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">?</span>(a <span class="op">/</span> b)<span class="op">;</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">calculate</span>(<span class="dt">a</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (<span class="fu">safeDivide</span>(a<span class="op">,</span> b)) {</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Default value</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>result) result<span class="op">;</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Option utilities</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">demonstrateOption</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">maybeValue</span> <span class="op">:</span> <span class="op">?</span>Nat <span class="op">=</span> <span class="op">?</span><span class="dv">42</span><span class="op">;</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if value exists</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> exists <span class="op">=</span> Option<span class="op">.</span><span class="fu">isSome</span>(maybeValue)<span class="op">;</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get value or default</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> value <span class="op">=</span> Option<span class="op">.</span><span class="fu">get</span>(maybeValue<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Map over option</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> doubled <span class="op">=</span> Option<span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>Nat<span class="op">,</span> Nat<span class="op">&gt;</span>(maybeValue<span class="op">,</span> <span class="fu">func</span>(n) <span class="op">=</span> n <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Chain operations</span></span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> Option<span class="op">.</span><span class="at">chain</span><span class="op">&lt;</span>Nat<span class="op">,</span> Nat<span class="op">&gt;</span>(</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>            maybeValue<span class="op">,</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">func</span>(n) <span class="op">=</span> <span class="cf">if</span> (n <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">?</span>n <span class="cf">else</span> <span class="kw">null</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="assert-and-debug">2.11.4 Assert and Debug</h3>
<p>Use assertions for development and invariant checking.</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>actor Assertions {</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">criticalOperation</span>(<span class="dt">value</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert preconditions</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>        assert value <span class="op">&gt;</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>        assert value <span class="op">&lt;</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform operation</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> value <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Assert postconditions</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>        assert result <span class="op">&gt;</span> value<span class="op">;</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Operation successful: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(result))<span class="op">;</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">debugExample</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Starting operation&quot;</span>)<span class="op">;</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> x <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;x = &quot;</span> # <span class="fu">debug_show</span>(x))<span class="op">;</span></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> record <span class="op">=</span> { name <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span> age <span class="op">=</span> <span class="dv">30</span> }<span class="op">;</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;record = &quot;</span> # <span class="fu">debug_show</span>(record))<span class="op">;</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="error-propagation">2.11.5 Error Propagation</h3>
<p>Chain error-prone operations cleanly.</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>actor ErrorPropagation {</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    type <span class="bu">Error</span> <span class="op">=</span> { #DatabaseError<span class="op">;</span> #NetworkError<span class="op">;</span> #ValidationError }<span class="op">;</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">step1</span>() <span class="op">:</span> Result<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulated operation</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">step2</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> Result<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (n <span class="op">&gt;</span> <span class="dv">5</span>) #<span class="fu">ok</span>(n <span class="op">*</span> <span class="dv">2</span>) <span class="cf">else</span> #<span class="fu">err</span>(#ValidationError)<span class="op">;</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">step3</span>(<span class="dt">n</span> <span class="op">:</span> Nat) <span class="op">:</span> Result<span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>(<span class="st">&quot;Final: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(n))<span class="op">;</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">pipeline</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Manual error propagation</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (<span class="fu">step1</span>()) {</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">err</span>(e)) #<span class="fu">err</span>(e)<span class="op">;</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">ok</span>(v1)) {</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">switch</span> (<span class="fu">step2</span>(v1)) {</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">case</span> (#<span class="fu">err</span>(e)) #<span class="fu">err</span>(e)<span class="op">;</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">case</span> (#<span class="fu">ok</span>(v2)) {</span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">step3</span>(v2)<span class="op">;</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>                    }<span class="op">;</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Helper for cleaner propagation</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>    func andThen<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span>(</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">result</span> <span class="op">:</span> Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;,</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">f</span> <span class="op">:</span> T <span class="op">-&gt;</span> Result<span class="op">&lt;</span>U<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span></span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">:</span> Result<span class="op">&lt;</span>U<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span> {</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (result) {</span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">err</span>(e)) #<span class="fu">err</span>(e)<span class="op">;</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">ok</span>(value)) <span class="fu">f</span>(value)<span class="op">;</span></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">pipelineClean</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> {</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">step1</span>()</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">|&gt;</span> <span class="fu">andThen</span>(_<span class="op">,</span> step2)</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">|&gt;</span> <span class="fu">andThen</span>(_<span class="op">,</span> step3)<span class="op">;</span></span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="data-persistence">2.12 Data Persistence</h2>
<p>Unlike traditional smart contracts, Motoko provides
<strong>orthogonal persistence</strong>—your data automatically persists
across upgrades without explicit serialization.</p>
<h3 id="stable-variables">2.12.1 Stable Variables</h3>
<p>Mark variables as <code>stable</code> to persist them across canister
upgrades.</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>actor PersistentCounter {</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">count</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users</span> <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">lastUpdate</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">increment</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">lastUpdate</span> <span class="op">:=</span> count<span class="op">;</span>  <span class="co">// Simplified timestamp</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        count<span class="op">;</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addUser</span>(<span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">users</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(users<span class="op">,</span> [name])<span class="op">;</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getStats</span>() <span class="op">:</span> <span class="kw">async</span> (Nat<span class="op">,</span> Nat<span class="op">,</span> Nat) {</span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        (count<span class="op">,</span> users<span class="op">.</span><span class="fu">size</span>()<span class="op">,</span> lastUpdate)<span class="op">;</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="stable-types">2.12.2 Stable Types</h3>
<p>Only certain types can be marked as stable:</p>
<ul>
<li><p>✅ Primitive types: <code>Nat</code>, <code>Int</code>,
<code>Bool</code>, <code>Text</code>, <code>Principal</code>,
<code>Blob</code></p></li>
<li><p>✅ Immutable arrays: <code>[T]</code> where <code>T</code> is
stable</p></li>
<li><p>✅ Tuples of stable types</p></li>
<li><p>✅ Records of stable types</p></li>
<li><p>✅ Variants of stable types</p></li>
<li><p>✅ Options of stable types</p></li>
<li><p>❌ Mutable arrays: <code>[var T]</code></p></li>
<li><p>❌ Functions</p></li>
<li><p>❌ Objects with methods</p></li>
</ul>
<div class="sourceCode" id="cb87"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>actor StableTypes {</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    type StableUser <span class="op">=</span> {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">registered</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    type StableRecord <span class="op">=</span> {</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>        #<span class="dt">Active</span> <span class="op">:</span> StableUser<span class="op">;</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>        #<span class="dt">Suspended</span> <span class="op">:</span> { <span class="dt">reason</span> <span class="op">:</span> <span class="bu">Text</span> }<span class="op">;</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users</span> <span class="op">:</span> [StableUser] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">records</span> <span class="op">:</span> [StableRecord] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This won&#39;t work - mutable array</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// stable var mutableArray : [var Nat] = [var 1, 2, 3];</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This won&#39;t work - HashMap is not stable</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// import HashMap &quot;mo:base/HashMap&quot;;</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// stable var map = HashMap.HashMap&lt;Nat, Text&gt;(10, Nat.equal, Hash.hash);</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="upgrade-hooks">2.12.3 Upgrade Hooks</h3>
<p>Use <code>preupgrade</code> and <code>postupgrade</code> hooks for
complex state migration.</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>actor UpgradeExample {</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Non-stable runtime state</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> runtimeCache <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> Nat<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Hash<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> buffer <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stable storage</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">stableData</span> <span class="op">:</span> [(Nat<span class="op">,</span> <span class="bu">Text</span>)] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">stableArray</span> <span class="op">:</span> [Nat] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Before upgrade: save state</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">preupgrade</span>() {</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert HashMap to stable array</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stableData</span> <span class="op">:=</span> Iter<span class="op">.</span><span class="fu">toArray</span>(runtimeCache<span class="op">.</span><span class="fu">entries</span>())<span class="op">;</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert Buffer to stable array</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stableArray</span> <span class="op">:=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">toArray</span>(buffer)<span class="op">;</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Preupgrade: saved &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(stableData<span class="op">.</span><span class="fu">size</span>()) # <span class="st">&quot; entries&quot;</span>)<span class="op">;</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// After upgrade: restore state</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Restore HashMap from stable array</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ((key<span class="op">,</span> value) <span class="kw">in</span> stableData<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>            runtimeCache<span class="op">.</span><span class="fu">put</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Restore Buffer from stable array</span></span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (item <span class="kw">in</span> stableArray<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>            buffer<span class="op">.</span><span class="fu">add</span>(item)<span class="op">;</span></span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear stable storage to save memory</span></span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stableData</span> <span class="op">:=</span> []<span class="op">;</span></span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stableArray</span> <span class="op">:=</span> []<span class="op">;</span></span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Postupgrade: restored cache and buffer&quot;</span>)<span class="op">;</span></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addEntry</span>(<span class="dt">key</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">value</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>        runtimeCache<span class="op">.</span><span class="fu">put</span>(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span><span class="fu">add</span>(key)<span class="op">;</span></span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="migration-patterns">2.12.4 Migration Patterns</h3>
<p>Handle schema changes gracefully during upgrades.</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>actor VersionedStorage {</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Version 1 schema</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    type UserV1 <span class="op">=</span> {</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Version 2 schema (added email field)</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    type UserV2 <span class="op">=</span> {</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">email</span> <span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">;</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">version</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">usersV2</span> <span class="op">:</span> [UserV2] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Migration from V1 to V2</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (version <span class="op">==</span> <span class="dv">1</span>) {</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Migrate V1 users to V2 format</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// usersV2 := Array.map(usersV1, func(u : UserV1) : UserV2 {</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">//     { name = u.name; balance = u.balance; email = null }</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// });</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">version</span> <span class="op">:=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Migrated from V1 to V2&quot;</span>)<span class="op">;</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="garbage-collection">2.13 Garbage Collection</h2>
<p>Motoko features automatic memory management with incremental garbage
collection. Understanding GC behavior helps optimize performance.</p>
<h3 id="memory-management">2.13.1 Memory Management</h3>
<p>Motoko’s garbage collector runs incrementally during message
execution: - <strong>Automatic</strong>: No manual memory management
needed - <strong>Incremental</strong>: Spreads GC work across multiple
messages - <strong>Generational</strong>: Optimizes for short-lived
objects - <strong>Compacting</strong>: Reduces fragmentation</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>actor GCExample {</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Short-lived objects (collected quickly)</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">processData</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> temp1 <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">init</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">1000</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> temp2 <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">tabulate</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">1000</span><span class="op">,</span> <span class="fu">func</span>(i) <span class="op">=</span> i)<span class="op">;</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// temp1 and temp2 become garbage when function returns</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        temp2[<span class="dv">500</span>]<span class="op">;</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Long-lived objects (stay in memory)</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">persistentData</span> <span class="op">:</span> [Nat] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">storeData</span>(<span class="dt">items</span> <span class="op">:</span> [Nat]) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">persistentData</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(persistentData<span class="op">,</span> items)<span class="op">;</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// persistentData survives across calls</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="memory-optimization">2.13.2 Memory Optimization</h3>
<p>Best practices for memory efficiency:</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>actor Optimized {</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad: Creates many intermediate arrays</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">inefficientProcessing</span>(<span class="dt">data</span> <span class="op">:</span> [Nat]) <span class="op">:</span> [Nat] {</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> step1 <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>Nat<span class="op">,</span> Nat<span class="op">&gt;</span>(data<span class="op">,</span> <span class="fu">func</span>(n) <span class="op">=</span> n <span class="op">*</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> step2 <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">filter</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(step1<span class="op">,</span> <span class="fu">func</span>(n) <span class="op">=</span> n <span class="op">&gt;</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> step3 <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>Nat<span class="op">,</span> Nat<span class="op">&gt;</span>(step2<span class="op">,</span> <span class="fu">func</span>(n) <span class="op">=</span> n <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        step3<span class="op">;</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good: Uses Buffer for efficient incremental building</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">efficientProcessing</span>(<span class="dt">data</span> <span class="op">:</span> [Nat]) <span class="op">:</span> [Nat] {</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(data<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (n <span class="kw">in</span> data<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> doubled <span class="op">=</span> n <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (doubled <span class="op">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>                result<span class="op">.</span><span class="fu">add</span>(doubled <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Buffer</span><span class="op">.</span><span class="fu">toArray</span>(result)<span class="op">;</span></span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good: Reuse existing structures</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cache <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>(<span class="dv">100</span><span class="op">,</span> Nat<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Hash<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">getValue</span>(<span class="dt">key</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span><span class="bu">Text</span> {</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (cache<span class="op">.</span><span class="fu">get</span>(key)) {</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>value) <span class="op">?</span>value<span class="op">;</span>  <span class="co">// Reuse cached value</span></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> computed <span class="op">=</span> <span class="fu">computeExpensiveValue</span>(key)<span class="op">;</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>                cache<span class="op">.</span><span class="fu">put</span>(key<span class="op">,</span> computed)<span class="op">;</span></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">?</span>computed<span class="op">;</span></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">computeExpensiveValue</span>(<span class="dt">key</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Value for &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(key)<span class="op">;</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="monitoring-memory-usage">2.13.3 Monitoring Memory Usage</h3>
<div class="sourceCode" id="cb92"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Prim <span class="st">&quot;mo:prim&quot;</span><span class="op">;</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>actor MemoryMonitor {</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getMemorySize</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>        Prim<span class="op">.</span><span class="fu">rts_memory_size</span>()<span class="op">;</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getHeapSize</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>        Prim<span class="op">.</span><span class="fu">rts_heap_size</span>()<span class="op">;</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">reportMemory</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> total <span class="op">=</span> Prim<span class="op">.</span><span class="fu">rts_memory_size</span>()<span class="op">;</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> heap <span class="op">=</span> Prim<span class="op">.</span><span class="fu">rts_heap_size</span>()<span class="op">;</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Total: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(total) # <span class="st">&quot; bytes, Heap: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(heap) # <span class="st">&quot; bytes&quot;</span><span class="op">;</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h2 id="orthogonal-persistence">2.14 Orthogonal Persistence</h2>
<p>Orthogonal persistence is a revolutionary feature of the Internet
Computer that automatically persists program state without explicit
save/load operations.</p>
<h3 id="understanding-orthogonal-persistence">2.14.1 Understanding
Orthogonal Persistence</h3>
<p>In traditional systems, you must: 1. Serialize state to storage 2.
Deserialize state from storage 3. Manage database connections 4. Handle
data consistency</p>
<p>With orthogonal persistence:</p>
<ul>
<li><p>✅ All state persists automatically</p></li>
<li><p>✅ No serialization/deserialization</p></li>
<li><p>✅ No database management</p></li>
<li><p>✅ Consistency guaranteed</p></li>
</ul>
<div class="sourceCode" id="cb93"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>actor AutoPersist {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All these persist automatically!</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">counter</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">users</span> <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> records <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span><span class="bu">Text</span><span class="op">&gt;</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> map <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> Nat<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Hash<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">increment</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Automatically persisted after message execution</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>        counter<span class="op">;</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addUser</span>(<span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">users</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(users<span class="op">,</span> [name])<span class="op">;</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// State change persisted automatically</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="stable-vs-regular-variables">2.14.2 Stable vs Regular
Variables</h3>
<div class="sourceCode" id="cb94"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>actor PersistenceTypes {</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Regular variable: persists between calls, </span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// but NOT across upgrades</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">temporary</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stable variable: persists between calls </span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// AND across upgrades</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">permanent</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">incrementBoth</span>() <span class="op">:</span> <span class="kw">async</span> (Nat<span class="op">,</span> Nat) {</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>        temporary <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>        permanent <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>        (temporary<span class="op">,</span> permanent)<span class="op">;</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// After upgrade:</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// - temporary resets to 0</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// - permanent keeps its value</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="persistence-lifecycle">2.14.3 Persistence Lifecycle</h3>
<div class="sourceCode" id="cb95"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>actor Lifecycle {</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">callCount</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">totalCalls</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">recordCall</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>        callCount <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        totalCalls <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;This call: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(callCount) # </span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;, Total: &quot;</span> # Nat<span class="op">.</span><span class="fu">toText</span>(totalCalls)<span class="op">;</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Persistence timeline:</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Message received</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Function executes</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. State changes made</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 4. Message completes</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 5. State automatically persisted ✓</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 6. Next message sees updated state</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="best-practices">2.14.4 Best Practices</h3>
<div class="sourceCode" id="cb96"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>actor BestPractices {</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Use stable for critical data</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">userBalances</span> <span class="op">:</span> [(Principal<span class="op">,</span> Nat)] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">totalSupply</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Use regular vars for caches (can rebuild)</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> computedCache <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Nat<span class="op">,</span> Nat<span class="op">&gt;</span>(<span class="dv">100</span><span class="op">,</span> Nat<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Hash<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Use stable vars for configuration</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">adminPrincipal</span> <span class="op">:</span> Principal <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;aaaaa-aa&quot;</span>)<span class="op">;</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">feeBasisPoints</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">30</span><span class="op">;</span>  <span class="co">// 0.3%</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Large collections: use stable storage patterns</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">entries</span> <span class="op">:</span> [(Nat<span class="op">,</span> <span class="bu">Text</span>)] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addEntry</span>(<span class="dt">key</span> <span class="op">:</span> Nat<span class="op">,</span> <span class="dt">value</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">entries</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(entries<span class="op">,</span> [(key<span class="op">,</span> value)])<span class="op">;</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ⚠️ For upgrades, use pre/postupgrade hooks</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">preupgrade</span>() {</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert complex structures to stable format</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">entries</span> <span class="op">:=</span> Iter<span class="op">.</span><span class="fu">toArray</span>(computedCache<span class="op">.</span><span class="fu">entries</span>())<span class="op">;</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Rebuild complex structures from stable data</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ((k<span class="op">,</span> v) <span class="kw">in</span> entries<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>            computedCache<span class="op">.</span><span class="fu">put</span>(k<span class="op">,</span> Nat<span class="op">.</span><span class="fu">fromText</span>(v) <span class="op">|&gt;</span> Option<span class="op">.</span><span class="fu">get</span>(_<span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<hr />
<h2 id="summary">Summary</h2>
<p>This chapter covered the fundamental building blocks of Motoko
programming:</p>
<ol type="1">
<li><strong>Hello, World!</strong> - Your first Motoko program</li>
<li><strong>Basic Syntax</strong> - Expressions, blocks, comments, and
naming conventions</li>
<li><strong>Types</strong> - Rich type system with primitives,
composites, and generics</li>
<li><strong>Declarations</strong> - Immutable (<code>let</code>) and
mutable (<code>var</code>) bindings</li>
<li><strong>Control Flow</strong> - Conditionals, loops, and powerful
pattern matching</li>
<li><strong>Actors &amp; Async</strong> - The foundation of Internet
Computer applications</li>
<li><strong>Mutable State</strong> - Managing state safely and
efficiently</li>
<li><strong>Messaging</strong> - Inter-actor communication patterns</li>
<li><strong>Modules &amp; Imports</strong> - Code organization and
reuse</li>
<li><strong>Pattern Matching</strong> - Exhaustive, type-safe data
destructuring</li>
<li><strong>Error Handling</strong> - Robust error management with
Result and Option types</li>
<li><strong>Data Persistence</strong> - Stable variables and upgrade
hooks</li>
<li><strong>Garbage Collection</strong> - Automatic memory
management</li>
<li><strong>Orthogonal Persistence</strong> - Automatic state
persistence without serialization</li>
</ol>
<p>With these fundamentals mastered, you’re ready to build sophisticated
decentralized applications on the Internet Computer. The next chapter
will dive deeper into Motoko’s advanced type system and how it prevents
common programming errors at compile time.</p>
<hr />
<hr />
<h1 id="chapter-3-type-system-and-safety">Chapter 3: Type System and
Safety</h1>
<p>The primary design goal of Motoko is <strong>safety</strong>. The
language employs a sound type system that enforces rigorous checks at
compile time, preventing entire classes of errors such as null pointer
dereferences, type mismatches, and memory corruption.</p>
<h3 id="nominal-vs.-structural-typing">3.1 Nominal vs. Structural
Typing</h3>
<p>Motoko employs a mix of nominal and structural typing, but it leans
heavily on structural typing for records and objects. This allows for
flexible interaction between different actors that may not share the
same source code but share the same data shape.</p>
<p><strong>Primitives and Bounded Types:</strong></p>
<p>Unlike languages that default to a generic int, Motoko forces the
developer to be precise about the nature of numbers:</p>
<ul>
<li><p><strong><code>Nat</code> (Natural Number):</strong> An unbounded
non-negative integer (0, 1, 2…). This is the default for counters,
balances, and IDs. Using <code>Nat</code> prevents underflow errors
(e.g., a balance going below zero) by definition.</p></li>
<li><p><strong><code>Int</code> (Integer):</strong> Unbounded signed
integers.</p></li>
<li><p><strong><code>Nat8</code>, <code>Nat32</code>,
<code>Nat64</code>:</strong> Fixed-width types used for binary data
processing, cryptographic operations, and interacting with standard
interfaces like the Ledger (which often uses
<code>Nat64</code>).</p></li>
</ul>
<h3 id="the-billion-dollar-mistake-option-types">3.2 The Billion Dollar
Mistake: Option Types</h3>
<p>Motoko eliminates the concept of a “null” value that can be
implicitly assigned to any reference type. Instead, it utilizes
<strong>Option Types</strong> (<code>?T</code>). A variable of type
<code>Text</code> <em>must</em> contain text. It cannot be null. If a
value might be missing, it must be declared as <code>?Text</code>.</p>
<p>This forces the developer to handle the “missing” case explicitly
using pattern matching, eliminating the risk of runtime null pointer
exceptions.</p>
<p><strong>Code Snippet: Pattern Matching Options</strong></p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> bio <span class="op">:</span> <span class="op">?</span><span class="bu">Text</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The compiler forces us to handle both cases</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> displayBio <span class="op">=</span> <span class="cf">switch</span>(bio) {</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> (<span class="kw">null</span>) { <span class="st">&quot;User has not provided a bio.&quot;</span> }<span class="op">;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> (<span class="op">?</span>text) { text }<span class="op">;</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="more-primitive-types">3.3 More Primitive Types</h3>
<p>In addition to numeric types, Motoko provides several other primitive
types that ensure safety and precision:</p>
<ul>
<li><strong><code>Bool</code></strong>: Represents true or false
values.</li>
<li><strong><code>Text</code></strong>: Immutable strings of Unicode
characters.</li>
<li><strong><code>Blob</code></strong>: Binary data, useful for raw
bytes.</li>
<li><strong><code>Principal</code></strong>: Unique identifiers for
users and canisters on the Internet Computer.</li>
<li><strong><code>Float</code></strong>: 64-bit floating-point numbers
for decimal arithmetic.</li>
</ul>
<p>These types are designed to prevent common errors, such as overflow
in numerics or invalid string operations.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> isActive <span class="op">:</span> Bool <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> username <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;motoko_dev&quot;</span><span class="op">;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> userId <span class="op">:</span> Principal <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;aaaaa-aa&quot;</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="composite-types-1">3.4 Composite Types</h3>
<p>Motoko supports several composite types to structure data safely.</p>
<h4 id="records-1">Records</h4>
<p>Records are structural types that group named fields.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>type Person <span class="op">=</span> {</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">age</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> <span class="dt">balance</span> <span class="op">:</span> Int<span class="op">;</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> user <span class="op">:</span> Person <span class="op">=</span> { name <span class="op">=</span> <span class="st">&quot;Alice&quot;</span><span class="op">;</span> age <span class="op">=</span> <span class="dv">30</span><span class="op">;</span> <span class="kw">var</span> balance <span class="op">=</span> <span class="dv">100</span> }<span class="op">;</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>user<span class="op">.</span><span class="at">balance</span> <span class="op">:=</span> <span class="dv">200</span><span class="op">;</span></span></code></pre></div>
<h4 id="variants-1">Variants</h4>
<p>Variants represent tagged unions, useful for enumerations or error
handling.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>type Result<span class="op">&lt;</span>T<span class="op">,</span> <span class="cn">E</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  #<span class="dt">Ok</span> <span class="op">:</span> T<span class="op">;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  #<span class="dt">Err</span> <span class="op">:</span> <span class="cn">E</span><span class="op">;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> success <span class="op">:</span> Result<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> <span class="op">=</span> #<span class="fu">Ok</span>(<span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> failure <span class="op">:</span> Result<span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> <span class="op">=</span> #<span class="fu">Err</span>(<span class="st">&quot;Operation failed&quot;</span>)<span class="op">;</span></span></code></pre></div>
<h4 id="arrays-and-tuples">Arrays and Tuples</h4>
<p>Arrays can be immutable or mutable, and tuples are anonymous
records.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> numbers <span class="op">:</span> [Nat] <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> mutableArray <span class="op">:</span> [<span class="kw">var</span> Nat] <span class="op">=</span> [<span class="kw">var</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span>]<span class="op">;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> pair <span class="op">:</span> (<span class="bu">Text</span><span class="op">,</span> Nat) <span class="op">=</span> (<span class="st">&quot;Score&quot;</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="type-aliases">3.5 Type Aliases</h3>
<p>Type aliases improve code readability without creating new types.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>type Username <span class="op">=</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>type Age <span class="op">=</span> Nat<span class="op">;</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>type User <span class="op">=</span> {</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">username</span> <span class="op">:</span> Username<span class="op">;</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">age</span> <span class="op">:</span> Age<span class="op">;</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="generics">3.6 Generics</h3>
<p>Generics allow functions and classes to work with any type.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>func identity<span class="op">&lt;</span>T<span class="op">&gt;</span>(x <span class="op">:</span> T) <span class="op">:</span> T {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>ignore identity<span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Box<span class="op">&lt;</span>T<span class="op">&gt;</span>(value <span class="op">:</span> T) {</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> func <span class="fu">open</span>() <span class="op">:</span> T { value }<span class="op">;</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> intBox <span class="op">=</span> Box<span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>ignore intBox<span class="op">.</span><span class="fu">open</span>()<span class="op">;</span></span></code></pre></div>
<h3 id="type-inference">3.7 Type Inference</h3>
<p>Motoko infers types where possible, reducing annotations.</p>
<p><strong>Example:</strong></p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> ar <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span> <span class="co">// Inferred as [Nat]</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> doubled <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">map</span>(ar<span class="op">,</span> func x { x <span class="op">*</span> <span class="dv">2</span> })<span class="op">;</span> <span class="co">// Inferred types</span></span></code></pre></div>
<hr />
<hr />
<h1 id="chapter-4-motoko-memory-architecture">Chapter 4: Motoko Memory
Architecture</h1>
<p>This section explores the most disruptive feature of Motoko:
<strong>Orthogonal Persistence</strong>. This concept fundamentally
alters how backend systems are architected, removing the distinction
between “memory” and “storage”.</p>
<p>In a conventional Web2 stack (e.g., Node.js + PostgreSQL), the
application memory is volatile. If the server crashes or reboots, all
local variables are lost. Therefore, developers must constantly
Serialize (marshal) data from RAM into a database format and Deserialize
(unmarshal) it back upon retrieval. This “Object-Relational Impedance
Mismatch” consumes significant development time and computational
resources.</p>
<p>To illustrate, consider a simple counter in a traditional setup:</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Node.js example (volatile)</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> counter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co">// To persist, you&#39;d need:</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> db <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;some-db&#39;</span>)<span class="op">;</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>db<span class="op">.</span><span class="fu">query</span>(<span class="st">&#39;UPDATE counters SET value = value + 1&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p>In Motoko, persistence is inherent:</p>
<div class="sourceCode" id="cb106"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Motoko (persistent)</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> counter <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">increment</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  counter <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  counter</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This counter survives canister restarts and upgrades (with proper
handling).</p>
<h3 id="the-stable-heap">4.1 The Stable Heap</h3>
<p>On the Internet Computer, a canister’s memory pages are preserved
automatically. When an actor modifies a variable, that change is
persisted. The developer does not write file I/O or database queries. As
long as the canister has cycles to pay for storage, the variables
exist.</p>
<p>However, this model faces a critical challenge: <strong>Software
Upgrades</strong>.</p>
<p>When a developer deploys a new version of the code (e.g., updating
OpenPatron v1.0 to v1.1), the canister’s WebAssembly module is replaced.
By default, the Wasm heap (volatile memory) is cleared to ensure the new
logic starts with a clean state. Without intervention, all user data
would be lost.</p>
<h3 id="the-legacy-solution-stable-variables">4.2 The Legacy Solution:
Stable Variables</h3>
<p>To solve the upgrade problem, Motoko introduced the
<code>stable</code> keyword.</p>
<ul>
<li><p><strong>Mechanism:</strong> When a variable is declared as
<code>stable var</code>, the system automatically hooks into the upgrade
lifecycle.</p></li>
<li><p><strong>Pre-upgrade:</strong> The system pauses execution,
serializes the contents of all stable variables, and moves them to a
dedicated “Stable Memory” area.</p></li>
<li><p><strong>Post-upgrade:</strong> The system loads the new code,
deserializes the data from Stable Memory, and repopulates the
variables.</p></li>
</ul>
<p><strong>Risk Analysis:</strong></p>
<p>While convenient, this legacy approach has a fatal flaw known as the
<strong>Instruction Limit Trap</strong>. The serialization process
consumes computational instructions. If a canister holds massive amounts
of data (e.g., 2GB of user records), the serialization process might
exceed the single-block instruction limit of the subnet. If this happens
during an upgrade, the canister traps, the upgrade fails, and the
canister effectively becomes “bricked”—unable to ever upgrade again.</p>
<p><strong>Common Pitfalls with Stable Variables:</strong> - Forgetting
to mark important data as stable, leading to data loss on upgrades. -
Overusing stable for large data structures, risking the instruction
limit. - Type mismatches during deserialization after code changes.</p>
<h3 id="the-modern-standard-enhanced-orthogonal-persistence-eop">4.3 The
Modern Standard: Enhanced Orthogonal Persistence (EOP)</h3>
<p>Recognizing the limitations of the serialization model, DFINITY
introduced <strong>Enhanced Orthogonal Persistence (EOP)</strong>. This
represents a major evolution in the Motoko runtime.</p>
<p>Under EOP, the distinction between the “Heap” and “Stable Memory” is
blurred. The entire heap file is preserved across upgrades.</p>
<ul>
<li><p><strong>Simplicity:</strong> Developers no longer need to obsess
over which variables are <code>stable</code>. The runtime retains the
main memory layout.</p></li>
<li><p><strong>Scalability:</strong> Since there is no massive
serialization/deserialization step, upgrades are nearly instantaneous,
regardless of the amount of data stored. This resolves the Instruction
Limit Trap.</p></li>
<li><p><strong>64-bit Heap:</strong> EOP enables access to the full
64-bit address space, allowing canisters to hold significantly more data
in main memory (up to current subnet limits, typically 4GB+, eventually
scaling to stable memory limits of 500GB) without complex manual memory
management.</p></li>
</ul>
<p><strong>Architectural Recommendation for OpenPatron:</strong></p>
<p>While EOP is the future, explicit stable declarations remain best
practice for critical data schemas until EOP is universally standardized
across all tooling. Furthermore, for massive datasets (exceeding heap
size), utilizing Stable Regions (manual memory management) or libraries
like StableBTreeMap is recommended to bypass heap limitations
entirely.</p>
<h3 id="implementing-persistence-in-openpatron">4.4 Implementing
Persistence in OpenPatron</h3>
<p>For the OpenPatron canister, which manages user subscriptions and
content access, persistence is crucial for maintaining user data across
updates.</p>
<p><strong>Key Data Structures:</strong> - Use stable arrays or maps for
user profiles and subscription lists. - Example:</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>stable <span class="kw">var</span> users <span class="op">:</span> HashMap<span class="op">.</span><span class="at">Principal</span><span class="op">,</span> UserProfile<span class="op">&gt;</span> <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> UserProfile<span class="op">&gt;</span>(<span class="dv">0</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>type UserProfile <span class="op">=</span> {</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">subscriptions</span> <span class="op">:</span> [Principal]<span class="op">;</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">balance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>Upgrade Strategy:</strong> - Leverage EOP for seamless
upgrades. - For large-scale data, integrate StableBTreeMap to handle
growth beyond heap limits.</p>
<p><strong>Best Practices:</strong> - Regularly test upgrades with
sample data to ensure no data loss. - Monitor canister memory usage via
dfx commands. - Implement data migration functions for schema
changes.</p>
<hr />
<hr />
<h1 id="chapter-5-identity-and-access-control">Chapter 5: Identity and
Access Control</h1>
<p>Decentralized applications cannot rely on centralized
username/password databases. They must utilize cryptographic
primitives.</p>
<h3 id="internet-identity-and-principals">5.1 Internet Identity and
Principals</h3>
<p>The Internet Computer uses <strong>Principals</strong>—textual
representations of public keys (e.g., <code>2vxsx-fae...</code>)—as the
universal user ID. To prevent user tracking across the ecosystem, the
Internet Computer introduces <strong>Internet Identity
(II)</strong>.</p>
<p>II uses Chain Key Cryptography to generate a unique “pseudonym”
Principal for the user for each Dapp they visit. This prevents
OpenPatron from colluding with other Dapps to build a profile of user
behavior.</p>
<h3 id="the-frontend-backend-handshake">5.2 The Frontend-Backend
Handshake</h3>
<p>Authentication occurs on the frontend. The user logs in via the
Internet Identity canister. The frontend receives an
<code>Identity</code> object, which it uses to sign all subsequent HTTP
requests to the backend canister.</p>
<p>On the backend (Motoko), the actor receives the message. The system
validates the signature and exposes the authenticated user via
<code>msg.caller</code>.</p>
<p>To demonstrate these concepts in a production context, we will
architect <strong>OpenPatron</strong>, a decentralized content
monetization platform. This application requires robust Identity,
Tokenomics, and Subscription logic.</p>
<p><strong>Code Implementation: The WhoAmI Pattern</strong></p>
<p>This pattern is essential for verifying that the authentication flow
is functioning correctly.</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define a public shared function that accepts a message context (msg)</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span> (msg) func <span class="fu">whoami</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// msg.caller is the cryptographically authenticated Principal</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Principal<span class="op">.</span><span class="fu">toText</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="storing-user-profiles">5.3 Storing User Profiles</h3>
<p>We need a scalable way to map these Principals to user data.</p>
<ul>
<li><p><strong>Naive Approach:</strong> Use a <code>List</code> or
<code>Array</code>. (O(n) lookup time—disastrous for scaling).</p></li>
<li><p><strong>Standard Approach:</strong> Use <code>HashMap</code>.
(O(1) lookup, but harder to persist securely in legacy stable
memory).</p></li>
<li><p><strong>Recommended Approach:</strong> Use <code>TrieMap</code>
or <code>RBTree</code>. These structures are deterministic and easier to
serialize for stable storage, or use <code>StableBTreeMap</code> for
direct stable memory storage.</p></li>
</ul>
<p><strong>Table 2: Data Structure Selection Guide</strong></p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 17%" />
<col style="width: 32%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th>Data Structure</th>
<th>Access Time</th>
<th>Upgrade Safety (Legacy)</th>
<th>Recommended Use Case</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Array</strong></td>
<td>O(1)</td>
<td>High</td>
<td>Small, fixed configurations.</td>
</tr>
<tr>
<td><strong>HashMap</strong></td>
<td>O(1)</td>
<td>Low (Rehashing cost)</td>
<td>Temporary caches, non-critical data.</td>
</tr>
<tr>
<td><strong>TrieMap</strong></td>
<td>O(log N)</td>
<td>Medium</td>
<td>General user directories.</td>
</tr>
<tr>
<td><strong>StableBTreeMap</strong></td>
<td>O(log N)</td>
<td>Ultra-High</td>
<td>Massive datasets (Users, Transactions).</td>
</tr>
</tbody>
</table>
<h3 id="implementing-user-profiles">5.4 Implementing User Profiles</h3>
<p>For storing user profiles in OpenPatron, we’ll use
<code>StableBTreeMap</code> from the base library for efficient and
upgrade-safe storage.</p>
<p>Here’s how to set it up:</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> StableBTreeMap <span class="st">&quot;mo:base/StableBTreeMap&quot;</span><span class="op">;</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Option <span class="st">&quot;mo:base/Option&quot;</span><span class="op">;</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    type Profile <span class="op">=</span> {</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">username</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bio</span><span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">;</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add more fields like createdAt, etc.</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users</span> <span class="op">:</span> StableBTreeMap<span class="op">.</span><span class="at">StableBTreeMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> Profile<span class="op">&gt;</span> <span class="op">=</span> StableBTreeMap<span class="op">.</span><span class="fu">init</span>(Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">register</span>(<span class="dt">username</span><span class="op">:</span> <span class="bu">Text</span><span class="op">,</span> <span class="dt">bio</span><span class="op">:</span> <span class="op">?</span><span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(caller)) {</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>_) { <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">;</span> <span class="co">// Already registered</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="dt">profile</span> <span class="op">:</span> Profile <span class="op">=</span> { username<span class="op">;</span> bio }<span class="op">;</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>                users<span class="op">.</span><span class="fu">insert</span>(caller<span class="op">,</span> profile)<span class="op">;</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">getProfile</span>() <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>Profile {</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>        users<span class="op">.</span><span class="fu">get</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getProfileByPrincipal</span>(<span class="dt">p</span><span class="op">:</span> Principal) <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>Profile {</span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>        users<span class="op">.</span><span class="fu">get</span>(p)<span class="op">;</span></span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This allows users to register a profile associated with their
Principal.</p>
<h3 id="access-control-patterns">5.5 Access Control Patterns</h3>
<p>To ensure only authenticated users can perform certain actions, check
against the anonymous Principal.</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Error</span> <span class="st">&quot;mo:base/Error&quot;</span><span class="op">;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>func <span class="fu">requireAuthenticated</span>(caller<span class="op">:</span> Principal) {</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Principal<span class="op">.</span><span class="fu">isAnonymous</span>(caller)) {</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;Anonymous access not allowed&quot;</span>)<span class="op">;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Example usage</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">createContent</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requireAuthenticated</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Proceed with content creation</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="roles-and-permissions">5.6 Roles and Permissions</h3>
<p>In OpenPatron, users can have roles like ‘patron’, ‘creator’, or
‘admin’. Extend the Profile type:</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>type Role <span class="op">=</span> { #Patron<span class="op">;</span> #Creator<span class="op">;</span> #Admin }<span class="op">;</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>type Profile <span class="op">=</span> {</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">username</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bio</span><span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">;</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">role</span><span class="op">:</span> Role<span class="op">;</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="co">// In register, set default role, e.g., #Patron</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to check role</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>func <span class="fu">requireRole</span>(caller<span class="op">:</span> Principal<span class="op">,</span> required<span class="op">:</span> Role) {</span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(caller)) {</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="op">?</span>profile) {</span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (profile<span class="op">.</span><span class="at">role</span> <span class="op">!=</span> required) {</span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;Insufficient permissions&quot;</span>)<span class="op">;</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;User not registered&quot;</span>)<span class="op">;</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">adminFunction</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requireAuthenticated</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">requireRole</span>(msg<span class="op">.</span><span class="at">caller</span><span class="op">,</span> #Admin)<span class="op">;</span></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Admin logic</span></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="security-considerations">5.7 Security Considerations</h3>
<ul>
<li><strong>Principal Privacy</strong>: Never log or expose Principals
unnecessarily to prevent correlation attacks.</li>
<li><strong>Delegation Chains</strong>: Use short-lived delegations for
sessions to minimize exposure.</li>
<li><strong>Upgrade Safety</strong>: Always use stable variables for
critical data.</li>
<li><strong>Input Validation</strong>: Sanitize all user inputs to
prevent injection attacks.</li>
<li><strong>Rate Limiting</strong>: Implement canister-level rate
limiting to prevent DDoS.</li>
</ul>
<p>These practices ensure robust identity management in your Dapp.</p>
<h3 id="frontend-integration">5.8 Frontend Integration</h3>
<p>While this book focuses on Motoko backend, identity requires frontend
coordination. Use the <code>@dfinity/auth-client</code> library in your
JavaScript/TypeScript frontend.</p>
<p>Example login flow:</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { AuthClient } <span class="im">from</span> <span class="st">&quot;@dfinity/auth-client&quot;</span><span class="op">;</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> authClient <span class="op">=</span> <span class="cf">await</span> AuthClient<span class="op">.</span><span class="fu">create</span>()<span class="op">;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> authClient<span class="op">.</span><span class="fu">login</span>({</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">identityProvider</span><span class="op">:</span> <span class="st">&quot;https://identity.ic0.app&quot;</span><span class="op">,</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">onSuccess</span><span class="op">:</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> identity <span class="op">=</span> authClient<span class="op">.</span><span class="fu">getIdentity</span>()<span class="op">;</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use identity to create an actor for your canister</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>This handles the delegation and signing for backend calls.</p>
<p>For anonymous access, create an actor with the anonymous
identity.</p>
<h3 id="complete-openpatron-identity-implementation">5.9 Complete
OpenPatron Identity Implementation</h3>
<p>Putting it all together, here’s a more complete actor for
OpenPatron’s identity system, incorporating profiles, roles, and access
controls. We’ve added profile update and role assignment functions.</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> StableBTreeMap <span class="st">&quot;mo:base/StableBTreeMap&quot;</span><span class="op">;</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Option <span class="st">&quot;mo:base/Option&quot;</span><span class="op">;</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Error</span> <span class="st">&quot;mo:base/Error&quot;</span><span class="op">;</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Time <span class="st">&quot;mo:base/Time&quot;</span><span class="op">;</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    type Role <span class="op">=</span> { #Patron<span class="op">;</span> #Creator<span class="op">;</span> #Admin }<span class="op">;</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    type Profile <span class="op">=</span> {</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">username</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bio</span><span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">;</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">role</span><span class="op">:</span> Role<span class="op">;</span></span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">createdAt</span><span class="op">:</span> Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users</span> <span class="op">:</span> StableBTreeMap<span class="op">.</span><span class="at">StableBTreeMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> Profile<span class="op">&gt;</span> <span class="op">=</span> StableBTreeMap<span class="op">.</span><span class="fu">init</span>(Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Helper functions</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">requireAuthenticated</span>(<span class="dt">caller</span><span class="op">:</span> Principal) {</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Principal<span class="op">.</span><span class="fu">isAnonymous</span>(caller)) {</span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;Anonymous access not allowed&quot;</span>)<span class="op">;</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>    func <span class="fu">requireRole</span>(<span class="dt">caller</span><span class="op">:</span> Principal<span class="op">,</span> <span class="dt">required</span><span class="op">:</span> Role) {</span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(caller)) {</span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>profile) {</span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (profile<span class="op">.</span><span class="at">role</span> <span class="op">!=</span> required) {</span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;Insufficient permissions&quot;</span>)<span class="op">;</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;User not registered&quot;</span>)<span class="op">;</span></span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Whoami for testing</span></span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span> (msg) func <span class="fu">whoami</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Principal<span class="op">.</span><span class="fu">toText</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register new user</span></span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">register</span>(<span class="dt">username</span><span class="op">:</span> <span class="bu">Text</span><span class="op">,</span> <span class="dt">bio</span><span class="op">:</span> <span class="op">?</span><span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireAuthenticated</span>(caller)<span class="op">;</span></span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(caller)) {</span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>_) { <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">;</span> <span class="co">// Already registered</span></span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="dt">profile</span> <span class="op">:</span> Profile <span class="op">=</span> {</span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>                    username<span class="op">;</span></span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>                    bio<span class="op">;</span></span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>                    role <span class="op">=</span> #Patron<span class="op">;</span> <span class="co">// Default role</span></span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>                    createdAt <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>                users<span class="op">.</span><span class="fu">insert</span>(caller<span class="op">,</span> profile)<span class="op">;</span></span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get own profile</span></span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">getProfile</span>() <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>Profile {</span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireAuthenticated</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a>        users<span class="op">.</span><span class="fu">get</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get profile by principal (public query, but could be restricted)</span></span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getProfileByPrincipal</span>(<span class="dt">p</span><span class="op">:</span> Principal) <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>Profile {</span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a>        users<span class="op">.</span><span class="fu">get</span>(p)<span class="op">;</span></span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-74"><a href="#cb113-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-75"><a href="#cb113-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update profile</span></span>
<span id="cb113-76"><a href="#cb113-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">updateProfile</span>(<span class="dt">newUsername</span><span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">,</span> newBio<span class="op">:</span> <span class="op">?</span><span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb113-77"><a href="#cb113-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb113-78"><a href="#cb113-78" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireAuthenticated</span>(caller)<span class="op">;</span></span>
<span id="cb113-79"><a href="#cb113-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(caller)) {</span>
<span id="cb113-80"><a href="#cb113-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>profile) {</span>
<span id="cb113-81"><a href="#cb113-81" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="dt">updated</span> <span class="op">:</span> Profile <span class="op">=</span> {</span>
<span id="cb113-82"><a href="#cb113-82" aria-hidden="true" tabindex="-1"></a>                    username <span class="op">=</span> Option<span class="op">.</span><span class="fu">get</span>(newUsername<span class="op">,</span> profile<span class="op">.</span><span class="at">username</span>)<span class="op">;</span></span>
<span id="cb113-83"><a href="#cb113-83" aria-hidden="true" tabindex="-1"></a>                    bio <span class="op">=</span> <span class="cf">if</span> (newBio <span class="op">==</span> <span class="kw">null</span>) { profile<span class="op">.</span><span class="at">bio</span> } <span class="cf">else</span> { newBio }<span class="op">;</span></span>
<span id="cb113-84"><a href="#cb113-84" aria-hidden="true" tabindex="-1"></a>                    role <span class="op">=</span> profile<span class="op">.</span><span class="at">role</span><span class="op">;</span></span>
<span id="cb113-85"><a href="#cb113-85" aria-hidden="true" tabindex="-1"></a>                    createdAt <span class="op">=</span> profile<span class="op">.</span><span class="at">createdAt</span><span class="op">;</span></span>
<span id="cb113-86"><a href="#cb113-86" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb113-87"><a href="#cb113-87" aria-hidden="true" tabindex="-1"></a>                users<span class="op">.</span><span class="fu">insert</span>(caller<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb113-88"><a href="#cb113-88" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb113-89"><a href="#cb113-89" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb113-90"><a href="#cb113-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> { <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span> }<span class="op">;</span></span>
<span id="cb113-91"><a href="#cb113-91" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb113-92"><a href="#cb113-92" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-93"><a href="#cb113-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-94"><a href="#cb113-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Assign role (admin only)</span></span>
<span id="cb113-95"><a href="#cb113-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">assignRole</span>(<span class="dt">target</span><span class="op">:</span> Principal<span class="op">,</span> <span class="dt">newRole</span><span class="op">:</span> Role) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb113-96"><a href="#cb113-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireAuthenticated</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb113-97"><a href="#cb113-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireRole</span>(msg<span class="op">.</span><span class="at">caller</span><span class="op">,</span> #Admin)<span class="op">;</span></span>
<span id="cb113-98"><a href="#cb113-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(target)) {</span>
<span id="cb113-99"><a href="#cb113-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>profile) {</span>
<span id="cb113-100"><a href="#cb113-100" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="dt">updated</span> <span class="op">:</span> Profile <span class="op">=</span> {</span>
<span id="cb113-101"><a href="#cb113-101" aria-hidden="true" tabindex="-1"></a>                    profile <span class="cf">with</span> role <span class="op">=</span> newRole<span class="op">;</span></span>
<span id="cb113-102"><a href="#cb113-102" aria-hidden="true" tabindex="-1"></a>                }<span class="op">;</span></span>
<span id="cb113-103"><a href="#cb113-103" aria-hidden="true" tabindex="-1"></a>                users<span class="op">.</span><span class="fu">insert</span>(target<span class="op">,</span> updated)<span class="op">;</span></span>
<span id="cb113-104"><a href="#cb113-104" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb113-105"><a href="#cb113-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb113-106"><a href="#cb113-106" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="bu">Error</span><span class="op">.</span><span class="fu">reject</span>(<span class="st">&quot;Target user not registered&quot;</span>)<span class="op">;</span></span>
<span id="cb113-107"><a href="#cb113-107" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb113-108"><a href="#cb113-108" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb113-109"><a href="#cb113-109" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-110"><a href="#cb113-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-111"><a href="#cb113-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Example protected function: Create content (creators only)</span></span>
<span id="cb113-112"><a href="#cb113-112" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">createContent</span>(<span class="dt">content</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb113-113"><a href="#cb113-113" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireAuthenticated</span>(msg<span class="op">.</span><span class="at">caller</span>)<span class="op">;</span></span>
<span id="cb113-114"><a href="#cb113-114" aria-hidden="true" tabindex="-1"></a>        <span class="fu">requireRole</span>(msg<span class="op">.</span><span class="at">caller</span><span class="op">,</span> #Creator)<span class="op">;</span></span>
<span id="cb113-115"><a href="#cb113-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">// </span><span class="al">TODO</span><span class="co">: Implement content storage logic in later chapters</span></span>
<span id="cb113-116"><a href="#cb113-116" aria-hidden="true" tabindex="-1"></a>        ignore content<span class="op">;</span> <span class="co">// Placeholder</span></span>
<span id="cb113-117"><a href="#cb113-117" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb113-118"><a href="#cb113-118" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This actor provides a solid foundation for OpenPatron’s identity
system, ready to integrate with tokenomics in the next chapter.</p>
<h3 id="testing-and-deployment">5.10 Testing and Deployment</h3>
<ul>
<li><strong>Local Testing</strong>: Use <code>dfx deploy</code> and test
with <code>dfx canister call OpenPatron whoami</code> (expect anonymous
principal). Integrate with a frontend for full auth flow.</li>
<li><strong>Mainnet Deployment</strong>: Ensure your canister has enough
cycles. Use Internet Identity for production auth.</li>
<li><strong>Common Pitfalls</strong>: Forgetting to handle anonymous
callers, not using stable storage, or exposing sensitive Principal
data.</li>
<li><strong>Best Practice</strong>: Implement unit tests for all
functions, especially guards.</li>
</ul>
<p>With this, the identity component of OpenPatron is complete,
providing secure user management for the platform.</p>
<hr />
<hr />
<h1 id="chapter-6-tokenomics-and-ledger-integration">Chapter 6:
Tokenomics and Ledger Integration</h1>
<p>OpenPatron requires a financial layer. Unlike Ethereum, where tokens
are smart contracts often copied and pasted by developers, ICP
encourages the use of standardized <strong>Ledger Canisters</strong>
implementing the <strong>ICRC-1</strong> standard.</p>
<h3 id="inter-canister-ledger-interactions">6.1 Inter-Canister Ledger
Interactions</h3>
<p>OpenPatron does not “mint” new tokens; it manages the flow of
existing tokens (e.g., ICP or a stablecoin). Therefore, OpenPatron acts
as a wallet controller.</p>
<p>To interact with the official Ledger, we must define an <strong>Actor
Interface</strong>. This is equivalent to an ABI (Application Binary
Interface) in Solidity.</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Abstract interface for the ICRC-1 Ledger</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>type Account <span class="op">=</span> { <span class="dt">owner</span> <span class="op">:</span> Principal<span class="op">;</span> <span class="dt">subaccount</span> <span class="op">:</span> <span class="op">?</span>[Nat8] }<span class="op">;</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>type TransferArgs <span class="op">=</span> {</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">to</span> <span class="op">:</span> Account<span class="op">;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">fee</span> <span class="op">:</span> <span class="op">?</span>Nat<span class="op">;</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">memo</span> <span class="op">:</span> <span class="op">?</span><span class="bu">Blob</span><span class="op">;</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">from_subaccount</span> <span class="op">:</span> <span class="op">?</span>[Nat8]<span class="op">;</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">created_at_time</span> <span class="op">:</span> <span class="op">?</span>Nat64<span class="op">;</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">amount</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>type TransferResult <span class="op">=</span> { #<span class="dt">Ok</span> <span class="op">:</span> Nat<span class="op">;</span> #<span class="dt">Err</span> <span class="op">:</span> Variant {<span class="op">...</span> } }<span class="op">;</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ledgerId <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;mxzaz-hqaaa-aaaar-qaada-cai&quot;</span>)<span class="op">;</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> ledger <span class="op">=</span> <span class="fu">actor</span>(Principal<span class="op">.</span><span class="fu">toText</span>(ledgerId)) <span class="op">:</span> actor {</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">icrc1_transfer</span> <span class="op">:</span> (TransferArgs) <span class="op">-&gt;</span> <span class="kw">async</span> TransferResult<span class="op">;</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">icrc1_balance_of</span> <span class="op">:</span> (Account) <span class="op">-&gt;</span> <span class="kw">async</span> Nat<span class="op">;</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="the-deposit-pattern-vs.-approvetransferfrom">6.2 The Deposit
Pattern vs. Approve/TransferFrom</h3>
<p>In Ethereum, the standard subscription pattern is
<code>approve()</code> (User allows contract to spend) followed by
<code>transferFrom()</code> (Contract pulls funds). While supported by
ICRC-2, this introduces UX friction (two transactions).</p>
<p>For OpenPatron, we implement the <strong>Deposit Pattern</strong>
(often called the Subaccount Pattern):</p>
<ol type="1">
<li><p><strong>Subaccount Generation:</strong> OpenPatron calculates a
unique subaccount address for User A. This is a deterministic derivation
of <code>hash(OpenPatron_Principal + User_A_Principal)</code>.</p></li>
<li><p><strong>Direct Transfer:</strong> User A sends tokens directly to
this subaccount on the Ledger. This is a standard transfer, not a smart
contract interaction.</p></li>
<li><p><strong>Notification:</strong> User A calls
<code>OpenPatron.notify_deposit()</code>.</p></li>
<li><p><strong>Verification:</strong> OpenPatron queries the Ledger for
the balance of that specific subaccount.</p></li>
<li><p><strong>Crediting:</strong> OpenPatron updates its internal
state: <code>balances[User_A] += amount</code>.</p></li>
</ol>
<p>This pattern is gas-efficient and secure, as OpenPatron has full
cryptographic control over the subaccount.</p>
<h3 id="deterministic-subaccount-derivation">6.3 Deterministic
Subaccount Derivation</h3>
<p>Subaccounts are 32-byte blobs, so we can deterministically derive one
per supporter without storing anything on-chain. The canonical approach
is to hash a namespace prefix together with the caller’s
<code>Principal</code>.</p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Blob</span> <span class="st">&quot;mo:base/Blob&quot;</span><span class="op">;</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> SHA256 <span class="st">&quot;mo:crypto/SHA/SHA256&quot;</span><span class="op">;</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> namespace <span class="op">=</span> <span class="st">&quot;OpenPatron&quot;</span><span class="op">;</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>func <span class="fu">supporterSubaccount</span>(user <span class="op">:</span> Principal) <span class="op">:</span> <span class="bu">Blob</span> {</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> input <span class="op">=</span> <span class="bu">Blob</span><span class="op">.</span><span class="fu">fromArray</span>(<span class="bu">Text</span><span class="op">.</span><span class="fu">encodeUtf8</span>(namespace)) # Principal<span class="op">.</span><span class="fu">toBlob</span>(user)<span class="op">;</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> digest <span class="op">=</span> SHA256<span class="op">.</span><span class="fu">fromBlob</span>(input)<span class="op">;</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Blob</span><span class="op">.</span><span class="fu">fromArray</span>(digest<span class="op">.</span><span class="fu">vals</span>()[<span class="dv">0</span> <span class="op">:</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Because the derivation is deterministic, both the frontend and
backend can display the same deposit address. If the namespace ever
changes, historical subaccounts are still valid because the Ledger only
cares about the resulting 32-byte value.</p>
<h3 id="verifying-deposits-against-the-ledger">6.4 Verifying Deposits
Against the Ledger</h3>
<p>When <code>notify_deposit()</code> is called, OpenPatron must query
the Ledger to confirm funds really arrived. The flow is:</p>
<ol type="1">
<li>Recompute the subaccount using the user principal.</li>
<li>Call <code>icrc1_balance_of</code> with
<code>{ owner = OpenPatron_Principal; subaccount = ?sub }</code>.</li>
<li>Compare the returned amount with what the user claims.</li>
<li>Only after a successful check, update internal accounting and emit
an event.</li>
</ol>
<div class="sourceCode" id="cb116"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span> ({ caller }) func <span class="fu">notifyDeposit</span>(expected <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> <span class="dt">account</span> <span class="op">:</span> Account <span class="op">=</span> { owner <span class="op">=</span> OpenPatronId<span class="op">;</span> subaccount <span class="op">=</span> <span class="op">?</span><span class="bu">Blob</span><span class="op">.</span><span class="fu">toArray</span>(<span class="fu">supporterSubaccount</span>(caller)) }<span class="op">;</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> balance <span class="op">=</span> <span class="cf">await</span> ledger<span class="op">.</span><span class="fu">icrc1_balance_of</span>(account)<span class="op">;</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span>(balance <span class="op">&gt;=</span> expected)<span class="op">;</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  balances<span class="op">.</span><span class="fu">put</span>(caller<span class="op">,</span> balance)<span class="op">;</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> balance<span class="op">;</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This keeps OpenPatron stateless regarding incoming transfers and
aligns with the immutable history the Ledger already provides.</p>
<h3 id="withdrawals-refunds-and-creator-payouts">6.5 Withdrawals,
Refunds, and Creator Payouts</h3>
<p>Outbound transfers use the same actor reference but call
<code>icrc1_transfer</code>. We treat refunds and scheduled payouts
identically; only the <code>Account</code> destination differs.</p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span> ({ caller }) func <span class="fu">payout</span>(creator <span class="op">:</span> Principal<span class="op">,</span> amount <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> TransferResult {</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span>(<span class="fu">hasRole</span>(caller<span class="op">,</span> #Admin))<span class="op">;</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> <span class="dt">args</span> <span class="op">:</span> TransferArgs <span class="op">=</span> {</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    to <span class="op">=</span> { owner <span class="op">=</span> creator<span class="op">;</span> subaccount <span class="op">=</span> <span class="kw">null</span> }<span class="op">;</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    fee <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    memo <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    from_subaccount <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    created_at_time <span class="op">=</span> <span class="op">?</span>Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    amount <span class="op">=</span> amount<span class="op">;</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="cf">await</span> ledger<span class="op">.</span><span class="fu">icrc1_transfer</span>(args)<span class="op">;</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Important safeguards:</p>
<ul>
<li>Track pending payouts in stable memory so retries are
idempotent.</li>
<li>Cap the maximum amount per call to avoid draining the treasury due
to a bug.</li>
<li>Bubble up <code>#Err</code> variants to the caller so the UI can
prompt the user to retry later.</li>
</ul>
<h3 id="supporting-multiple-tokens-icrc-1-vs.-icrc-2">6.6 Supporting
Multiple Tokens (ICRC-1 vs. ICRC-2)</h3>
<p>Many creators want to accept both ICP and a stable asset. OpenPatron
can maintain a registry of “payment rails,” each storing the Ledger
canister principal, decimals, and default fee. The deposit workflow
stays the same because every ICRC-1 token exposes
<code>icrc1_balance_of</code> and <code>icrc1_transfer</code>. For
tokens that support ICRC-2 approvals, we can optionally let power users
enable the <code>approve/transfer_from</code> flow for recurring
billing, while keeping the deposit pattern as the default for
simplicity.</p>
<h3 id="local-testing-with-the-ledger-canister">6.7 Local Testing with
the Ledger Canister</h3>
<p><code>dfx</code> ships with a local Ledger replica. A productive
workflow is:</p>
<ol type="1">
<li><code>dfx start --background --clean</code></li>
<li><code>dfx ledger fabricate-cycles --canister openpatron</code></li>
<li><code>dfx ledger transfer &lt;subaccount-principal&gt; --amount 10</code></li>
<li>Call <code>notify_deposit</code> from the candid UI or a unit
test.</li>
</ol>
<p>Because the local Ledger persists to the <code>dfx</code> state
directory, you can script entire integration tests that simulate
deposits, time-based payouts, and refunds without touching mainnet.</p>
<h3 id="operational-safeguards">6.8 Operational Safeguards</h3>
<ul>
<li><strong>Rate limits:</strong> throttle <code>notify_deposit</code>
to prevent spamming ledger queries.</li>
<li><strong>Reconciliation jobs:</strong> run a nightly timer that scans
every subaccount and compares on-ledger balances with internal records
to catch drift.</li>
<li><strong>Audit trails:</strong> append immutable events (deposit
verified, payout executed, refund issued) to a log canister so
compliance and customer support have a source of truth.</li>
<li><strong>Upgrade safety:</strong> keep derived subaccounts
deterministic and do not migrate them; ledger balances are independent
of code upgrades, so your upgrade logic should never attempt to recreate
them differently.</li>
</ul>
<hr />
<hr />
<h1 id="chapter-7-autonomous-subscriptions-via-timers">Chapter 7:
Autonomous Subscriptions via Timers</h1>
<p>The “Holy Grail” of crypto payments is the recurring subscription.
Blockchains are passive; they only change state when triggered. Ethereum
requires external “Keepers” (e.g., Chainlink Automation) to trigger
functions. The Internet Computer, however, allows canisters to schedule
their own execution.</p>
<h3 id="the-timer-api">7.1 The Timer API</h3>
<p>Motoko provides the <code>Timer</code> module in the base library. It
allows for both one-off tasks (<code>setTimer</code>) and recurring
tasks (<code>recurringTimer</code>).</p>
<p><strong>Implementation Strategy:</strong></p>
<p>OpenPatron initiates a recurring timer that runs every hour (or day).
This “Cron Job” iterates through active subscriptions and processes
payments.</p>
<div class="sourceCode" id="cb118"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Timer <span class="st">&quot;mo:base/Timer&quot;</span><span class="op">;</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Time <span class="st">&quot;mo:base/Time&quot;</span><span class="op">;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// One day in nanoseconds</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="dt">INTERVAL</span> <span class="op">:</span> Nat64 <span class="op">=</span> <span class="dv">86_400_000_000_000</span><span class="op">;</span> </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The heartbeat function</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">processSubscriptions</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> now <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Iterate active subscriptions</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if due_date &lt; now</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Move internal balance from Patron to Creator</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start the engine</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">init</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> timerId <span class="op">=</span> Timer<span class="op">.</span><span class="fu">recurringTimer</span>(#<span class="fu">nanoseconds</span>(INTERVAL)<span class="op">,</span> processSubscriptions)<span class="op">;</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="efficiency-and-virtual-transactions">7.2 Efficiency and
“Virtual” Transactions</h3>
<p>Crucially, the <code>processSubscriptions</code> function does
<strong>not</strong> interact with the main Token Ledger for every
subscription payment. That would be prohibitively slow and expensive
(requiring inter-canister calls for every $5 payment).</p>
<p>Instead, OpenPatron uses <strong>Virtual Accounting</strong>:</p>
<ol type="1">
<li><p>The Patron deposits $50 into the canister (recorded on the
Ledger).</p></li>
<li><p>OpenPatron credits the Patron’s internal balance
variable.</p></li>
<li><p>Every month, OpenPatron simply decrements
<code>PatronBalance</code> and increments <code>CreatorBalance</code> in
its own <code>TrieMap</code>. This operation is instant and
free.</p></li>
<li><p>Real tokens only move on the Ledger when the Creator decides to
<code>withdraw()</code> their accumulated earnings.</p></li>
</ol>
<p>This scalability strategy mirrors how centralized exchanges
(Coinbase, Binance) handle internal trades off-chain, but here the
“off-chain” logic is actually “on-chain” in the canister’s secured
memory.</p>
<h3 id="scheduling-windows-and-drift">7.3 Scheduling Windows and
Drift</h3>
<p>Timers are <em>best effort</em>. They are driven by the replica’s
heartbeat, so the callback runs <strong>no sooner</strong> than the
interval and can drift when the subnet is busy. Keep the following guard
rails in mind:</p>
<ul>
<li>Treat the timer as a <em>reminder</em> rather than an exact
timestamp. Always compare
<code>subscription.nextCharge &lt;= Time.now()</code> before
charging.</li>
<li>Keep timer callbacks short (&lt; ~2B instructions). Heavy work
should be chunked and scheduled again, otherwise the replica will trap
the timer.</li>
<li>Persist the timer identifier if you need to cancel or reschedule it
after upgrades: store <code>timerId : ?Timer.TimerId</code> in stable
memory and restart it from <code>postupgrade</code>.</li>
</ul>
<p>When ultra-precise timing is required (e.g., daily charges at
midnight UTC), record the <code>nextCharge</code> timestamp and
calculate <code>max(Time.now() - nextCharge, 0)</code> to detect missed
windows.</p>
<h3 id="modeling-the-subscription-queue">7.4 Modeling the Subscription
Queue</h3>
<p>Because the timer callback may run late, the queue must be
idempotent. One practical model:</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>type SubscriptionId <span class="op">=</span> Nat32<span class="op">;</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>type Timestamp <span class="op">=</span> Nat64<span class="op">;</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>type Subscription <span class="op">=</span> {</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">patron</span> <span class="op">:</span> Principal<span class="op">;</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">creator</span> <span class="op">:</span> Principal<span class="op">;</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cadence</span> <span class="op">:</span> Nat64<span class="op">;</span>          <span class="co">// nanoseconds between invoices</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">nextCharge</span> <span class="op">:</span> Timestamp<span class="op">;</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">amount</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>stable <span class="kw">var</span> subscriptions <span class="op">=</span> TrieMap<span class="op">.</span><span class="at">TrieMap</span><span class="op">&lt;</span>SubscriptionId<span class="op">,</span> Subscription<span class="op">&gt;</span>(<span class="op">...</span>)<span class="op">;</span></span></code></pre></div>
<ul>
<li>The timer walks the map, collects subscriptions whose
<code>nextCharge</code> is due, and pushes them into a batch list.</li>
<li>After posting the batch, update each record’s
<code>nextCharge += cadence</code>. If the patron lacks funds, mark the
subscription as <code>Suspended</code> and notify them out-of-band.</li>
<li>Use pagination (process 100 subs per tick) to stay within
instruction limits. Add a <code>cursor</code> in stable memory so the
next tick resumes where it left off.</li>
</ul>
<h3 id="failure-modes-and-recovery">7.5 Failure Modes and Recovery</h3>
<p>Even with virtual accounting, things can go wrong:</p>
<ul>
<li><strong>Transient traps</strong> (e.g., due to temporary Ledger
outages). Surround external calls with retries/backoff and record
failures in a <code>Queue&lt;Event&gt;</code> that a maintainer can
inspect.</li>
<li><strong>Long outages</strong>. If the canister is stopped for hours,
the next timer run should loop until <code>nextCharge</code> catches up
with <code>now</code>, charging multiple periods if necessary.</li>
<li><strong>Skipped patrons</strong>. Store a <code>lastProcessed</code>
timestamp for diagnostic purposes so you can alert users when their
subscriptions paused for too long.</li>
</ul>
<p>Expose a public <code>manualProcess(limit : Nat)</code> method
guarded by an access control check. Operators can call it to drain the
queue if the timer lags.</p>
<h3 id="manual-overrides-and-observability">7.6 Manual Overrides and
Observability</h3>
<p>Self-healing automation still needs visibility:</p>
<ul>
<li>Emit <code>processSubscriptions</code> metrics: number of patrons
charged, total debited, ms spent. You can expose these via
<code>shared query func stats()</code>.</li>
<li>Log anomalies (insufficient balance, stuck creators) to an
append-only <code>EventLog</code>. Keep it compact (e.g., circular
buffer) so upgrades stay cheap.</li>
<li>Provide UX endpoints:
<code>patronUpcomingCharges(patron, horizon)</code> so front-ends can
show when the next debit occurs.</li>
</ul>
<h3 id="testing-timer-logic-without-waiting">7.7 Testing Timer Logic
Without Waiting</h3>
<p>Timers do not fire inside unit tests, so decouple the pure logic from
the scheduling:</p>
<ol type="1">
<li>Move the core loop into
<code>processSubscriptionsInternal(now : Time.Time)</code>.</li>
<li>Have the timer call
<code>processSubscriptionsInternal(Time.now())</code>.</li>
<li>In tests, inject deterministic timestamps and fake subscription data
to assert the resulting state transitions (<code>balances</code>,
<code>nextCharge</code>, event logs).</li>
</ol>
<p>This pattern also enables canary environments where you invoke
<code>manualProcess</code> on demand before enabling the recurring timer
in production.</p>
<hr />
<hr />
<h1 id="chapter-8-asynchronous-safety-and-reentrancy">Chapter 8:
Asynchronous Safety and Reentrancy</h1>
<p>As OpenPatron moves from prototype to production, naive
implementations will encounter the hard limits of distributed systems:
concurrency bugs and resource constraints.</p>
<p>The most dangerous aspect of Motoko for developers coming from
Solidity is the <strong>non-atomicity of inter-canister
calls</strong>.</p>
<h3 id="the-await-gap">8.1 The Await Gap</h3>
<p>When an actor calls <code>await ledger.transfer(...)</code>, the
execution of that function is <strong>suspended</strong>. The actor
releases its lock on the state. While waiting for the ledger to reply
(which might take seconds), the actor can process <em>new</em> messages
from other users.</p>
<p><strong>The Reentrancy Vulnerability:</strong></p>
<p>Consider a naive withdrawal function:</p>
<ol type="1">
<li><p>Check Balance (<code>if balance &gt; 0</code>)</p></li>
<li><p><code>await ledger.transfer(balance)</code></p></li>
<li><p>Set Balance to 0 (<code>balance := 0</code>)</p></li>
</ol>
<p>If a malicious user sends two withdrawal requests simultaneously:</p>
<ul>
<li><p><strong>Request A</strong> checks balance (100 tokens). Passes.
Calls Ledger. Pauses.</p></li>
<li><p><strong>Request B</strong> arrives. Request A is still paused
(balance is still 100). Request B checks balance. Passes. Calls
Ledger.</p></li>
<li><p>Both transfers succeed. The canister is drained.</p></li>
</ul>
<h3 id="the-solution-optimistic-accounting-vs.-locks">8.2 The Solution:
Optimistic Accounting vs. Locks</h3>
<p>To prevent this, state changes must happen <strong>before</strong>
the asynchronous call.</p>
<p><strong>Optimistic Accounting Pattern:</strong></p>
<ol type="1">
<li><p>Check Balance.</p></li>
<li><p><strong>Deduct Balance Immediately</strong>
(<code>balance := 0</code>).</p></li>
<li><p><code>await ledger.transfer(...)</code>.</p></li>
<li><p>If the transfer fails (returns <code>#Err</code>), <strong>Refund
the Balance</strong> (<code>balance += amount</code>).</p></li>
</ol>
<p>This ensures that any interleaved messages see the updated (zero)
balance.</p>
<p><strong>Code Example: Safe Withdrawal</strong></p>
<div class="sourceCode" id="cb120"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span> (msg) func <span class="fu">withdraw</span>(amount <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> user <span class="op">=</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> currentBal <span class="op">=</span> <span class="fu">getBalance</span>(user)<span class="op">;</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (currentBal <span class="op">&lt;</span> amount) <span class="cf">return</span> <span class="st">&quot;Insufficient Funds&quot;</span><span class="op">;</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. UPDATE STATE BEFORE AWAIT</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    balances<span class="op">.</span><span class="fu">put</span>(user<span class="op">,</span> currentBal <span class="op">-</span> amount)<span class="op">;</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. INTERACT WITH EXTERNAL ACTOR</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> ledger<span class="op">.</span><span class="fu">icrc1_transfer</span>(<span class="op">...</span>)<span class="op">;</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. HANDLE ROLLBACK IF NEEDED</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(result) {</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Ok</span>(_)) { <span class="cf">return</span> <span class="st">&quot;Success&quot;</span><span class="op">;</span> }<span class="op">;</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (#<span class="fu">Err</span>(_)) {</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Refund</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> newBal <span class="op">=</span> <span class="fu">getBalance</span>(user)<span class="op">;</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">.</span><span class="fu">put</span>(user<span class="op">,</span> newBal <span class="op">+</span> amount)<span class="op">;</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;Transfer failed, refunded.&quot;</span><span class="op">;</span></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="visualizing-the-await-gap">8.3 Visualizing the Await Gap</h3>
<p>It helps to treat every shared function as a <strong>three-phase
state machine</strong>:</p>
<ol type="1">
<li><strong>Pre-await</strong> – deterministic, single-threaded
execution.</li>
<li><strong>Await gap</strong> – execution is suspended, other messages
may mutate state.</li>
<li><strong>Post-await</strong> – resumes with whatever state now
exists.</li>
</ol>
<pre><code>User A calls withdraw ─┐
                       ├─ Phase 1: balance read, state updated
User B calls withdraw ─┘
                       ├─ Await gap: A is paused, B now runs
Ledger responds       ─┘
                       └─ Phase 3: A resumes with NEW state</code></pre>
<p>By explicitly labelling these phases in design docs, engineers
remember to ask <em>“What can happen while we are away?”</em>. That
question tends to surface hidden assumptions about uniqueness, ordering,
and double-spend resistance.</p>
<h3 id="guarding-with-pending-operations">8.4 Guarding with Pending
Operations</h3>
<p>Optimistic accounting works for simple subtraction, but larger
workflows need <strong>operation guards</strong>. Track every in-flight
withdrawal in a <code>pendingOps</code> map keyed by
<code>(user, nonce)</code>:</p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>type Pending <span class="op">=</span> {</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">amount</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">expiresAt</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>stable <span class="kw">var</span> pendingOps <span class="op">:</span> HashMap<span class="op">&lt;</span>(Principal<span class="op">,</span> Nat)<span class="op">,</span> Pending<span class="op">&gt;</span> <span class="op">=</span> <span class="op">...;</span></span></code></pre></div>
<ul>
<li><strong>Before the await</strong>: insert a record with an
expiration block height.</li>
<li><strong>On resume</strong>: remove the record only after the
external effect succeeds.</li>
<li><strong>On timeout</strong>: a cron or heartbeat can sweep expired
entries back into balances.</li>
</ul>
<p>This pattern prevents overlapping operations per user while still
allowing the canister to serve other principals.</p>
<h3 id="idempotent-external-calls">8.5 Idempotent External Calls</h3>
<p>Ledger calls are not guaranteed to be idempotent—network retries may
result in duplicates. Wrap every transfer payload in a deterministic
memo (e.g., hash of <code>(user, nonce, amount)</code>) so repeated
ledger executions can be detected downstream. On the Motoko side:</p>
<ol type="1">
<li>Persist the memo in stable state.</li>
<li>Verify the returned block’s memo matches.</li>
<li>If the await resumes with an error, re-issue the same memo instead
of minting a new one.</li>
</ol>
<p>Idempotency removes an entire class of “at-least-once” bugs that
otherwise leak funds when retries overlap with user-initiated calls.</p>
<h3 id="testing-for-reentrancy-bugs">8.6 Testing for Reentrancy
Bugs</h3>
<p>Reentrancy is hard to spot by inspection alone. Combine the following
techniques:</p>
<ul>
<li><strong>PocketIC / ic-repl scripts</strong>: send two
<code>withdraw</code> calls in quick succession and assert final
balances.</li>
<li><strong>Forced scheduling</strong>: use a mock ledger canister that
delays its response so you can deterministically interleave other calls
during the await gap.</li>
<li><strong>Property tests</strong>: model balances as integers and
prove “total supply never decreases” under arbitrary call
orderings.</li>
</ul>
<p>Automating these tests ensures future refactors (e.g., when changing
the storage layout) keep the same concurrency guarantees.</p>
<hr />
<hr />
<h2 id="chapter-9-external-integrations">Chapter 9: External
Integrations</h2>
<p>The Internet Computer is unique among blockchains in its ability to
interact directly with the outside world without relying on centralized
bridges or oracles. This capability, known as <strong>Chain Key
Cryptography</strong>, enables two revolutionary features: <strong>HTTP
Outcalls</strong> and <strong>Native Bitcoin Integration</strong>.</p>
<p>In this chapter, we will extend OpenPatron to interact with Web2 APIs
and the Bitcoin network, transforming it from an isolated silo into a
connected platform.</p>
<h3 id="http-outcalls">9.1 HTTP Outcalls</h3>
<p>Traditionally, blockchains are deterministic closed systems. They
cannot just “fetch a URL” because every node in the network must agree
on the result. If one node fetches a price of $100 and another fetches
$101, consensus fails.</p>
<p>The Internet Computer solves this with <strong>HTTP
Outcalls</strong>. When a canister makes an HTTP request: 1. The request
is sent by all nodes in the subnet. 2. The responses are collected and
<strong>consensus</strong> is reached on the result. 3. The canonical
response is returned to the canister.</p>
<h4 id="making-a-get-request">Making a GET Request</h4>
<p>Let’s add a feature to OpenPatron to verify a creator’s identity
using a Web2 API (e.g., checking a GitHub profile).</p>
<div class="sourceCode" id="cb123"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Blob</span> <span class="st">&quot;mo:base/Blob&quot;</span><span class="op">;</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Error</span> <span class="st">&quot;mo:base/Error&quot;</span><span class="op">;</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Import the Management Canister (virtual actor)</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> IC <span class="st">&quot;mo:base/ExperimentalInternetComputer&quot;</span><span class="op">;</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define the HTTP Header type</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>    type HttpHeader <span class="op">=</span> {</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">value</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define the HTTP Response type</span></span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>    type HttpResponse <span class="op">=</span> {</span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">status</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span> <span class="op">:</span> [HttpHeader]<span class="op">;</span></span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span> <span class="op">:</span> <span class="bu">Blob</span><span class="op">;</span></span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define the HTTP Request type</span></span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>    type HttpRequest <span class="op">=</span> {</span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">url</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">method</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span> <span class="co">// &quot;GET&quot;, &quot;POST&quot;, &quot;HEAD&quot;</span></span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">headers</span> <span class="op">:</span> [HttpHeader]<span class="op">;</span></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">body</span> <span class="op">:</span> <span class="op">?</span><span class="bu">Blob</span><span class="op">;</span></span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">transform</span> <span class="op">:</span> <span class="op">?</span>{</span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">function</span> <span class="op">:</span> shared <span class="fu">query</span> (HttpResponse) <span class="op">-&gt;</span> <span class="kw">async</span> HttpResponse<span class="op">;</span></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">context</span> <span class="op">:</span> <span class="bu">Blob</span><span class="op">;</span></span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">verifyGitHubProfile</span>(<span class="dt">username</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> url <span class="op">=</span> <span class="st">&quot;https://api.github.com/users/&quot;</span> # username<span class="op">;</span></span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb123-39"><a href="#cb123-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">request</span> <span class="op">:</span> HttpRequest <span class="op">=</span> {</span>
<span id="cb123-40"><a href="#cb123-40" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb123-41"><a href="#cb123-41" aria-hidden="true" tabindex="-1"></a>            method <span class="op">=</span> <span class="st">&quot;GET&quot;</span><span class="op">;</span></span>
<span id="cb123-42"><a href="#cb123-42" aria-hidden="true" tabindex="-1"></a>            headers <span class="op">=</span> [</span>
<span id="cb123-43"><a href="#cb123-43" aria-hidden="true" tabindex="-1"></a>                { name <span class="op">=</span> <span class="st">&quot;User-Agent&quot;</span><span class="op">;</span> value <span class="op">=</span> <span class="st">&quot;OpenPatron-Canister&quot;</span> }</span>
<span id="cb123-44"><a href="#cb123-44" aria-hidden="true" tabindex="-1"></a>            ]<span class="op">;</span></span>
<span id="cb123-45"><a href="#cb123-45" aria-hidden="true" tabindex="-1"></a>            body <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb123-46"><a href="#cb123-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transformation is crucial for consensus!</span></span>
<span id="cb123-47"><a href="#cb123-47" aria-hidden="true" tabindex="-1"></a>            transform <span class="op">=</span> <span class="op">?</span>{</span>
<span id="cb123-48"><a href="#cb123-48" aria-hidden="true" tabindex="-1"></a>                <span class="kw">function</span> <span class="op">=</span> transformResponse<span class="op">;</span></span>
<span id="cb123-49"><a href="#cb123-49" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="bu">Blob</span><span class="op">.</span><span class="fu">fromArray</span>([])<span class="op">;</span></span>
<span id="cb123-50"><a href="#cb123-50" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb123-51"><a href="#cb123-51" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb123-52"><a href="#cb123-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-53"><a href="#cb123-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> {</span>
<span id="cb123-54"><a href="#cb123-54" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 20 billion cycles is a safe baseline for HTTP outcalls</span></span>
<span id="cb123-55"><a href="#cb123-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> cycles <span class="op">=</span> <span class="dv">20_000_000_000</span><span class="op">;</span> </span>
<span id="cb123-56"><a href="#cb123-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="dt">response</span> <span class="op">:</span> HttpResponse <span class="op">=</span> <span class="cf">await</span> IC<span class="op">.</span><span class="fu">http_request</span>(request) <span class="cf">with</span> { cycles <span class="op">=</span> cycles }<span class="op">;</span></span>
<span id="cb123-57"><a href="#cb123-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb123-58"><a href="#cb123-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (response<span class="op">.</span><span class="at">status</span> <span class="op">==</span> <span class="dv">200</span>) {</span>
<span id="cb123-59"><a href="#cb123-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb123-60"><a href="#cb123-60" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb123-61"><a href="#cb123-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb123-62"><a href="#cb123-62" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb123-63"><a href="#cb123-63" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">catch</span> (e) {</span>
<span id="cb123-64"><a href="#cb123-64" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Error: &quot;</span> # <span class="bu">Error</span><span class="op">.</span><span class="fu">message</span>(e))<span class="op">;</span></span>
<span id="cb123-65"><a href="#cb123-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb123-66"><a href="#cb123-66" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb123-67"><a href="#cb123-67" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb123-68"><a href="#cb123-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-69"><a href="#cb123-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The transform function strips non-deterministic fields (like timestamps)</span></span>
<span id="cb123-70"><a href="#cb123-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// so nodes can reach consensus on the response.</span></span>
<span id="cb123-71"><a href="#cb123-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">transformResponse</span>(<span class="dt">raw</span> <span class="op">:</span> HttpResponse) <span class="op">:</span> <span class="kw">async</span> HttpResponse {</span>
<span id="cb123-72"><a href="#cb123-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb123-73"><a href="#cb123-73" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> raw<span class="op">.</span><span class="at">status</span><span class="op">;</span></span>
<span id="cb123-74"><a href="#cb123-74" aria-hidden="true" tabindex="-1"></a>            headers <span class="op">=</span> []<span class="op">;</span> <span class="co">// Headers often contain timestamps/nonces, so we drop them</span></span>
<span id="cb123-75"><a href="#cb123-75" aria-hidden="true" tabindex="-1"></a>            body <span class="op">=</span> raw<span class="op">.</span><span class="at">body</span><span class="op">;</span></span>
<span id="cb123-76"><a href="#cb123-76" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb123-77"><a href="#cb123-77" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb123-78"><a href="#cb123-78" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<blockquote>
<p>[!IMPORTANT] <strong>Consensus &amp; Idempotency</strong>: The
<code>transform</code> function is mandatory if the API response varies
slightly between nodes (e.g., timestamps). It sanitizes the response to
ensure bit-wise equality across replicas.</p>
</blockquote>
<h4 id="making-a-post-request-idempotency-keys">Making a POST Request
(Idempotency Keys)</h4>
<p>When sending data (POST), you must ensure the external server handles
duplicate requests gracefully, as multiple nodes may send the request.
Always use <strong>Idempotency Keys</strong>.</p>
<div class="sourceCode" id="cb124"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">sendNotification</span>(message <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> url <span class="op">=</span> <span class="st">&quot;https://api.webhook.site/...&quot;</span><span class="op">;</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Generate a unique key for this specific action</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> idempotencyKey <span class="op">=</span> <span class="st">&quot;req_&quot;</span> # Int<span class="op">.</span><span class="fu">toText</span>(Time<span class="op">.</span><span class="fu">now</span>())<span class="op">;</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">request</span> <span class="op">:</span> HttpRequest <span class="op">=</span> {</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> url<span class="op">;</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>            method <span class="op">=</span> <span class="st">&quot;POST&quot;</span><span class="op">;</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>            headers <span class="op">=</span> [</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>                { name <span class="op">=</span> <span class="st">&quot;Content-Type&quot;</span><span class="op">;</span> value <span class="op">=</span> <span class="st">&quot;application/json&quot;</span> }<span class="op">,</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>                { name <span class="op">=</span> <span class="st">&quot;Idempotency-Key&quot;</span><span class="op">;</span> value <span class="op">=</span> idempotencyKey }</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>            ]<span class="op">;</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>            body <span class="op">=</span> <span class="op">?</span><span class="bu">Text</span><span class="op">.</span><span class="fu">encodeUtf8</span>(<span class="st">&quot;{</span><span class="sc">\&quot;</span><span class="st">text</span><span class="sc">\&quot;</span><span class="st">: </span><span class="sc">\&quot;</span><span class="st">&quot;</span> # message # <span class="st">&quot;</span><span class="sc">\&quot;</span><span class="st">}&quot;</span>)<span class="op">;</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>            transform <span class="op">=</span> <span class="kw">null</span><span class="op">;</span> <span class="co">// POST usually returns simple confirmations</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... send request ...</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span></code></pre></div>
<h3 id="native-bitcoin-integration">9.2 Native Bitcoin Integration</h3>
<p>The Internet Computer integrates directly with the Bitcoin network.
Canisters can hold BTC addresses, receive funds, and sign transactions
without a private key (using <strong>Threshold ECDSA</strong>).</p>
<h4 id="the-bitcoin-api">The Bitcoin API</h4>
<p>The Management Canister exposes the Bitcoin API.</p>
<div class="sourceCode" id="cb125"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>    type BitcoinNetwork <span class="op">=</span> { #mainnet<span class="op">;</span> #testnet }<span class="op">;</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    type Satoshi <span class="op">=</span> Nat64<span class="op">;</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    type OutPoint <span class="op">=</span> {</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">txid</span> <span class="op">:</span> <span class="bu">Blob</span><span class="op">;</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">vout</span> <span class="op">:</span> Nat32<span class="op">;</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>    type Utxo <span class="op">=</span> {</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">outpoint</span> <span class="op">:</span> OutPoint<span class="op">;</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">value</span> <span class="op">:</span> Satoshi<span class="op">;</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">height</span> <span class="op">:</span> Nat32<span class="op">;</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Management Canister Interface for Bitcoin</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// (Simplified for brevity)</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> BITCOIN_API_FEE <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">10_000_000_000</span><span class="op">;</span> <span class="co">// Cycles</span></span></code></pre></div>
<h4 id="generating-a-bitcoin-address">Generating a Bitcoin Address</h4>
<p>Your canister can derive a Bitcoin address for itself (or for each
user).</p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">getBitcoinAddress</span>(userPrincipal <span class="op">:</span> Principal) <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Derive a unique path for the user</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> derivationPath <span class="op">=</span> [ <span class="bu">Blob</span><span class="op">.</span><span class="fu">toArray</span>(Principal<span class="op">.</span><span class="fu">toBlob</span>(userPrincipal)) ]<span class="op">;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> address <span class="op">=</span> <span class="cf">await</span> IC<span class="op">.</span><span class="fu">bitcoin_get_p2pkh_address</span>({</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>            network <span class="op">=</span> #testnet<span class="op">;</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>            derivation_path <span class="op">=</span> derivationPath<span class="op">;</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> address<span class="op">;</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span></code></pre></div>
<h4 id="sending-bitcoin">Sending Bitcoin</h4>
<p>Sending Bitcoin involves: 1. Getting the current balance/UTXOs. 2.
Building a transaction. 3. Signing it with Threshold ECDSA. 4.
Broadcasting it.</p>
<p>This is complex to implement manually. In production, use a library
like <code>motoko-bitcoin</code> or the <strong>ckBTC</strong> (Chain
Key Bitcoin) standard.</p>
<h3 id="ckbtc-the-practical-solution">9.3 ckBTC: The Practical
Solution</h3>
<p>While native Bitcoin integration is powerful, it is slow (Bitcoin
block times) and expensive (Bitcoin fees). <strong>ckBTC</strong> is an
ICRC-1 token on ICP that is 1:1 backed by real BTC.</p>
<p>For OpenPatron, we should use <strong>ckBTC</strong> for payments: 1.
<strong>Fast</strong>: 1-2 second finality. 2. <strong>Cheap</strong>:
Negligible fees. 3. <strong>Standard</strong>: Works with all ICRC-1
tools (like the Ledger code we wrote in Chapter 6).</p>
<p>Users can deposit real BTC to the ckBTC minter, which mints ckBTC to
their principal. OpenPatron then just handles it like any other
token.</p>
<h3 id="summary-1">9.4 Summary</h3>
<p>By leveraging HTTP Outcalls and Bitcoin integration, OpenPatron
becomes a “World Computer” application: - <strong>Verifiable</strong>:
Check Web2 identities via API. - <strong>Connected</strong>: Trigger
Web2 webhooks. - <strong>Financial</strong>: Accept the world’s hardest
money (BTC) directly or via ckBTC.</p>
<p>In the next chapter, we will solve the final piece of the puzzle: the
Frontend.</p>
<hr />
<hr />
<h2 id="chapter-10-frontend-integration-asset-storage">Chapter 10:
Frontend Integration &amp; Asset Storage</h2>
<p>A “Full-Stack” dapp on the Internet Computer is truly full-stack:
both the backend logic and the frontend assets (HTML, CSS, JS) are
hosted on-chain. This eliminates the need for AWS, Vercel, or Netlify,
making your application censorship-resistant and unstoppable.</p>
<h3 id="the-asset-canister">10.1 The Asset Canister</h3>
<p>The standard way to host a frontend is using the <strong>Asset
Canister</strong>. This is a pre-built canister provided by DFINITY that
is optimized for serving static files.</p>
<h4 id="configuration">Configuration</h4>
<p>In your <code>dfx.json</code>, you define a frontend canister:</p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;canisters&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;openpatron_backend&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;src/openpatron_backend/main.mo&quot;</span><span class="fu">,</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;motoko&quot;</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">},</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;openpatron_frontend&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;openpatron_backend&quot;</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;src/openpatron_frontend/dist&quot;</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>      <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;assets&quot;</span><span class="fu">,</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;workspace&quot;</span><span class="fu">:</span> <span class="st">&quot;openpatron_frontend&quot;</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>When you run <code>dfx deploy</code>, the SDK: 1. Builds your
frontend (e.g., <code>npm run build</code>). 2. Uploads the contents of
the <code>dist</code> folder to the Asset Canister. 3. Configures the
canister to serve <code>index.html</code> for unknown routes (SPA
routing).</p>
<h3 id="connecting-frontend-to-backend">10.2 Connecting Frontend to
Backend</h3>
<p>Your frontend needs to talk to your backend canister. The
<code>dfx</code> build process automatically generates <strong>Actor
Declarations</strong>—TypeScript bindings for your Motoko code.</p>
<h4 id="using-the-generated-declarations">Using the Generated
Declarations</h4>
<div class="sourceCode" id="cb128"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/openpatron_frontend/src/index.ts</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { openpatron_backend } <span class="im">from</span> <span class="st">&quot;../../declarations/openpatron_backend&quot;</span><span class="op">;</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">init</span>() {</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Call a public query function</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> profile <span class="op">=</span> <span class="cf">await</span> openpatron_backend<span class="op">.</span><span class="fu">getMyProfile</span>()<span class="op">;</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (profile<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;User is logged in:&quot;</span><span class="op">,</span> profile[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;User is anonymous&quot;</span>)<span class="op">;</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a><span class="fu">init</span>()<span class="op">;</span></span></code></pre></div>
<p>This type-safe bridge ensures that if you change your Motoko API,
your frontend build will fail until you update the client code.</p>
<h3 id="certified-variables-and-security">10.3 Certified Variables and
Security</h3>
<p>When you visit a website like <code>google.com</code>, your browser
checks the TLS certificate to ensure the server is authentic. On the
Internet Computer, we don’t rely on a central Certificate Authority
(CA). Instead, we use <strong>Chain Key Cryptography</strong>.</p>
<h4 id="how-it-works">How it Works</h4>
<ol type="1">
<li><strong>Certification</strong>: The subnet signs the root hash of
the canister’s state tree.</li>
<li><strong>Service Worker</strong>: When you load a canister URL
(<code>https://&lt;canister-id&gt;.ic0.app</code>), a Service Worker is
installed in your browser.</li>
<li><strong>Verification</strong>: The Service Worker intercepts network
requests, fetches the content <em>and</em> a certificate (merkle proof).
It verifies the signature against the subnet’s public key.</li>
</ol>
<p>If the verification fails, the Service Worker rejects the content.
This guarantees that the frontend you see is exactly what the canister
served, preventing “Man-in-the-Middle” attacks.</p>
<h4 id="certified-assets">Certified Assets</h4>
<p>The standard Asset Canister handles this automatically. Every file
uploaded is hashed and added to the certified state tree.</p>
<h4 id="certified-data-in-motoko">Certified Data in Motoko</h4>
<p>If you want to serve dynamic data securely (e.g., an API endpoint),
you must manually certify it using <code>CertifiedData</code>.</p>
<div class="sourceCode" id="cb129"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> CertifiedData <span class="st">&quot;mo:base/CertifiedData&quot;</span><span class="op">;</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Blob</span> <span class="st">&quot;mo:base/Blob&quot;</span><span class="op">;</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. Store data</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">myData</span> <span class="op">:</span> <span class="bu">Blob</span> <span class="op">=</span> <span class="bu">Blob</span><span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;Hello Secure World&quot;</span>)<span class="op">;</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. Update the certificate when data changes</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">updateData</span>(<span class="dt">newData</span> <span class="op">:</span> <span class="bu">Text</span>) {</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">myData</span> <span class="op">:=</span> <span class="bu">Blob</span><span class="op">.</span><span class="fu">fromText</span>(newData)<span class="op">;</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set the certified data (32-byte hash)</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>        CertifiedData<span class="op">.</span><span class="fu">set</span>(<span class="fu">sha256</span>(myData))<span class="op">;</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. Serve the data with the certificate</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// (Usually done via http_request, not a query call)</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="custom-domains">10.4 Custom Domains</h3>
<p>While <code>ic0.app</code> domains are functional, production apps
need custom domains (e.g., <code>openpatron.com</code>).</p>
<ol type="1">
<li><strong>Register Domain</strong>: Buy your domain.</li>
<li><strong>Configure DNS</strong>: Add a CNAME record pointing to the
Internet Computer boundary nodes.</li>
<li><strong>Add Domain to Canister</strong>: Use the
<code>ic-asset</code> tool or a <code>boundary_nodes</code>
configuration file to map the domain to your canister.</li>
</ol>
<p>This process ensures that even with a custom domain, the Service
Worker verification still protects your users.</p>
<h3 id="summary-2">10.5 Summary</h3>
<p>With the frontend deployed to an Asset Canister, OpenPatron is now a
complete <strong>dapp</strong>: - <strong>Backend</strong>: Motoko
canister handling logic, data, and money. - <strong>Frontend</strong>:
React/Vue/Svelte app served from an Asset Canister. -
<strong>Security</strong>: End-to-end verification via Certified
Variables.</p>
<p>We have built the application. Now, we must look at the ecosystem
tools that will help us maintain and scale it.</p>
<hr />
<hr />
<h1 id="chapter-11-ecosystem-tools-and-testing">Chapter 11: Ecosystem
Tools and Testing</h1>
<p>Professional engineering requires rigorous testing and dependency
management. The Motoko ecosystem has matured significantly, offering
sophisticated tools for package management, testing, debugging, and
continuous integration. This chapter explores the essential tools that
transform Motoko development from experimental scripts into
production-grade systems.</p>
<h3 id="dependency-management-with-mops">9.1 Dependency Management with
Mops</h3>
<p>Early Motoko development relied on <code>vessel</code>, but the
ecosystem has migrated to <strong>Mops</strong> (Motoko Package
Manager). Mops creates a standard for publishing and importing community
libraries (like <code>encoding</code>, <code>test</code>, or data
structures).</p>
<h4 id="getting-started-with-mops">9.1.1 Getting Started with Mops</h4>
<p><strong>Initial Setup:</strong></p>
<div class="sourceCode" id="cb130"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Mops globally</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-g</span> ic-mops</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize Mops in your project</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> init</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add dependencies</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> add base</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> add sha256</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> add map</span></code></pre></div>
<p>This generates a <code>mops.toml</code> configuration file:</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="dt">base</span> <span class="op">=</span> <span class="st">&quot;0.11.1&quot;</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="dt">sha256</span> <span class="op">=</span> <span class="st">&quot;1.0.1&quot;</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="dt">map</span> <span class="op">=</span> <span class="st">&quot;9.0.1&quot;</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[toolchain]</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="dt">moc</span> <span class="op">=</span> <span class="st">&quot;0.11.1&quot;</span></span></code></pre></div>
<h4 id="using-dependencies-in-code">9.1.2 Using Dependencies in
Code</h4>
<p>Once dependencies are installed, import them using the
<code>mo:</code> prefix:</p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> SHA256 <span class="st">&quot;mo:sha256&quot;</span><span class="op">;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Map</span> <span class="st">&quot;mo:map/Map&quot;</span><span class="op">;</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { nhash } <span class="st">&quot;mo:map&quot;</span><span class="op">;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>  type <span class="bu">Map</span><span class="op">&lt;</span>K<span class="op">,</span> V<span class="op">&gt;</span> <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="at">Map</span><span class="op">&lt;</span>K<span class="op">,</span> V<span class="op">&gt;;</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>  stable <span class="kw">var</span> <span class="dt">subscriptions</span> <span class="op">:</span> <span class="bu">Map</span><span class="op">&lt;</span>Principal<span class="op">,</span> Nat64<span class="op">&gt;</span> <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">new</span>()<span class="op">;</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> func <span class="fu">hashPassword</span>(<span class="dt">password</span> <span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> <span class="bu">Blob</span> {</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    SHA256<span class="op">.</span><span class="fu">fromText</span>(password)</span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="publishing-your-own-package">9.1.3 Publishing Your Own
Package</h4>
<p>Mops makes it easy to share reusable code with the community:</p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create package metadata</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> init <span class="at">--name</span> my-library <span class="at">--version</span> 1.0.0</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add package description</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> config set description <span class="st">&quot;My awesome Motoko library&quot;</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> config set repository <span class="st">&quot;https://github.com/username/my-library&quot;</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Publish to Mops registry</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a><span class="ex">mops</span> publish</span></code></pre></div>
<p><strong>Best Practices:</strong> - <strong>Semantic
Versioning</strong>: Follow semver (1.0.0 → 1.0.1 for patches, 1.1.0 for
features, 2.0.0 for breaking changes) - <strong>Documentation</strong>:
Include README.md with usage examples - <strong>Type Safety</strong>:
Export well-typed public interfaces - <strong>Testing</strong>: Include
test files demonstrating correct usage</p>
<h4 id="version-pinning-and-reproducibility">9.1.4 Version Pinning and
Reproducibility</h4>
<p>Mops generates a <code>mops.lock</code> file to ensure deterministic
builds:</p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mops.lock</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[[packages]]</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;base&quot;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;0.11.1&quot;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="dt">hash</span> <span class="op">=</span> <span class="st">&quot;sha256:a1b2c3d4...&quot;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="kw">[[packages]]</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;sha256&quot;</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;1.0.1&quot;</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="dt">hash</span> <span class="op">=</span> <span class="st">&quot;sha256:e5f6g7h8...&quot;</span></span></code></pre></div>
<p><strong>Always commit <code>mops.lock</code> to version
control</strong> to ensure all team members and CI/CD pipelines use
identical dependencies.</p>
<h3 id="testing-strategies">9.2 Testing Strategies</h3>
<p>Testing on the Internet Computer requires different approaches than
traditional web development. Canisters are stateful, asynchronous, and
interact with other canisters, requiring sophisticated testing
strategies.</p>
<h4 id="unit-testing-pure-functions">9.2.1 Unit Testing Pure
Functions</h4>
<p>For pure Motoko functions (no state, no async), use the built-in
<code>Debug.print</code> for simple assertions:</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>module {</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> func <span class="fu">calculateFee</span>(<span class="dt">amount</span> <span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    amount <span class="op">*</span> <span class="dv">5</span> <span class="op">/</span> <span class="dv">100</span>  <span class="co">// 5% fee</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Simple test</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> func <span class="fu">testCalculateFee</span>() {</span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> <span class="fu">calculateFee</span>(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assert</span>(result <span class="op">==</span> <span class="dv">50</span>)<span class="op">;</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;✓ calculateFee test passed&quot;</span>)<span class="op">;</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>For more sophisticated unit testing, use the
<code>motoko-matchers</code> library:</p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Suite <span class="st">&quot;mo:matchers/Suite&quot;</span><span class="op">;</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> T <span class="st">&quot;mo:matchers/Testable&quot;</span><span class="op">;</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> M <span class="st">&quot;mo:matchers/Matchers&quot;</span><span class="op">;</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> suite <span class="op">=</span> Suite<span class="op">.</span><span class="fu">suite</span>(<span class="st">&quot;Fee Calculation Tests&quot;</span><span class="op">,</span> [</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  Suite<span class="op">.</span><span class="fu">test</span>(<span class="st">&quot;calculates 5% fee correctly&quot;</span><span class="op">,</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateFee</span>(<span class="dv">1000</span>)<span class="op">,</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>    M<span class="op">.</span><span class="fu">equals</span>(T<span class="op">.</span><span class="fu">nat</span>(<span class="dv">50</span>))</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  Suite<span class="op">.</span><span class="fu">test</span>(<span class="st">&quot;handles zero amount&quot;</span><span class="op">,</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateFee</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>    M<span class="op">.</span><span class="fu">equals</span>(T<span class="op">.</span><span class="fu">nat</span>(<span class="dv">0</span>))</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>  Suite<span class="op">.</span><span class="fu">test</span>(<span class="st">&quot;rounds down for odd amounts&quot;</span><span class="op">,</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateFee</span>(<span class="dv">999</span>)<span class="op">,</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>    M<span class="op">.</span><span class="fu">equals</span>(T<span class="op">.</span><span class="fu">nat</span>(<span class="dv">49</span>))</span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>Suite<span class="op">.</span><span class="fu">run</span>(suite)<span class="op">;</span></span></code></pre></div>
<h4 id="testing-actor-methods">9.2.2 Testing Actor Methods</h4>
<p>Testing actor methods requires a different approach since they’re
asynchronous and maintain state. Use <code>dfx</code> to deploy
locally:</p>
<div class="sourceCode" id="cb137"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start local replica</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> start <span class="at">--clean</span> <span class="at">--background</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy canister</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy my_canister</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Test via dfx command line</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister call my_canister deposit <span class="st">&#39;(100 : nat64)&#39;</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister call my_canister getBalance <span class="st">&#39;()&#39;</span></span></code></pre></div>
<h3 id="integration-testing-with-pocketic">9.3 Integration Testing with
PocketIC</h3>
<p>Unit testing Motoko functions is useful, but integration testing
involving multiple canisters (OpenPatron + Ledger + Internet Identity)
is critical.</p>
<p><strong>PocketIC</strong> is the industry-standard testing framework.
It allows developers to write tests in Python or Rust that spin up a
lightweight, deterministic instance of the Internet Computer. Unlike a
full local replica, PocketIC allows for <strong>Time Travel</strong>
(advancing the clock to test subscriptions) and inspecting the raw state
of canisters.</p>
<h4 id="setting-up-pocketic">9.3.1 Setting Up PocketIC</h4>
<p><strong>Python Setup:</strong></p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install pocket-ic</span></code></pre></div>
<p><strong>Rust Setup:</strong></p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargo.toml</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[dev-dependencies]</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pocket-ic</span> <span class="op">=</span> <span class="st">&quot;3.0.0&quot;</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="dt">candid</span> <span class="op">=</span> <span class="st">&quot;0.10&quot;</span></span></code></pre></div>
<h4 id="basic-pocketic-test-python">9.3.2 Basic PocketIC Test
(Python)</h4>
<div class="sourceCode" id="cb140"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pocket_ic <span class="im">import</span> PocketIC</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_deposit_and_withdrawal():</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create IC instance</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    pic <span class="op">=</span> PocketIC()</span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deploy OpenPatron canister</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>    canister_id <span class="op">=</span> pic.create_canister()</span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    pic.install_code(</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>        canister_id,</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>        wasm_path<span class="op">=</span><span class="st">&quot;./target/wasm32-unknown-unknown/release/openpatron.wasm&quot;</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create test user</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>    user_principal <span class="op">=</span> pic.create_principal(<span class="st">&quot;user_a&quot;</span>)</span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test deposit</span></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pic.update_call(</span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>        canister_id,</span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>        user_principal,</span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;deposit&quot;</span>,</span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>        encode([{<span class="st">&quot;amount&quot;</span>: <span class="dv">100</span>}])</span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> result[<span class="st">&quot;status&quot;</span>] <span class="op">==</span> <span class="st">&quot;success&quot;</span></span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-26"><a href="#cb140-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify balance</span></span>
<span id="cb140-27"><a href="#cb140-27" aria-hidden="true" tabindex="-1"></a>    balance <span class="op">=</span> pic.query_call(</span>
<span id="cb140-28"><a href="#cb140-28" aria-hidden="true" tabindex="-1"></a>        canister_id,</span>
<span id="cb140-29"><a href="#cb140-29" aria-hidden="true" tabindex="-1"></a>        user_principal,</span>
<span id="cb140-30"><a href="#cb140-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;getBalance&quot;</span>,</span>
<span id="cb140-31"><a href="#cb140-31" aria-hidden="true" tabindex="-1"></a>        encode([])</span>
<span id="cb140-32"><a href="#cb140-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb140-33"><a href="#cb140-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> balance <span class="op">==</span> <span class="dv">100</span></span>
<span id="cb140-34"><a href="#cb140-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-35"><a href="#cb140-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test withdrawal</span></span>
<span id="cb140-36"><a href="#cb140-36" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pic.update_call(</span>
<span id="cb140-37"><a href="#cb140-37" aria-hidden="true" tabindex="-1"></a>        canister_id,</span>
<span id="cb140-38"><a href="#cb140-38" aria-hidden="true" tabindex="-1"></a>        user_principal,</span>
<span id="cb140-39"><a href="#cb140-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;withdraw&quot;</span>,</span>
<span id="cb140-40"><a href="#cb140-40" aria-hidden="true" tabindex="-1"></a>        encode([{<span class="st">&quot;amount&quot;</span>: <span class="dv">50</span>}])</span>
<span id="cb140-41"><a href="#cb140-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb140-42"><a href="#cb140-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> result[<span class="st">&quot;status&quot;</span>] <span class="op">==</span> <span class="st">&quot;success&quot;</span></span>
<span id="cb140-43"><a href="#cb140-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-44"><a href="#cb140-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify final balance</span></span>
<span id="cb140-45"><a href="#cb140-45" aria-hidden="true" tabindex="-1"></a>    balance <span class="op">=</span> pic.query_call(canister_id, user_principal, <span class="st">&quot;getBalance&quot;</span>, encode([]))</span>
<span id="cb140-46"><a href="#cb140-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> balance <span class="op">==</span> <span class="dv">50</span></span></code></pre></div>
<h4 id="time-travel-testing">9.3.3 Time Travel Testing</h4>
<p><strong>Example PocketIC Scenario with Time Travel:</strong></p>
<div class="sourceCode" id="cb141"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pocket_ic <span class="im">import</span> PocketIC</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_subscription_payment():</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    pic <span class="op">=</span> PocketIC()</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Instantiate OpenPatron Canister</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    openpatron_id <span class="op">=</span> pic.create_canister()</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>    pic.install_code(openpatron_id, wasm_path<span class="op">=</span><span class="st">&quot;openpatron.wasm&quot;</span>)</span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Instantiate Ledger Canister</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>    ledger_id <span class="op">=</span> pic.create_canister()</span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>    pic.install_code(ledger_id, wasm_path<span class="op">=</span><span class="st">&quot;ledger.wasm&quot;</span>)</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Mint 100 tokens to User A</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>    user_a <span class="op">=</span> pic.create_principal(<span class="st">&quot;alice&quot;</span>)</span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>    pic.update_call(ledger_id, pic.admin_principal(), <span class="st">&quot;mint&quot;</span>, </span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>                    encode([{<span class="st">&quot;to&quot;</span>: user_a, <span class="st">&quot;amount&quot;</span>: <span class="dv">100_000_000</span>}]))</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. User A calls deposit on OpenPatron</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>    pic.update_call(openpatron_id, user_a, <span class="st">&quot;deposit&quot;</span>,</span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>                   encode([{<span class="st">&quot;amount&quot;</span>: <span class="dv">100_000_000</span>}]))</span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. User A subscribes to Creator B</span></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>    creator_b <span class="op">=</span> pic.create_principal(<span class="st">&quot;bob&quot;</span>)</span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a>    pic.update_call(openpatron_id, user_a, <span class="st">&quot;subscribe&quot;</span>,</span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>                   encode([{<span class="st">&quot;creator&quot;</span>: creator_b, <span class="st">&quot;amount&quot;</span>: <span class="dv">10_000_000</span>}]))</span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. **Advance time by 31 days** (Crucial step impossible in standard unit tests)</span></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>    pic.advance_time_seconds(<span class="dv">31</span> <span class="op">*</span> <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trigger heartbeat/timer to process subscriptions</span></span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a>    pic.tick()</span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 7. Assert that OpenPatron triggered the subscription payment automatically</span></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a>    creator_balance <span class="op">=</span> pic.query_call(openpatron_id, creator_b, <span class="st">&quot;getBalance&quot;</span>, encode([]))</span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> creator_balance <span class="op">==</span> <span class="dv">10_000_000</span>, <span class="st">&quot;Subscription payment should have been processed&quot;</span></span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a>    user_balance <span class="op">=</span> pic.query_call(openpatron_id, user_a, <span class="st">&quot;getBalance&quot;</span>, encode([]))</span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> user_balance <span class="op">==</span> <span class="dv">90_000_000</span>, <span class="st">&quot;User balance should be reduced by subscription amount&quot;</span></span></code></pre></div>
<h4 id="multi-canister-testing">9.3.4 Multi-Canister Testing</h4>
<p>Testing inter-canister calls is where PocketIC shines:</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_ledger_integration():</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    pic <span class="op">=</span> PocketIC()</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deploy multiple canisters</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    ledger <span class="op">=</span> pic.create_and_install(<span class="st">&quot;ledger.wasm&quot;</span>)</span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    openpatron <span class="op">=</span> pic.create_and_install(<span class="st">&quot;openpatron.wasm&quot;</span>)</span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configure OpenPatron to use Ledger</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    pic.update_call(openpatron, pic.admin_principal(), <span class="st">&quot;setLedgerId&quot;</span>, </span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>                    encode([{<span class="st">&quot;ledger&quot;</span>: ledger}]))</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># User deposits via Ledger</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> pic.create_principal(<span class="st">&quot;user&quot;</span>)</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Approve OpenPatron to spend tokens</span></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>    pic.update_call(ledger, user, <span class="st">&quot;icrc2_approve&quot;</span>, encode([{</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;spender&quot;</span>: openpatron,</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;amount&quot;</span>: <span class="dv">1_000_000</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>    }]))</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OpenPatron pulls tokens from Ledger</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pic.update_call(openpatron, user, <span class="st">&quot;depositFromLedger&quot;</span>, </span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>                             encode([{<span class="st">&quot;amount&quot;</span>: <span class="dv">1_000_000</span>}]))</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> result[<span class="st">&quot;success&quot;</span>] <span class="op">==</span> <span class="va">True</span></span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verify internal balance matches</span></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>    balance <span class="op">=</span> pic.query_call(openpatron, user, <span class="st">&quot;getBalance&quot;</span>, encode([]))</span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> balance <span class="op">==</span> <span class="dv">1_000_000</span></span></code></pre></div>
<h3 id="property-based-testing">9.4 Property-Based Testing</h3>
<p>Property-based testing generates random inputs to verify that certain
properties always hold:</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hypothesis <span class="im">import</span> given, strategies <span class="im">as</span> st</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pocket_ic <span class="im">import</span> PocketIC</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="at">@given</span>(</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    amount<span class="op">=</span>st.integers(min_value<span class="op">=</span><span class="dv">1</span>, max_value<span class="op">=</span><span class="dv">1_000_000_000</span>),</span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>    fee_percentage<span class="op">=</span>st.integers(min_value<span class="op">=</span><span class="dv">0</span>, max_value<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_fee_calculation_properties(amount, fee_percentage):</span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Test that fee calculation always produces valid results&quot;&quot;&quot;</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>    pic <span class="op">=</span> PocketIC()</span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>    canister <span class="op">=</span> pic.create_and_install(<span class="st">&quot;fee_calculator.wasm&quot;</span>)</span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pic.query_call(canister, pic.admin_principal(), </span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;calculateFee&quot;</span>, encode([{</span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;amount&quot;</span>: amount,</span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;feePercentage&quot;</span>: fee_percentage</span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a>                           }]))</span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>    fee <span class="op">=</span> decode(result)[<span class="st">&quot;fee&quot;</span>]</span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Property 1: Fee should never exceed amount</span></span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> fee <span class="op">&lt;=</span> amount</span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Property 2: Fee should be non-negative</span></span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> fee <span class="op">&gt;=</span> <span class="dv">0</span></span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Property 3: Fee should match expected calculation</span></span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>    expected_fee <span class="op">=</span> (amount <span class="op">*</span> fee_percentage) <span class="op">//</span> <span class="dv">100</span></span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> fee <span class="op">==</span> expected_fee</span></code></pre></div>
<h3 id="debugging-techniques">9.5 Debugging Techniques</h3>
<h4 id="debug.print-for-runtime-inspection">9.5.1 Debug.print for
Runtime Inspection</h4>
<div class="sourceCode" id="cb144"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> func <span class="fu">processPayment</span>(<span class="dt">amount</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Processing payment for amount: &quot;</span> # <span class="fu">debug_show</span>(amount))<span class="op">;</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (amount <span class="op">&lt;</span> <span class="dv">100</span>) {</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>      Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;⚠️  Payment amount too small&quot;</span>)<span class="op">;</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;✓ Payment processed successfully&quot;</span>)<span class="op">;</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">true</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Run with <code>dfx deploy</code> and view output in the terminal.</p>
<h4 id="canister-profiling">9.5.2 Canister Profiling</h4>
<p>Monitor canister performance:</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check canister status</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister status my_canister</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Output:</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Canister status: Running</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory allocation: 0</span></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory size: 1_234_567</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Cycles: 3_500_000_000_000</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Module hash: 0xabcd...</span></span></code></pre></div>
<h4 id="state-inspection">9.5.3 State Inspection</h4>
<p>PocketIC allows direct state inspection:</p>
<div class="sourceCode" id="cb146"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_inspect_canister_state():</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    pic <span class="op">=</span> PocketIC()</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    canister <span class="op">=</span> pic.create_and_install(<span class="st">&quot;my_canister.wasm&quot;</span>)</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform some operations</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    pic.update_call(canister, user, <span class="st">&quot;addItem&quot;</span>, encode([{<span class="st">&quot;item&quot;</span>: <span class="st">&quot;test&quot;</span>}]))</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inspect stable memory directly</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>    stable_memory <span class="op">=</span> pic.get_stable_memory(canister)</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Stable memory size: </span><span class="sc">{</span><span class="bu">len</span>(stable_memory)<span class="sc">}</span><span class="ss"> bytes&quot;</span>)</span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get canister cycles balance</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>    cycles <span class="op">=</span> pic.get_cycle_balance(canister)</span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> cycles <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">&quot;Canister should have cycles&quot;</span></span></code></pre></div>
<h3 id="continuous-integration">9.6 Continuous Integration</h3>
<p>Integrate PocketIC tests into CI/CD pipelines:</p>
<p><strong>GitHub Actions Example:</strong></p>
<div class="sourceCode" id="cb147"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Motoko Tests</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">,</span><span class="at"> pull_request</span><span class="kw">]</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install DFX</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>          sh -ci &quot;$(curl -fsSL https://internetcomputer.org/install.sh)&quot;</span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>          echo &quot;$HOME/.local/bin&quot; &gt;&gt; $GITHUB_PATH</span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install Mops</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> npm install -g ic-mops</span></span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install Dependencies</span></span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> mops install</span></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build Canisters</span></span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> dfx build</span></span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install Python Dependencies</span></span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a>          pip install pocket-ic pytest</span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run Tests</span></span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> pytest tests/</span></span></code></pre></div>
<h3 id="best-practices-1">9.7 Best Practices</h3>
<ol type="1">
<li><strong>Test Pyramid</strong>: Write many unit tests, fewer
integration tests, and even fewer end-to-end tests</li>
<li><strong>Deterministic Tests</strong>: Avoid flaky tests by using
PocketIC’s controlled environment</li>
<li><strong>Test Coverage</strong>: Aim for &gt;80% code coverage for
critical paths</li>
<li><strong>Fast Feedback</strong>: Keep unit tests fast (&lt;1s),
integration tests moderate (&lt;30s)</li>
<li><strong>Realistic Data</strong>: Use production-like data in tests
to catch edge cases</li>
<li><strong>Upgrade Testing</strong>: Test canister upgrades to verify
stable variables persist correctly</li>
</ol>
<div class="sourceCode" id="cb148"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>  stable <span class="kw">var</span> <span class="dt">version</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>  stable <span class="kw">var</span> <span class="dt">data</span> <span class="op">:</span> [Nat] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>  system func <span class="fu">preupgrade</span>() {</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Preparing for upgrade, version: &quot;</span> # <span class="fu">debug_show</span>(version))<span class="op">;</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>  system func <span class="fu">postupgrade</span>() {</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>    version <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Upgraded to version: &quot;</span> # <span class="fu">debug_show</span>(version))<span class="op">;</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assert</span>(data<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">;</span>  <span class="co">// Verify data persisted</span></span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="performance-testing">9.8 Performance Testing</h3>
<p>Load testing ensures your canister handles production traffic:</p>
<div class="sourceCode" id="cb149"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> concurrent.futures</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pocket_ic <span class="im">import</span> PocketIC</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stress_test_concurrent_calls():</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>    pic <span class="op">=</span> PocketIC()</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    canister <span class="op">=</span> pic.create_and_install(<span class="st">&quot;my_canister.wasm&quot;</span>)</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> make_call(i):</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> pic.create_principal(<span class="ss">f&quot;user_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pic.update_call(canister, user, <span class="st">&quot;processRequest&quot;</span>, </span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>                              encode([{<span class="st">&quot;data&quot;</span>: <span class="ss">f&quot;request_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&quot;</span>}]))</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute 100 concurrent calls</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> concurrent.futures.ThreadPoolExecutor(max_workers<span class="op">=</span><span class="dv">100</span>) <span class="im">as</span> executor:</span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>        futures <span class="op">=</span> [executor.submit(make_call, i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>)]</span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> [f.result() <span class="cf">for</span> f <span class="kw">in</span> futures]</span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># All calls should succeed</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">all</span>(r[<span class="st">&quot;success&quot;</span>] <span class="cf">for</span> r <span class="kw">in</span> results)</span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check canister didn&#39;t run out of cycles</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>    cycles <span class="op">=</span> pic.get_cycle_balance(canister)</span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> cycles <span class="op">&gt;</span> <span class="dv">1_000_000_000</span>, <span class="st">&quot;Canister running low on cycles&quot;</span></span></code></pre></div>
<hr />
<p>The combination of Mops for dependency management, PocketIC for
integration testing, and proper CI/CD pipelines transforms Motoko
development into a professional engineering discipline. These tools
enable developers to ship complex, multi-canister systems with
confidence.</p>
<hr />
<hr />
<h1 id="chapter-12-the-economics-of-deployment">Chapter 12: The
Economics of Deployment</h1>
<p>Deploying to the mainnet requires a fundamental shift in economic
thinking. Unlike traditional blockchain platforms where users pay gas
fees for every transaction, the Internet Computer utilizes a
revolutionary “Reverse Gas Model.” In this paradigm, users do not pay
gas to interact with OpenPatron; instead, the OpenPatron canister itself
pays for its own computation and storage.</p>
<p>This model creates a Web2-like user experience—users can interact
with dapps without needing tokens in their wallet—but introduces new
challenges for developers. You must now think like a product owner,
ensuring your canister has sufficient resources to operate
sustainably.</p>
<h3 id="understanding-cycles-the-fuel-of-the-internet-computer">10.1
Understanding Cycles: The Fuel of the Internet Computer</h3>
<p>The fuel for canisters is <strong>Cycles</strong>. Unlike volatile
cryptocurrencies, cycles are designed to be stable in real-world
cost:</p>
<ul>
<li><p><strong>1 Trillion Cycles ≈ 1 SDR (Special Drawing Rights) ≈
$1.30 USD</strong></p></li>
<li><p><strong>SDR Peg:</strong> The SDR is an international reserve
asset created by the IMF, providing stability against currency
fluctuations.</p></li>
</ul>
<h4 id="cost-breakdown">Cost Breakdown</h4>
<p>Understanding the cost structure is essential for sustainable
deployment:</p>
<p><strong>Storage Costs:</strong> - <strong>1 GB of data
storage:</strong> ~4.2 billion cycles per day (~127 billion cycles per
month) - <strong>Example:</strong> Storing user profiles, subscription
data, and metadata for 10,000 users (≈100 MB) costs ~420 million cycles
per day</p>
<p><strong>Computation Costs:</strong> - <strong>Ingress
messages:</strong> Based on instruction count (typically 5-100 million
cycles per call) - <strong>Consensus:</strong> Update calls that modify
state are more expensive than query calls - <strong>Cross-canister
calls:</strong> Additional overhead for inter-canister communication</p>
<p><strong>HTTP Outcalls:</strong> - <strong>Per request:</strong> 49
million cycles for the base cost + data transfer costs - <strong>Use
case:</strong> Fetching external data like token prices or off-chain
verification</p>
<h4 id="monitoring-cycle-balance">Monitoring Cycle Balance</h4>
<p>Your canister must actively monitor its cycle balance to avoid
running out of fuel:</p>
<div class="sourceCode" id="cb150"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Cycles <span class="st">&quot;mo:base/ExperimentalCycles&quot;</span><span class="op">;</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Minimum threshold to trigger refill alert</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">MINIMUM_CYCLES</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">1_000_000_000_000</span><span class="op">;</span> <span class="co">// 1 Trillion cycles</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check canister cycle balance</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getCycleBalance</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Cycles<span class="op">.</span><span class="fu">balance</span>()<span class="op">;</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Alert if balance is low</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">checkHealth</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> balance <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">balance</span>()<span class="op">;</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (balance <span class="op">&lt;</span> MINIMUM_CYCLES) {</span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;⚠️ WARNING: Low cycle balance. Refill needed!&quot;</span><span class="op">;</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;✅ Healthy: &quot;</span> # <span class="fu">debug_show</span>(balance) # <span class="st">&quot; cycles remaining&quot;</span><span class="op">;</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Accept cycles when receiving top-ups</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">acceptCycles</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> available <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">available</span>()<span class="op">;</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accepted <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">accept</span>(available)<span class="op">;</span></span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Accepted &quot;</span> # <span class="fu">debug_show</span>(accepted) # <span class="st">&quot; cycles&quot;</span>)<span class="op">;</span></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> accepted<span class="op">;</span></span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="building-a-sustainable-economic-model">10.2 Building a
Sustainable Economic Model</h3>
<p>OpenPatron cannot operate for free forever. The canister must
generate revenue to sustain itself. Here’s a comprehensive
sustainability strategy:</p>
<h4 id="the-tax-model">The Tax Model</h4>
<p>Implement a small platform fee on each transaction:</p>
<div class="sourceCode" id="cb151"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Result <span class="st">&quot;mo:base/Result&quot;</span><span class="op">;</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Nat <span class="st">&quot;mo:base/Nat&quot;</span><span class="op">;</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Platform fee: 1% of each subscription</span></span>
<span id="cb151-7"><a href="#cb151-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">PLATFORM_FEE_PERCENT</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb151-8"><a href="#cb151-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> stable <span class="kw">var</span> <span class="dt">treasuryBalance</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb151-9"><a href="#cb151-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-10"><a href="#cb151-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process subscription payment with automatic fee deduction</span></span>
<span id="cb151-11"><a href="#cb151-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">processSubscription</span>(</span>
<span id="cb151-12"><a href="#cb151-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">creatorId</span> <span class="op">:</span> Principal<span class="op">,</span></span>
<span id="cb151-13"><a href="#cb151-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">amount</span> <span class="op">:</span> Nat</span>
<span id="cb151-14"><a href="#cb151-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb151-15"><a href="#cb151-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-16"><a href="#cb151-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate fee and creator payment</span></span>
<span id="cb151-17"><a href="#cb151-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> platformFee <span class="op">=</span> (amount <span class="op">*</span> PLATFORM_FEE_PERCENT) <span class="op">/</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb151-18"><a href="#cb151-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> creatorPayment <span class="op">=</span> amount <span class="op">-</span> platformFee<span class="op">;</span></span>
<span id="cb151-19"><a href="#cb151-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-20"><a href="#cb151-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add to treasury</span></span>
<span id="cb151-21"><a href="#cb151-21" aria-hidden="true" tabindex="-1"></a>        treasuryBalance <span class="op">+=</span> platformFee<span class="op">;</span></span>
<span id="cb151-22"><a href="#cb151-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-23"><a href="#cb151-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Transfer to creator (simplified for example)</span></span>
<span id="cb151-24"><a href="#cb151-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// In production, use ICRC-1 transfer</span></span>
<span id="cb151-25"><a href="#cb151-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// await transferToCreator(creatorId, creatorPayment);</span></span>
<span id="cb151-26"><a href="#cb151-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb151-27"><a href="#cb151-27" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>()</span>
<span id="cb151-28"><a href="#cb151-28" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb151-29"><a href="#cb151-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-30"><a href="#cb151-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getTreasuryBalance</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb151-31"><a href="#cb151-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> treasuryBalance<span class="op">;</span></span>
<span id="cb151-32"><a href="#cb151-32" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb151-33"><a href="#cb151-33" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="automated-cycle-management">Automated Cycle Management</h4>
<p>Implement a system to automatically convert treasury funds into
cycles:</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Cycles <span class="st">&quot;mo:base/ExperimentalCycles&quot;</span><span class="op">;</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Timer <span class="st">&quot;mo:base/Timer&quot;</span><span class="op">;</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> stable <span class="kw">var</span> <span class="dt">treasuryBalance</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">CYCLES_REFILL_THRESHOLD</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">2_000_000_000_000</span><span class="op">;</span> <span class="co">// 2T cycles</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">CYCLES_TARGET_BALANCE</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">5_000_000_000_000</span><span class="op">;</span>   <span class="co">// 5T cycles</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Canister management interface for buying cycles</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    type ManagementCanister <span class="op">=</span> actor {</span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">deposit_cycles</span> <span class="op">:</span> shared { <span class="dt">canister_id</span> <span class="op">:</span> Principal } <span class="op">-&gt;</span> <span class="kw">async</span> ()<span class="op">;</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check balance and refill if needed (called periodically)</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">checkAndRefill</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> balance <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">balance</span>()<span class="op">;</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (balance <span class="op">&lt;</span> CYCLES_REFILL_THRESHOLD) {</span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Low cycle balance detected. Initiating refill...&quot;</span>)<span class="op">;</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> <span class="fu">refillCycles</span>()<span class="op">;</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Refill cycles from treasury</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">refillCycles</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> needed <span class="op">=</span> CYCLES_TARGET_BALANCE <span class="op">-</span> Cycles<span class="op">.</span><span class="fu">balance</span>()<span class="op">;</span></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert tokens to cycles via exchange</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This is simplified - in production, use a DEX or cycles minting canister</span></span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cyclesPurchased <span class="op">=</span> <span class="cf">await</span> <span class="fu">convertTokensToCycles</span>(treasuryBalance)<span class="op">;</span></span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Refilled &quot;</span> # <span class="fu">debug_show</span>(cyclesPurchased) # <span class="st">&quot; cycles&quot;</span>)<span class="op">;</span></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dummy function - in production, integrate with ICP ledger and cycles minting</span></span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">convertTokensToCycles</span>(<span class="dt">tokens</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implementation would involve:</span></span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Converting platform tokens to ICP</span></span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Calling cycles minting canister to convert ICP to cycles</span></span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. Depositing cycles back to this canister</span></span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1_000_000_000_000</span><span class="op">;</span> <span class="co">// Placeholder</span></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set up a heartbeat to check cycles periodically</span></span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">heartbeat</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> <span class="fu">checkAndRefill</span>()<span class="op">;</span></span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="alternative-revenue-streams">Alternative Revenue Streams</h4>
<p>Consider multiple monetization strategies:</p>
<ol type="1">
<li><strong>Subscription Tiers:</strong>
<ul>
<li>Free tier: Basic features with rate limits</li>
<li>Premium tier: Advanced features and higher limits</li>
</ul></li>
<li><strong>Creator Verification Fees:</strong>
<ul>
<li>One-time fee for profile verification</li>
</ul></li>
<li><strong>Premium Placement:</strong>
<ul>
<li>Featured creator slots on the platform</li>
</ul></li>
</ol>
<h3 id="deployment-process-and-best-practices">10.3 Deployment Process
and Best Practices</h3>
<p>Deploying to mainnet is a critical step that requires careful
preparation.</p>
<h4 id="pre-deployment-checklist">Pre-Deployment Checklist</h4>
<p>Before deploying to mainnet, ensure:</p>
<ul>
<li>✅ All tests pass (unit, integration, property-based)</li>
<li>✅ Security audit completed</li>
<li>✅ Cycle management system implemented</li>
<li>✅ Monitoring and logging in place</li>
<li>✅ Upgrade strategy defined</li>
<li>✅ Backup and recovery plan documented</li>
<li>✅ Load testing completed</li>
<li>✅ Documentation finalized</li>
</ul>
<h4 id="deployment-commands">Deployment Commands</h4>
<div class="sourceCode" id="cb153"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create cycles wallet (one-time setup)</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> wallet <span class="at">--network</span> ic create <span class="at">--icp</span> <span class="op">&lt;</span>amount<span class="op">&gt;</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Check cycle balance</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> wallet <span class="at">--network</span> ic balance</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Deploy to mainnet</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy <span class="at">--network</span> ic openpatron <span class="at">--with-cycles</span> 3000000000000</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Verify deployment</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic status openpatron</span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Check canister ID</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic id openpatron</span></code></pre></div>
<h4 id="setting-controllers">Setting Controllers</h4>
<p>Carefully manage who can upgrade your canister:</p>
<div class="sourceCode" id="cb154"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a controller (e.g., DAO or SNS)</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic update-settings openpatron <span class="dt">\</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--add-controller</span> <span class="op">&lt;</span>principal-id<span class="op">&gt;</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="co"># List current controllers</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic info openpatron</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove yourself as controller (careful!)</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic update-settings openpatron <span class="dt">\</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--remove-controller</span> <span class="op">&lt;</span>your-principal-id<span class="op">&gt;</span></span></code></pre></div>
<h3 id="the-black-hole-and-immutability">10.4 The Black Hole and
Immutability</h3>
<p>Once deployed, the developer controls the canister by default. To
build trust with users, you may choose to renounce this control—but this
decision is irreversible.</p>
<h4 id="understanding-black-holing">Understanding Black Holing</h4>
<p><strong>Black Holing</strong> means assigning the canister’s
controller to a non-existent address, making the code permanently
immutable:</p>
<div class="sourceCode" id="cb155"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ⚠️ </span><span class="al">WARNING</span><span class="co">: This action is IRREVERSIBLE</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic update-settings openpatron <span class="dt">\</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--set-controller</span> e3mmv-5qaaa-aaaaa-aaadma-cai</span></code></pre></div>
<p>The address <code>e3mmv-5qaaa-aaaaa-aaadma-cai</code> is a well-known
black hole address on the Internet Computer.</p>
<h4 id="pros-and-cons">Pros and Cons</h4>
<p><strong>Advantages:</strong></p>
<ul>
<li><p>✅ <strong>Trust:</strong> Users know the code cannot be changed
maliciously</p></li>
<li><p>✅ <strong>Censorship Resistance:</strong> No authority can
modify or shut down the canister</p></li>
<li><p>✅ <strong>Truly Decentralized:</strong> Achieves maximum
decentralization</p></li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li><p>❌ <strong>No Bug Fixes:</strong> If a critical bug exists, it
cannot be patched</p></li>
<li><p>❌ <strong>No Feature Updates:</strong> Cannot add new features
or optimizations</p></li>
<li><p>❌ <strong>No Upgrades:</strong> Cannot migrate to new patterns
or standards</p></li>
</ul>
<h4 id="the-middle-path-dao-governance">The Middle Path: DAO
Governance</h4>
<p>Rather than choosing between full control and complete immutability,
consider a third option:</p>
<p><strong>Transfer control to a DAO or SNS (Service Nervous
System):</strong> - Token holders vote on upgrades - Proposals require
community consensus - Maintains upgradeability while distributing power
- We’ll explore this in Chapter 11</p>
<h3 id="monitoring-and-maintenance">10.5 Monitoring and Maintenance</h3>
<p>Successful deployment is just the beginning. Ongoing monitoring is
essential.</p>
<h4 id="key-metrics-to-track">Key Metrics to Track</h4>
<ol type="1">
<li><strong>Cycle Consumption Rate</strong>
<ul>
<li>Daily burn rate</li>
<li>Cost per user/transaction</li>
<li>Storage growth</li>
</ul></li>
<li><strong>Performance Metrics</strong>
<ul>
<li>Response times</li>
<li>Error rates</li>
<li>Concurrent users</li>
</ul></li>
<li><strong>Business Metrics</strong>
<ul>
<li>Active users</li>
<li>Transaction volume</li>
<li>Revenue vs. costs</li>
</ul></li>
</ol>
<h4 id="implementing-canister-logging">Implementing Canister
Logging</h4>
<div class="sourceCode" id="cb156"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Time <span class="st">&quot;mo:base/Time&quot;</span><span class="op">;</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>    type LogEntry <span class="op">=</span> {</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span> <span class="op">:</span> Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">level</span> <span class="op">:</span> LogLevel<span class="op">;</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>    type LogLevel <span class="op">=</span> {</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>        #info<span class="op">;</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>        #warning<span class="op">;</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>        #error<span class="op">;</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> stable <span class="kw">var</span> <span class="dt">logs</span> <span class="op">:</span> [LogEntry] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> logBuffer <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>LogEntry<span class="op">&gt;</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add log entry</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">log</span>(<span class="dt">level</span> <span class="op">:</span> LogLevel<span class="op">,</span> <span class="dt">message</span> <span class="op">:</span> <span class="bu">Text</span>) {</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">entry</span> <span class="op">:</span> LogEntry <span class="op">=</span> {</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>            timestamp <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>            level <span class="op">=</span> level<span class="op">;</span></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>            message <span class="op">=</span> message<span class="op">;</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>        logBuffer<span class="op">.</span><span class="fu">add</span>(entry)<span class="op">;</span></span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Keep only last 1000 logs to manage memory</span></span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (logBuffer<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> <span class="dv">1000</span>) {</span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>            ignore logBuffer<span class="op">.</span><span class="fu">remove</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Query recent logs</span></span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getLogs</span>(<span class="dt">count</span> <span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> [LogEntry] {</span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> size <span class="op">=</span> logBuffer<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> start <span class="op">=</span> <span class="cf">if</span> (size <span class="op">&gt;</span> count) { size <span class="op">-</span> count } <span class="cf">else</span> { <span class="dv">0</span> }<span class="op">;</span></span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Array</span><span class="op">.</span><span class="at">tabulate</span><span class="op">&lt;</span>LogEntry<span class="op">&gt;</span>(</span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>            count<span class="op">,</span></span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">func</span>(i) {</span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (start <span class="op">+</span> i <span class="op">&lt;</span> size) {</span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a>                    logBuffer<span class="op">.</span><span class="fu">get</span>(start <span class="op">+</span> i)</span>
<span id="cb156-48"><a href="#cb156-48" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> {</span>
<span id="cb156-49"><a href="#cb156-49" aria-hidden="true" tabindex="-1"></a>                    {</span>
<span id="cb156-50"><a href="#cb156-50" aria-hidden="true" tabindex="-1"></a>                        timestamp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-51"><a href="#cb156-51" aria-hidden="true" tabindex="-1"></a>                        level <span class="op">=</span> #info<span class="op">;</span></span>
<span id="cb156-52"><a href="#cb156-52" aria-hidden="true" tabindex="-1"></a>                        message <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb156-53"><a href="#cb156-53" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb156-54"><a href="#cb156-54" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb156-55"><a href="#cb156-55" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb156-56"><a href="#cb156-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb156-57"><a href="#cb156-57" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb156-58"><a href="#cb156-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb156-59"><a href="#cb156-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Example: Log subscription event</span></span>
<span id="cb156-60"><a href="#cb156-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">createSubscription</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb156-61"><a href="#cb156-61" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span>(#info<span class="op">,</span> <span class="st">&quot;New subscription created&quot;</span>)<span class="op">;</span></span>
<span id="cb156-62"><a href="#cb156-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ... subscription logic</span></span>
<span id="cb156-63"><a href="#cb156-63" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb156-64"><a href="#cb156-64" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="cost-optimization-strategies">10.6 Cost Optimization
Strategies</h3>
<p>Minimize cycle consumption without sacrificing functionality:</p>
<h4 id="efficient-data-structures">1. Efficient Data Structures</h4>
<p>Use the right data structure for your access patterns:</p>
<div class="sourceCode" id="cb157"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Inefficient: Array for frequent lookups</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> stable <span class="kw">var</span> users <span class="op">:</span> [User] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Efficient: HashMap for O(1) lookups</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="kw">var</span> users <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> User<span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span></code></pre></div>
<h4 id="lazy-loading">2. Lazy Loading</h4>
<p>Don’t load data you don’t need:</p>
<div class="sourceCode" id="cb158"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Only load necessary fields</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> query func <span class="fu">getUserProfile</span>(userId <span class="op">:</span> Principal) <span class="op">:</span> <span class="kw">async</span> <span class="op">?</span>UserProfile {</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (users<span class="op">.</span><span class="fu">get</span>(userId)) {</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="kw">null</span> { <span class="kw">null</span> }<span class="op">;</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> (<span class="op">?</span>user) {</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Return minimal profile, not entire user object</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">?</span>{</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>                name <span class="op">=</span> user<span class="op">.</span><span class="at">name</span><span class="op">;</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>                avatar <span class="op">=</span> user<span class="op">.</span><span class="at">avatar</span><span class="op">;</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Don&#39;t include large fields like full subscription history</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="query-calls-when-possible">3. Query Calls When Possible</h4>
<p>Query calls don’t consume consensus cycles:</p>
<div class="sourceCode" id="cb159"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Use query for read-only operations</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> query func <span class="fu">getSubscriptions</span>() <span class="op">:</span> <span class="kw">async</span> [Subscription] {</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No state modification</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Don&#39;t use update calls for reads</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">getSubscriptions</span>() <span class="op">:</span> <span class="kw">async</span> [Subscription] {</span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wastes cycles on consensus</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="batch-operations">4. Batch Operations</h4>
<p>Reduce overhead by batching:</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Process multiple items in one call</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">batchSubscribe</span>(creatorIds <span class="op">:</span> [Principal]) <span class="op">:</span> <span class="kw">async</span> [Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>] {</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Array</span><span class="op">.</span><span class="fu">map</span>(creatorIds<span class="op">,</span> <span class="fu">func</span>(<span class="dt">id</span> <span class="op">:</span> Principal) <span class="op">:</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process subscription</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>()</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="upgrade-strategies">10.7 Upgrade Strategies</h3>
<p>If you retain control of your canister, plan your upgrade strategy
carefully.</p>
<h4 id="stable-variables-and-persistence">Stable Variables and
Persistence</h4>
<p>Use <code>stable</code> keyword to preserve data across upgrades:</p>
<div class="sourceCode" id="cb161"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Persists across upgrades</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> stable <span class="kw">var</span> <span class="dt">subscriptionCount</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Resets to empty on upgrade</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="dt">cache</span> <span class="op">:</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> User<span class="op">&gt;</span> <span class="op">=</span> HashMap<span class="op">.</span><span class="fu">HashMap</span>(<span class="dv">10</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restore non-stable data after upgrade</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Rebuild cache from stable storage</span></span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// cache := rebuildCache();</span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="testing-upgrades">Testing Upgrades</h4>
<p>Always test upgrades on a testnet first:</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Deploy initial version</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy <span class="at">--network</span> ic openpatron</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Add some test data</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ... interact with canister ...</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Make changes to code</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Upgrade</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy <span class="at">--network</span> ic openpatron <span class="at">--mode</span> upgrade</span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Verify data persisted</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic call openpatron getSubscriptionCount</span></code></pre></div>
<h3 id="case-study-openpatron-deployment-costs">10.8 Case Study:
OpenPatron Deployment Costs</h3>
<p>Let’s estimate the real-world costs for OpenPatron at different
scales:</p>
<h4 id="small-scale-1000-users">Small Scale (1,000 users)</h4>
<ul>
<li><strong>Storage:</strong> ~50 MB → 8.4M cycles/day → 252M
cycles/month</li>
<li><strong>Computation:</strong> ~100 transactions/day → 500M
cycles/month</li>
<li><strong>Total:</strong> ~752M cycles/month ≈ $0.98/month</li>
</ul>
<h4 id="medium-scale-50000-users">Medium Scale (50,000 users)</h4>
<ul>
<li><strong>Storage:</strong> ~2.5 GB → 420M cycles/day → 12.6B
cycles/month</li>
<li><strong>Computation:</strong> ~5,000 transactions/day → 25B
cycles/month</li>
<li><strong>Total:</strong> ~37.6B cycles/month ≈ $48.88/month</li>
</ul>
<h4 id="large-scale-1m-users">Large Scale (1M users)</h4>
<ul>
<li><strong>Storage:</strong> ~50 GB → 8.4B cycles/day → 252B
cycles/month</li>
<li><strong>Computation:</strong> ~100K transactions/day → 500B
cycles/month</li>
<li><strong>Total:</strong> ~752B cycles/month ≈ $977.60/month</li>
</ul>
<p><strong>Key Insight:</strong> Even at 1 million users, the platform
costs less than $1,000/month—dramatically cheaper than traditional cloud
infrastructure with comparable features and security.</p>
<h3 id="summary-3">10.9 Summary</h3>
<p>Deploying to the Internet Computer requires understanding:</p>
<ol type="1">
<li><strong>Cycles:</strong> The stable-cost fuel that powers
canisters</li>
<li><strong>Sustainability:</strong> Building revenue models to fund
ongoing operations</li>
<li><strong>Monitoring:</strong> Tracking cycle consumption and
performance</li>
<li><strong>Optimization:</strong> Minimizing costs through efficient
code</li>
<li><strong>Immutability:</strong> The trade-offs of black-holing
vs. upgradability</li>
<li><strong>Governance:</strong> Alternative control models through
DAOs/SNS</li>
</ol>
<p>The reverse gas model is a powerful feature that enables true Web3
UX, but it requires developers to think like product owners and
economists, not just engineers.</p>
<p>In the next chapter, we’ll explore how to hand over control of
OpenPatron to its community through the Service Nervous System (SNS),
creating true decentralized governance.</p>
<hr />
<hr />
<h1 id="chapter-13-the-service-nervous-system-sns">Chapter 13: The
Service Nervous System (SNS)</h1>
<p>The superior alternative to Black Holing is the <strong>Service
Nervous System (SNS)</strong>. This is an algorithmic DAO framework
provided by the Internet Computer protocol itself, offering a
standardized, battle-tested solution for decentralized governance.</p>
<p>By handing control of OpenPatron to an SNS, you transform it from a
centrally-controlled application into a truly decentralized autonomous
organization where the community—not the developer—owns, governs, and
evolves the platform.</p>
<h3 id="the-architecture-of-sns">11.1 The Architecture of SNS</h3>
<p>An SNS is not a single canister, but a sophisticated
<strong>multi-canister system</strong> that provides complete governance
infrastructure:</p>
<h4 id="the-four-core-canisters">The Four Core Canisters</h4>
<ol type="1">
<li><strong>Governance Canister</strong>
<ul>
<li>Stores all proposals and voting records</li>
<li>Manages staked tokens (neurons)</li>
<li>Executes approved proposals automatically</li>
<li>Implements voting power calculations and rewards</li>
</ul></li>
<li><strong>Ledger Canister</strong>
<ul>
<li>Implements ICRC-1 token standard</li>
<li>Tracks token balances and transfers</li>
<li>Handles staking and unstaking operations</li>
<li>Maintains complete transaction history</li>
</ul></li>
<li><strong>Root Canister</strong>
<ul>
<li>Acts as the controller of your dapp canisters</li>
<li>Executes upgrade commands from governance</li>
<li>Manages canister lifecycle operations</li>
<li>Provides a security boundary</li>
</ul></li>
<li><strong>Index Canister</strong>
<ul>
<li>Indexes ledger transactions</li>
<li>Enables fast balance queries</li>
<li>Powers analytics and reporting</li>
<li>Optimizes historical data access</li>
</ul></li>
</ol>
<pre><code>┌─────────────────────────────────────────────────┐
│                  SNS System                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌──────────────┐      ┌──────────────┐       │
│  │  Governance  │◄────►│    Ledger    │       │
│  │   Canister   │      │   Canister   │       │
│  └──────┬───────┘      └──────────────┘       │
│         │                                       │
│         │ Execute Proposals                    │
│         ▼                                       │
│  ┌──────────────┐      ┌──────────────┐       │
│  │     Root     │◄────►│    Index     │       │
│  │   Canister   │      │   Canister   │       │
│  └──────┬───────┘      └──────────────┘       │
│         │                                       │
│         │ Controls                              │
│         ▼                                       │
│  ┌──────────────┐      ┌──────────────┐       │
│  │  OpenPatron  │◄────►│  OpenPatron  │       │
│  │   Frontend   │      │    Backend   │       │
│  └──────────────┘      └──────────────┘       │
│                                                 │
└─────────────────────────────────────────────────┘</code></pre>
<h3 id="neurons-the-foundation-of-governance">11.2 Neurons: The
Foundation of Governance</h3>
<p>In an SNS, token holders don’t vote directly. Instead, they create
<strong>neurons</strong> by staking (locking) their tokens for a
specified period. This design incentivizes long-term thinking and
prevents short-term speculation from dominating governance.</p>
<h4 id="neuron-properties">Neuron Properties</h4>
<p>Each neuron has several key attributes that determine its voting
power:</p>
<div class="sourceCode" id="cb164"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>type Neuron <span class="op">=</span> {</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unique identifier</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span> <span class="op">:</span> NeuronId<span class="op">;</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Amount of tokens staked</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">stake</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Time when neuron was created</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">createdAt</span> <span class="op">:</span> Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Minimum lock period (6 months to 8 years)</span></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">dissolveDelay</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Current state: locked, dissolving, or dissolved</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">state</span> <span class="op">:</span> NeuronState<span class="op">;</span></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Age bonus (max 4 years)</span></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">age</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Voting history and participation</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">votingPower</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a>type NeuronState <span class="op">=</span> {</span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a>    #Locked<span class="op">;</span></span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a>    #Dissolving<span class="op">;</span></span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a>    #Dissolved<span class="op">;</span></span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="voting-power-calculation">Voting Power Calculation</h4>
<p>Voting power is not simply proportional to stake. It incorporates
multiple factors:</p>
<pre><code>Voting Power = Stake × Dissolve Delay Bonus × Age Bonus</code></pre>
<p><strong>Dissolve Delay Bonus:</strong> - Maximum bonus: 2× (for
8-year lock) - Minimum: 1× (for 6-month lock) - Formula:
<code>1 + (dissolveDelay / maxDissolveDelay)</code></p>
<p><strong>Age Bonus:</strong> - Maximum bonus: 1.25× (after 4 years) -
Grows linearly over time - Resets when tokens are withdrawn</p>
<p><strong>Example Calculation:</strong></p>
<div class="sourceCode" id="cb166"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Alice: 1,000 tokens, 2-year lock, 1-year age</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>Stake<span class="op">:</span> <span class="dv">1</span><span class="op">,</span><span class="dv">000</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>Dissolve Bonus<span class="op">:</span> <span class="dv">1</span> <span class="op">+</span> (<span class="dv">2</span> years <span class="op">/</span> <span class="dv">8</span> years) <span class="op">=</span> <span class="fl">1.25</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>Age Bonus<span class="op">:</span> <span class="dv">1</span> <span class="op">+</span> (<span class="dv">1</span> year <span class="op">/</span> <span class="dv">4</span> years × <span class="fl">0.25</span>) <span class="op">=</span> <span class="fl">1.0625</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>Voting Power<span class="op">:</span> <span class="dv">1</span><span class="op">,</span><span class="dv">000</span> × <span class="fl">1.25</span> × <span class="fl">1.0625</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span><span class="dv">328</span> votes</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Bob: 500 tokens, 8-year lock, 4-year age</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>Stake<span class="op">:</span> <span class="dv">500</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>Dissolve Bonus<span class="op">:</span> <span class="dv">1</span> <span class="op">+</span> (<span class="dv">8</span> years <span class="op">/</span> <span class="dv">8</span> years) <span class="op">=</span> <span class="fl">2.0</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>Age Bonus<span class="op">:</span> <span class="dv">1</span> <span class="op">+</span> <span class="fl">0.25</span> <span class="op">=</span> <span class="fl">1.25</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>Voting Power<span class="op">:</span> <span class="dv">500</span> × <span class="fl">2.0</span> × <span class="fl">1.25</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span><span class="dv">250</span> votes</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Despite having half the stake, Bob has nearly equal power</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a><span class="co">// due to long-term commitment</span></span></code></pre></div>
<h3 id="proposal-types-and-governance">11.3 Proposal Types and
Governance</h3>
<p>SNS governance operates through <strong>proposals</strong>. Any
neuron holder can submit a proposal, and all neurons can vote. If a
proposal reaches the required threshold, it executes automatically.</p>
<h4 id="standard-proposal-types">Standard Proposal Types</h4>
<ol type="1">
<li><strong>Motion Proposals</strong>
<ul>
<li>Non-executable governance decisions</li>
<li>Community sentiment polls</li>
<li>Strategic direction discussions</li>
<li>Example: “Should we integrate with protocol X?”</li>
</ul></li>
<li><strong>Upgrade Canister Proposals</strong>
<ul>
<li>Deploy new Wasm code to canisters</li>
<li>Most critical proposal type</li>
<li>Example: “Deploy v2.0 with subscription tiers”</li>
</ul></li>
<li><strong>Transfer SNS Treasury Funds</strong>
<ul>
<li>Move tokens from DAO treasury</li>
<li>Fund development or partnerships</li>
<li>Example: “Allocate 50K tokens to marketing campaign”</li>
</ul></li>
<li><strong>Parameter Change Proposals</strong>
<ul>
<li>Modify governance parameters</li>
<li>Adjust voting thresholds, rewards, etc.</li>
<li>Example: “Increase minimum dissolve delay to 1 year”</li>
</ul></li>
<li><strong>Add/Remove Controlled Canister</strong>
<ul>
<li>Expand or reduce SNS scope</li>
<li>Add new canisters to governance</li>
<li>Example: “Add OpenPatron mobile app canister”</li>
</ul></li>
</ol>
<h4 id="proposal-lifecycle">Proposal Lifecycle</h4>
<div class="sourceCode" id="cb167"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>type ProposalStatus <span class="op">=</span> {</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    #Open<span class="op">;</span>      <span class="co">// Currently accepting votes</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    #Rejected<span class="op">;</span>  <span class="co">// Failed to reach threshold</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    #Executed<span class="op">;</span>  <span class="co">// Approved and executed</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    #Failed<span class="op">;</span>    <span class="co">// Execution failed</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>type Proposal <span class="op">=</span> {</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">id</span> <span class="op">:</span> ProposalId<span class="op">;</span></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">proposer</span> <span class="op">:</span> NeuronId<span class="op">;</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Proposal content</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">summary</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">url</span> <span class="op">:</span> <span class="op">?</span><span class="bu">Text</span><span class="op">;</span>  <span class="co">// Link to detailed discussion</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execution payload</span></span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">action</span> <span class="op">:</span> ProposalAction<span class="op">;</span></span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Voting data</span></span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">votesYes</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb167-22"><a href="#cb167-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">votesNo</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb167-23"><a href="#cb167-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">status</span> <span class="op">:</span> ProposalStatus<span class="op">;</span></span>
<span id="cb167-24"><a href="#cb167-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb167-25"><a href="#cb167-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Timing</span></span>
<span id="cb167-26"><a href="#cb167-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">proposedAt</span> <span class="op">:</span> Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb167-27"><a href="#cb167-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">decidedAt</span> <span class="op">:</span> <span class="op">?</span>Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb167-28"><a href="#cb167-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">executedAt</span> <span class="op">:</span> <span class="op">?</span>Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb167-29"><a href="#cb167-29" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>Voting Period:</strong> - Typical duration: 4-7 days - Early
adoption: Proposal can pass before deadline if threshold met - Absolute
majority required: &gt;50% of total voting power</p>
<h4 id="example-submitting-an-upgrade-proposal">Example: Submitting an
Upgrade Proposal</h4>
<div class="sourceCode" id="cb168"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> SNS <span class="st">&quot;mo:sns/Governance&quot;</span><span class="op">;</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Blob</span> <span class="st">&quot;mo:base/Blob&quot;</span><span class="op">;</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>actor OpenPatronGovernance {</span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="dt">snsGovernance</span> <span class="op">:</span> SNS<span class="op">.</span><span class="at">Governance</span> <span class="op">=</span> <span class="fu">actor</span>(<span class="st">&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;</span>)<span class="op">;</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Submit a proposal to upgrade OpenPatron</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>({ caller }) func <span class="fu">proposeUpgrade</span>(</span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">wasmModule</span> <span class="op">:</span> <span class="bu">Blob</span><span class="op">,</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">title</span> <span class="op">:</span> <span class="bu">Text</span><span class="op">,</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">summary</span> <span class="op">:</span> <span class="bu">Text</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>ProposalId<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate caller has a neuron</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> neuronId <span class="op">=</span> <span class="cf">switch</span> (<span class="cf">await</span> snsGovernance<span class="op">.</span><span class="fu">getNeuronByPrincipal</span>(caller)) {</span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> { <span class="cf">return</span> #<span class="fu">err</span>(<span class="st">&quot;Must have a neuron to propose&quot;</span>) }<span class="op">;</span></span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>n) { n<span class="op">.</span><span class="at">id</span> }<span class="op">;</span></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create upgrade proposal</span></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> proposal <span class="op">=</span> {</span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> title<span class="op">;</span></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>            summary <span class="op">=</span> summary<span class="op">;</span></span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> <span class="op">?</span><span class="st">&quot;https://github.com/openpatron/proposals/001&quot;</span><span class="op">;</span></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>            action <span class="op">=</span> #<span class="fu">UpgradeCanister</span>({</span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>                canisterId <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;bd3sg-teaaa-aaaaa-qaaba-cai&quot;</span>)<span class="op">;</span></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>                wasm <span class="op">=</span> wasmModule<span class="op">;</span></span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>                arg <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>            })<span class="op">;</span></span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Submit to governance</span></span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> snsGovernance<span class="op">.</span><span class="fu">submitProposal</span>(proposal<span class="op">,</span> neuronId)<span class="op">;</span></span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (result) {</span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">ok</span>(proposalId)) {</span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">ok</span>(proposalId)</span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">err</span>(msg)) {</span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">err</span>(<span class="st">&quot;Proposal failed: &quot;</span> # msg)</span>
<span id="cb168-42"><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb168-43"><a href="#cb168-43" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb168-44"><a href="#cb168-44" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb168-45"><a href="#cb168-45" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="voting-mechanisms">11.4 Voting Mechanisms</h3>
<p>SNS implements multiple voting strategies to ensure efficient
governance while preventing manipulation.</p>
<h4 id="manual-voting">Manual Voting</h4>
<p>Token holders actively vote on each proposal:</p>
<div class="sourceCode" id="cb169"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Vote on a proposal</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span>({ caller }) func <span class="fu">vote</span>(</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    proposalId <span class="op">:</span> ProposalId<span class="op">,</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    vote <span class="op">:</span> Vote</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> neuronId <span class="op">=</span> <span class="cf">await</span> <span class="fu">getUserNeuron</span>(caller)<span class="op">;</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> snsGovernance<span class="op">.</span><span class="fu">registerVote</span>({</span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>        proposalId <span class="op">=</span> proposalId<span class="op">;</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>        neuronId <span class="op">=</span> neuronId<span class="op">;</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>        vote <span class="op">=</span> vote<span class="op">;</span>  <span class="co">// #Yes or #No</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>type Vote <span class="op">=</span> {</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>    #Yes<span class="op">;</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>    #No<span class="op">;</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="following-liquid-democracy">Following (Liquid Democracy)</h4>
<p>Neurons can “follow” other neurons, delegating their voting
power:</p>
<div class="sourceCode" id="cb170"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>type Following <span class="op">=</span> {</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">followees</span> <span class="op">:</span> [NeuronId]<span class="op">;</span>  <span class="co">// List of neurons to follow</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">topic</span> <span class="op">:</span> <span class="op">?</span>ProposalTopic<span class="op">;</span>  <span class="co">// Specific topic or all topics</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Set up following relationship</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">shared</span>({ caller }) func <span class="fu">follow</span>(</span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>    followee <span class="op">:</span> NeuronId<span class="op">,</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>    topic <span class="op">:</span> <span class="op">?</span>ProposalTopic</span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> myNeuron <span class="op">=</span> <span class="cf">await</span> <span class="fu">getUserNeuron</span>(caller)<span class="op">;</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Delegate voting power to another neuron</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> snsGovernance<span class="op">.</span><span class="fu">setFollowing</span>(</span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>        myNeuron<span class="op">,</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>        followee<span class="op">,</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>        topic</span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>This creates a “liquid democracy” where: - Technical proposals can be
delegated to expert developers - Business proposals can be delegated to
business-focused members - Voting power flows efficiently to those with
relevant expertise</p>
<h4 id="voting-rewards">Voting Rewards</h4>
<p>To incentivize participation, SNS distributes <strong>voting
rewards</strong>:</p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>type VotingRewards <span class="op">=</span> {</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Total rewards pool (percentage of supply)</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">annualRewardRate</span> <span class="op">:</span> Float<span class="op">;</span>  <span class="co">// e.g., 10% APY</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Distribution</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">participationRequired</span> <span class="op">:</span> Float<span class="op">;</span>  <span class="co">// Must vote on &gt;50% of proposals</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compound into neuron</span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">autoStake</span> <span class="op">:</span> Bool<span class="op">;</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate rewards for a neuron</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> func <span class="fu">calculateRewards</span>(neuron <span class="op">:</span> Neuron) <span class="op">:</span> Nat {</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> participation <span class="op">=</span> neuron<span class="op">.</span><span class="at">votesCount</span> <span class="op">/</span> totalProposals<span class="op">;</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (participation <span class="op">&lt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// Didn&#39;t meet threshold</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> yearlyReward <span class="op">=</span> neuron<span class="op">.</span><span class="at">stake</span> <span class="op">*</span> annualRewardRate<span class="op">;</span></span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> dailyReward <span class="op">=</span> yearlyReward <span class="op">/</span> <span class="dv">365</span><span class="op">;</span></span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dailyReward<span class="op">;</span></span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="token-economics-and-distribution">11.5 Token Economics and
Distribution</h3>
<p>Launching an SNS requires careful planning of token distribution to
ensure decentralization and fair governance.</p>
<h4 id="the-sns-swap">The SNS Swap</h4>
<p>The standard launch mechanism is a <strong>decentralization
swap</strong>:</p>
<ol type="1">
<li><strong>Developer Contribution:</strong>
<ul>
<li>Developer contributes their dapp canisters to SNS</li>
<li>Receives allocation of governance tokens (typically 10-30%)</li>
<li>Tokens subject to vesting schedule</li>
</ul></li>
<li><strong>Public Fundraise:</strong>
<ul>
<li>Open token sale to community</li>
<li>Participants receive governance tokens</li>
<li>Funds go to DAO treasury</li>
<li>Typically 40-60% of supply</li>
</ul></li>
<li><strong>Developer Team:</strong>
<ul>
<li>Team receives tokens for ongoing development</li>
<li>Long vesting period (2-4 years)</li>
<li>10-20% of supply</li>
</ul></li>
<li><strong>Treasury:</strong>
<ul>
<li>Reserved for future development</li>
<li>Grants and incentives</li>
<li>10-20% of supply</li>
</ul></li>
</ol>
<p><strong>Example Distribution for OpenPatron:</strong></p>
<pre><code>Total Supply: 100,000,000 tokens

Initial Distribution:
- Public Swap:     50,000,000 (50%)  → Community governance
- Developer Fund:  15,000,000 (15%)  → Original builders (2-year vest)
- Treasury:        20,000,000 (20%)  → Future grants and development
- Early Investors: 10,000,000 (10%)  → Seed funding (1-year vest)
- Airdrop:          5,000,000 (5%)   → Early platform users

Vesting Schedules:
- Developer Fund: 6-month cliff, 2-year linear vest
- Early Investors: 3-month cliff, 1-year linear vest
- Treasury: Controlled by governance proposals</code></pre>
<h4 id="swap-configuration">Swap Configuration</h4>
<div class="sourceCode" id="cb173"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>type SwapParameters <span class="op">=</span> {</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Fundraising goals</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">minParticipants</span> <span class="op">:</span> Nat<span class="op">;</span>        <span class="co">// e.g., 100 minimum participants</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">minICPPerParticipant</span> <span class="op">:</span> Nat<span class="op">;</span>   <span class="co">// e.g., 1 ICP minimum</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxICPPerParticipant</span> <span class="op">:</span> Nat<span class="op">;</span>   <span class="co">// e.g., 10,000 ICP maximum</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Total raise</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">minICPTarget</span> <span class="op">:</span> Nat<span class="op">;</span>           <span class="co">// e.g., 100,000 ICP</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxICPTarget</span> <span class="op">:</span> Nat<span class="op">;</span>           <span class="co">// e.g., 1,000,000 ICP</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token allocation</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tokensForSale</span> <span class="op">:</span> Nat<span class="op">;</span>          <span class="co">// e.g., 50M tokens</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Duration</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">swapStartTime</span> <span class="op">:</span> Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">swapDuration</span> <span class="op">:</span> Nat<span class="op">;</span>           <span class="co">// e.g., 7 days</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Restrictions</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">neuronMinDissolveDelay</span> <span class="op">:</span> Nat<span class="op">;</span> <span class="co">// e.g., 6 months</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="practical-implementation-sns-enabling-openpatron">11.6 Practical
Implementation: SNS-Enabling OpenPatron</h3>
<p>Let’s walk through the process of handing OpenPatron to an SNS.</p>
<h4 id="step-1-prepare-your-canisters">Step 1: Prepare Your
Canisters</h4>
<p>Ensure your canisters are production-ready:</p>
<div class="sourceCode" id="cb174"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Audit checklist</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="ex">✓</span> Security audit completed</span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="ex">✓</span> All tests passing</span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="ex">✓</span> Cycle management implemented</span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="ex">✓</span> Monitoring in place</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a><span class="ex">✓</span> Documentation complete</span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a><span class="ex">✓</span> Community ready for governance</span></code></pre></div>
<h4 id="step-2-create-sns-configuration">Step 2: Create SNS
Configuration</h4>
<p>Define your governance parameters in <code>sns.yml</code>:</p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OpenPatron SNS Configuration</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Token Information</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="fu">token</span><span class="kw">:</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;OpenPatron Governance Token&quot;</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">symbol</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;OPG&quot;</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">total_supply</span><span class="kw">:</span><span class="at"> </span><span class="dv">100_000_000_000_000</span><span class="co">  # 100M tokens (8 decimals)</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">transaction_fee</span><span class="kw">:</span><span class="at"> </span><span class="dv">10_000</span><span class="co">             # 0.0001 OPG</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial Token Distribution</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a><span class="fu">distribution</span><span class="kw">:</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">developers</span><span class="kw">:</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">amount</span><span class="kw">:</span><span class="at"> </span><span class="dv">15_000_000_000_000</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">vesting_period_months</span><span class="kw">:</span><span class="at"> </span><span class="dv">24</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cliff_months</span><span class="kw">:</span><span class="at"> </span><span class="dv">6</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">treasury</span><span class="kw">:</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">amount</span><span class="kw">:</span><span class="at"> </span><span class="dv">20_000_000_000_000</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">swap</span><span class="kw">:</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">amount</span><span class="kw">:</span><span class="at"> </span><span class="dv">50_000_000_000_000</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">min_participants</span><span class="kw">:</span><span class="at"> </span><span class="dv">100</span></span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">min_icp</span><span class="kw">:</span><span class="at"> </span><span class="dv">1_000_000_000</span><span class="co">      # 10 ICP</span></span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">max_icp</span><span class="kw">:</span><span class="at"> </span><span class="dv">10_000_000_000_000</span><span class="co"> # 100,000 ICP per person</span></span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Governance Parameters</span></span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a><span class="fu">governance</span><span class="kw">:</span></span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">proposal_submission_deposit</span><span class="kw">:</span><span class="at"> </span><span class="dv">1_000_000_000</span><span class="co">  # 10 OPG</span></span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">proposal_rejection_fee</span><span class="kw">:</span><span class="at"> </span><span class="dv">100_000_000</span><span class="co">         # 1 OPG</span></span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a><span class="co">  # Voting</span></span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">minimum_yes_proportion</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.03</span><span class="co">  # 3% quorum</span></span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">voting_period_seconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">345_600</span><span class="co">  # 4 days</span></span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a><span class="co">  # Neuron parameters</span></span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">min_dissolve_delay_seconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">15_552_000</span><span class="co">  # 6 months</span></span>
<span id="cb175-37"><a href="#cb175-37" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_dissolve_delay_seconds</span><span class="kw">:</span><span class="at"> </span><span class="dv">252_460_800</span><span class="co"> # 8 years</span></span>
<span id="cb175-38"><a href="#cb175-38" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">max_age_bonus</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.25</span><span class="co">  # 25% bonus after 4 years</span></span>
<span id="cb175-39"><a href="#cb175-39" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb175-40"><a href="#cb175-40" aria-hidden="true" tabindex="-1"></a><span class="co">  # Rewards</span></span>
<span id="cb175-41"><a href="#cb175-41" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">voting_reward_rate</span><span class="kw">:</span><span class="at"> </span><span class="fl">0.10</span><span class="co">  # 10% APY</span></span>
<span id="cb175-42"><a href="#cb175-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-43"><a href="#cb175-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Controlled Canisters</span></span>
<span id="cb175-44"><a href="#cb175-44" aria-hidden="true" tabindex="-1"></a><span class="fu">dapp_canisters</span><span class="kw">:</span></span>
<span id="cb175-45"><a href="#cb175-45" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> bd3sg-teaaa-aaaaa-qaaba-cai</span><span class="co">  # OpenPatron Backend</span></span>
<span id="cb175-46"><a href="#cb175-46" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> bkyz2-fmaaa-aaaaa-qaaaq-cai</span><span class="co">  # OpenPatron Frontend</span></span></code></pre></div>
<h4 id="step-3-deploy-sns">Step 3: Deploy SNS</h4>
<p>Use the SNS CLI tooling:</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install SNS tools</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> extension install sns</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize SNS configuration</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns init</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate configuration</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns validate</span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy to testnet first</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns deploy <span class="at">--network</span> ic <span class="at">--testnet</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a><span class="co"># After testing, deploy to mainnet</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns deploy <span class="at">--network</span> ic</span></code></pre></div>
<h4 id="step-4-launch-decentralization-swap">Step 4: Launch
Decentralization Swap</h4>
<div class="sourceCode" id="cb177"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initiate the token swap</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns swap start <span class="dt">\</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--network</span> ic <span class="dt">\</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--sns-governance-canister-id</span> rrkah-fqaaa-aaaaa-aaaaq-cai</span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor swap progress</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns swap status <span class="at">--network</span> ic</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a><span class="co"># After successful swap, finalize</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> sns swap finalize <span class="at">--network</span> ic</span></code></pre></div>
<h4 id="step-5-transfer-control">Step 5: Transfer Control</h4>
<p>Once the swap completes successfully, control automatically
transfers:</p>
<div class="sourceCode" id="cb178"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify SNS is now the controller</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister <span class="at">--network</span> ic info bd3sg-teaaa-aaaaa-qaaba-cai</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Output shows:</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Controllers: rrkah-fqaaa-aaaaa-aaaaq-cai (SNS Root Canister)</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a><span class="co">#              [Your principal removed]</span></span></code></pre></div>
<p><strong>You no longer control OpenPatron. The DAO does.</strong></p>
<h3 id="integrating-sns-governance-into-your-dapp">11.7 Integrating SNS
Governance into Your Dapp</h3>
<p>Once governed by an SNS, your canisters should expose
governance-friendly interfaces.</p>
<h4 id="admin-functions-behind-governance">Admin Functions Behind
Governance</h4>
<div class="sourceCode" id="cb179"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>actor OpenPatron {</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The SNS Root canister that controls this canister</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">SNS_ROOT</span> <span class="op">:</span> Principal <span class="op">=</span> </span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>        Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;rrkah-fqaaa-aaaaa-aaaaq-cai&quot;</span>)<span class="op">;</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only SNS governance can call this</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">assertGovernance</span>(<span class="dt">caller</span> <span class="op">:</span> Principal) {</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (caller <span class="op">!=</span> SNS_ROOT) {</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">trap</span>(<span class="st">&quot;Only SNS governance can call this function&quot;</span>)<span class="op">;</span></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configuration changes require proposal</span></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> stable <span class="kw">var</span> <span class="dt">platformFeePercent</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>({ caller }) func <span class="fu">setPlatformFee</span>(</span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">newFee</span> <span class="op">:</span> Nat</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertGovernance</span>(caller)<span class="op">;</span></span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (newFee <span class="op">&gt;</span> <span class="dv">10</span>) {</span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">trap</span>(<span class="st">&quot;Fee cannot exceed 10%&quot;</span>)<span class="op">;</span></span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">platformFeePercent</span> <span class="op">:=</span> newFee<span class="op">;</span></span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Upgrade hooks for migration</span></span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">preupgrade</span>() {</span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Save state before upgrade</span></span>
<span id="cb179-34"><a href="#cb179-34" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb179-35"><a href="#cb179-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-36"><a href="#cb179-36" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb179-37"><a href="#cb179-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Restore state after upgrade</span></span>
<span id="cb179-38"><a href="#cb179-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform any necessary migrations</span></span>
<span id="cb179-39"><a href="#cb179-39" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb179-40"><a href="#cb179-40" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="exposing-governance-metrics">Exposing Governance Metrics</h4>
<p>Help token holders make informed decisions:</p>
<div class="sourceCode" id="cb180"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Provide metrics for governance proposals</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> query func <span class="fu">getGovernanceMetrics</span>() <span class="op">:</span> <span class="kw">async</span> GovernanceMetrics {</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>        totalUsers <span class="op">=</span> users<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>        totalCreators <span class="op">=</span> creators<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>        totalSubscriptions <span class="op">=</span> subscriptions<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>        monthlyRevenue <span class="op">=</span> <span class="fu">calculateMonthlyRevenue</span>()<span class="op">;</span></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>        treasuryBalance <span class="op">=</span> treasuryBalance<span class="op">;</span></span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>        cycleBalance <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">balance</span>()<span class="op">;</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>        estimatedMonthsOfRuntime <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">balance</span>() <span class="op">/</span> averageMonthlyCost<span class="op">;</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>        platformFee <span class="op">=</span> platformFeePercent<span class="op">;</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>        averageSubscriptionPrice <span class="op">=</span> <span class="fu">calculateAveragePrice</span>()<span class="op">;</span></span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>type GovernanceMetrics <span class="op">=</span> {</span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Usage</span></span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">totalUsers</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">totalCreators</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">totalSubscriptions</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Economics</span></span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">monthlyRevenue</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">treasuryBalance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Health</span></span>
<span id="cb180-30"><a href="#cb180-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">cycleBalance</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-31"><a href="#cb180-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">estimatedMonthsOfRuntime</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-32"><a href="#cb180-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-33"><a href="#cb180-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configuration</span></span>
<span id="cb180-34"><a href="#cb180-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">platformFee</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-35"><a href="#cb180-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">averageSubscriptionPrice</span> <span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb180-36"><a href="#cb180-36" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="benefits-and-trade-offs">11.8 Benefits and Trade-offs</h3>
<h4 id="advantages-of-sns-governance">Advantages of SNS Governance</h4>
<ol type="1">
<li><strong>True Decentralization</strong>
<ul>
<li>No single point of control</li>
<li>Community-owned and operated</li>
<li>Censorship-resistant</li>
</ul></li>
<li><strong>Legitimacy</strong>
<ul>
<li>Token holders have skin in the game</li>
<li>Aligned incentives between users and governors</li>
<li>Transparent decision-making</li>
</ul></li>
<li><strong>Flexibility</strong>
<ul>
<li>Can upgrade and evolve unlike black-holed canisters</li>
<li>Adapt to changing market conditions</li>
<li>Fix bugs and add features</li>
</ul></li>
<li><strong>Economic Alignment</strong>
<ul>
<li>Token value tied to platform success</li>
<li>Governance tokens can be traded</li>
<li>Creates stakeholder ecosystem</li>
</ul></li>
<li><strong>Ecosystem Integration</strong>
<ul>
<li>Standard interface recognized across ICP</li>
<li>Composability with other SNS DAOs</li>
<li>Access to shared governance tools</li>
</ul></li>
</ol>
<h4 id="challenges-and-considerations">Challenges and
Considerations</h4>
<ol type="1">
<li><strong>Complexity</strong>
<ul>
<li>More complicated than simple deployment</li>
<li>Requires governance expertise</li>
<li>Learning curve for community</li>
</ul></li>
<li><strong>Voter Apathy</strong>
<ul>
<li>Low participation can centralize power</li>
<li>Requires active community engagement</li>
<li>Need to incentivize voting</li>
</ul></li>
<li><strong>Governance Attacks</strong>
<ul>
<li>Whale domination if tokens concentrated</li>
<li>Proposal spam</li>
<li>Coordination problems</li>
</ul></li>
<li><strong>Launch Risk</strong>
<ul>
<li>Swap may fail if insufficient interest</li>
<li>Initial distribution critical for decentralization</li>
<li>Legal and regulatory considerations</li>
</ul></li>
</ol>
<h3 id="best-practices-for-sns-launch">11.9 Best Practices for SNS
Launch</h3>
<p>Based on successful SNS launches in the ICP ecosystem:</p>
<h4 id="pre-launch">Pre-Launch</h4>
<ol type="1">
<li><strong>Build a Community</strong>
<ul>
<li>Engage users before SNS launch</li>
<li>Create Discord/forum for governance discussions</li>
<li>Educate about voting and proposals</li>
</ul></li>
<li><strong>Transparent Tokenomics</strong>
<ul>
<li>Publish distribution plan early</li>
<li>Explain vesting schedules</li>
<li>Show clear utility for token</li>
</ul></li>
<li><strong>Demo Governance</strong>
<ul>
<li>Run mock votes before SNS</li>
<li>Gather community feedback</li>
<li>Iterate on parameters</li>
</ul></li>
</ol>
<h4 id="during-swap">During Swap</h4>
<ol type="1">
<li><strong>Clear Communication</strong>
<ul>
<li>Multi-channel announcements</li>
<li>Step-by-step participation guides</li>
<li>FAQ and support channels</li>
</ul></li>
<li><strong>Fair Access</strong>
<ul>
<li>No pre-sales or insider deals</li>
<li>Reasonable caps per participant</li>
<li>Adequate swap duration</li>
</ul></li>
<li><strong>Security</strong>
<ul>
<li>Third-party audit of SNS config</li>
<li>Emergency contacts published</li>
<li>Monitoring throughout swap</li>
</ul></li>
</ol>
<h4 id="post-launch">Post-Launch</h4>
<ol type="1">
<li><strong>Active Governance</strong>
<ul>
<li>Regular proposal cadence</li>
<li>Transparent development roadmap</li>
<li>Community calls and updates</li>
</ul></li>
<li><strong>Voting Incentives</strong>
<ul>
<li>Rewards for participation</li>
<li>Gamification of governance</li>
<li>Recognition for active voters</li>
</ul></li>
<li><strong>Continuous Improvement</strong>
<ul>
<li>Gather governance feedback</li>
<li>Adjust parameters via proposals</li>
<li>Learn from other SNS DAOs</li>
</ul></li>
</ol>
<h3 id="case-study-openpatron-sns-journey">11.10 Case Study: OpenPatron
SNS Journey</h3>
<p>Let’s envision OpenPatron’s path to SNS governance:</p>
<p><strong>Month 0-3: Pre-Launch</strong> - Deploy MVP to mainnet with
developer control - Build user base to 10K users - Form governance
working group</p>
<p><strong>Month 4-6: Community Building</strong> - Launch governance
forum - Publish SNS proposal and tokenomics - Run governance
simulations</p>
<p><strong>Month 7: Decentralization Swap</strong> - 7-day swap period -
Goal: 500+ participants, 250K ICP raised - Result: 650 participants,
380K ICP raised ✓</p>
<p><strong>Month 8: First Proposals</strong> - Proposal #1: Adjust
platform fee from 1% to 0.5% - Result: Passed (92% yes) - Proposal #2:
Add creator verification features - Result: Passed (87% yes)</p>
<p><strong>Month 12: Maturity</strong> - 25 proposals submitted - 80%
average participation rate - Token trading on DEXs - 3 major platform
upgrades via governance</p>
<p><strong>Result:</strong> OpenPatron is now truly owned by its
community, with a treasury of 380K ICP + 20M governance tokens for
future development.</p>
<h3 id="the-future-of-sns">11.11 The Future of SNS</h3>
<p>The SNS framework continues to evolve with new features:</p>
<p><strong>On the Roadmap:</strong> - <strong>Multi-sig
proposals:</strong> Require multiple neurons to co-sponsor -
<strong>Delegation markets:</strong> Trade voting power temporarily -
<strong>Cross-SNS governance:</strong> DAOs governing other DAOs -
<strong>Advanced voting:</strong> Quadratic voting, conviction voting -
<strong>Specialized neurons:</strong> Role-based governance tokens</p>
<h3 id="summary-4">11.12 Summary</h3>
<p>The Service Nervous System represents the pinnacle of decentralized
governance on the Internet Computer:</p>
<ol type="1">
<li><strong>Architecture:</strong> Multi-canister system providing
complete DAO infrastructure</li>
<li><strong>Neurons:</strong> Time-locked tokens with bonuses for
long-term commitment</li>
<li><strong>Proposals:</strong> Executable governance decisions with
automatic enforcement</li>
<li><strong>Voting:</strong> Liquid democracy with following and
rewards</li>
<li><strong>Launch:</strong> Decentralization swap for fair token
distribution</li>
<li><strong>Integration:</strong> Governance-aware canister design</li>
<li><strong>Benefits:</strong> True decentralization while maintaining
upgradeability</li>
</ol>
<p>By launching OpenPatron through an SNS, you’ve completed the journey
from concept to community-owned platform. The code you wrote now belongs
to its users, who will guide its evolution through transparent, on-chain
governance.</p>
<p>This is the promise of Web3: <strong>software as a public good,
governed by those who use it.</strong></p>
<hr />
<hr />
<h1 id="chapter-14-troubleshooting-and-best-practices">Chapter 14:
Troubleshooting and Best Practices</h1>
<p>Even experienced developers encounter specific Motoko quirks. This
comprehensive chapter outlines common compiler errors, debugging
strategies, performance optimization techniques, and security best
practices to help you build robust and efficient Internet Computer
applications.</p>
<h3 id="common-compiler-errors">12.1 Common Compiler Errors</h3>
<p>Understanding compiler errors is crucial for productive Motoko
development. Here’s an extensive guide to the most common issues you’ll
encounter.</p>
<p><strong>Table 3: Comprehensive Troubleshooting Guide</strong></p>
<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 38%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr>
<th>Error Code</th>
<th>Description</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>M0096</strong></td>
<td>Expression cannot produce expected type.</td>
<td>Check for trailing semicolons in blocks returning values. Remove
<code>;</code> from the last expression.</td>
</tr>
<tr>
<td><strong>M0031</strong></td>
<td>Type mismatch in <code>async</code> return.</td>
<td>Ensure shared functions return <code>async T</code>. All public
functions must be async.</td>
</tr>
<tr>
<td><strong>M0019</strong></td>
<td>Unbound identifier <code>null</code>.</td>
<td>Use <code>?T</code> (Option type) if a value can be null. Import
<code>Option</code> from base library.</td>
</tr>
<tr>
<td><strong>M0050</strong></td>
<td>Literal out of range for type.</td>
<td>Value exceeds type bounds. Use larger type (e.g., <code>Int</code>
instead of <code>Int8</code>).</td>
</tr>
<tr>
<td><strong>M0057</strong></td>
<td>Unbound type.</td>
<td>Import the type or define it. Check spelling and module
imports.</td>
</tr>
<tr>
<td><strong>M0070</strong></td>
<td>Shared function has non-shared parameter type.</td>
<td>Ensure all parameters are shareable (no functions, objects with
methods).</td>
</tr>
<tr>
<td><strong>M0095</strong></td>
<td>Canister has no public shared functions.</td>
<td>Add at least one <code>public shared</code> function for the
canister to be callable.</td>
</tr>
<tr>
<td><strong>M0138</strong></td>
<td>Variant case mismatch.</td>
<td>Check variant constructor names match exactly (case-sensitive).</td>
</tr>
<tr>
<td><strong>M0155</strong></td>
<td>Cycle balance depleted.</td>
<td>Top up canister cycles or optimize cycle consumption.</td>
</tr>
<tr>
<td><strong>Canister Trapped</strong></td>
<td>Runtime failure (e.g., integer underflow, out of bounds).</td>
<td>Use <code>Nat</code> carefully. Ensure arrays are not accessed out
of bounds. Add bounds checks.</td>
</tr>
</tbody>
</table>
<h4 id="trailing-semicolon-issues">12.1.1 Trailing Semicolon Issues</h4>
<p>One of the most common mistakes in Motoko is adding a semicolon after
the final expression in a block:</p>
<div class="sourceCode" id="cb181"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Wrong - semicolon makes function return ()</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">getValue</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>    result<span class="op">;</span>  <span class="co">// This returns the value correctly</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Wrong - semicolon discards the value</span></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">getValueWrong</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>    result<span class="op">;</span>  <span class="co">// ERROR: semicolon makes this return ()</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Correct</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> func <span class="fu">getValueCorrect</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>    result   <span class="co">// No semicolon on last expression</span></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="asyncawait-mismatches">12.1.2 Async/Await Mismatches</h4>
<div class="sourceCode" id="cb182"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Wrong - missing async</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">updateBalance</span>(amount<span class="op">:</span> Nat) <span class="op">:</span> Nat {</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>    balance <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    balance</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Correct</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">updateBalance</span>(amount<span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>    balance <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>    balance</span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Wrong - forgot await on async call</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">callOther</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> otherCanister<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span>  <span class="co">// Missing await</span></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>    result</span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Correct</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> shared func <span class="fu">callOther</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> <span class="cf">await</span> otherCanister<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span></span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>    result</span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="type-inference-limitations">12.1.3 Type Inference
Limitations</h4>
<p>Sometimes the compiler needs explicit type annotations:</p>
<div class="sourceCode" id="cb183"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ May fail type inference</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> items <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>items<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Better - explicit type</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> items <span class="op">:</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span> <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>items<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Or infer from initialization</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> items <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>Nat<span class="op">&gt;</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>items<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="debugging-techniques-1">12.2 Debugging Techniques</h3>
<p>Since canisters run on a remote blockchain, traditional debugging
approaches need adaptation. Here are comprehensive strategies for
effective Motoko debugging.</p>
<h4 id="debug.print-for-local-development">12.2.1 Debug.print() for
Local Development</h4>
<p><code>Debug.print()</code> is your primary debugging tool during
local development:</p>
<div class="sourceCode" id="cb184"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Int <span class="st">&quot;mo:base/Int&quot;</span><span class="op">;</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">processData</span>(<span class="dt">values</span><span class="op">:</span> [Nat]) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Processing &quot;</span> # <span class="fu">debug_show</span>(values<span class="op">.</span><span class="fu">size</span>()) # <span class="st">&quot; values&quot;</span>)<span class="op">;</span></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (v <span class="kw">in</span> values<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>            Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Processing value: &quot;</span> # <span class="fu">debug_show</span>(v))<span class="op">;</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>            sum <span class="op">+=</span> v<span class="op">;</span></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Final sum: &quot;</span> # <span class="fu">debug_show</span>(sum))<span class="op">;</span></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>        sum</span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>Important Notes:</strong> - <code>Debug.print()</code> only
works on local replicas and testnets - Output appears in dfx console,
not in canister responses - Use <code>debug_show()</code> to convert any
value to text representation - On mainnet, Debug.print calls are no-ops
(they don’t execute)</p>
<h4 id="structured-logging-pattern">12.2.2 Structured Logging
Pattern</h4>
<p>Create a logging system that can work both locally and in
production:</p>
<div class="sourceCode" id="cb185"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Time <span class="st">&quot;mo:base/Time&quot;</span><span class="op">;</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>actor Logger {</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>    type LogLevel <span class="op">=</span> {</span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>        #INFO<span class="op">;</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>        #WARN<span class="op">;</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>        #ERROR<span class="op">;</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>        #DEBUG<span class="op">;</span></span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>    type LogEntry <span class="op">=</span> {</span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> Time<span class="op">.</span><span class="at">Time</span><span class="op">;</span></span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">level</span><span class="op">:</span> LogLevel<span class="op">;</span></span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">logs</span> <span class="op">:</span> [LogEntry] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> logBuffer <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span>LogEntry<span class="op">&gt;</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Maximum logs to keep in memory</span></span>
<span id="cb185-25"><a href="#cb185-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> MAX_LOGS <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb185-26"><a href="#cb185-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-27"><a href="#cb185-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">log</span>(<span class="dt">level</span><span class="op">:</span> LogLevel<span class="op">,</span> <span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span>) {</span>
<span id="cb185-28"><a href="#cb185-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">entry</span> <span class="op">:</span> LogEntry <span class="op">=</span> {</span>
<span id="cb185-29"><a href="#cb185-29" aria-hidden="true" tabindex="-1"></a>            timestamp <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb185-30"><a href="#cb185-30" aria-hidden="true" tabindex="-1"></a>            level <span class="op">=</span> level<span class="op">;</span></span>
<span id="cb185-31"><a href="#cb185-31" aria-hidden="true" tabindex="-1"></a>            message <span class="op">=</span> message<span class="op">;</span></span>
<span id="cb185-32"><a href="#cb185-32" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb185-33"><a href="#cb185-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb185-34"><a href="#cb185-34" aria-hidden="true" tabindex="-1"></a>        logBuffer<span class="op">.</span><span class="fu">add</span>(entry)<span class="op">;</span></span>
<span id="cb185-35"><a href="#cb185-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb185-36"><a href="#cb185-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Also print locally</span></span>
<span id="cb185-37"><a href="#cb185-37" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;[&quot;</span> # <span class="fu">debug_show</span>(level) # <span class="st">&quot;] &quot;</span> # message)<span class="op">;</span></span>
<span id="cb185-38"><a href="#cb185-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb185-39"><a href="#cb185-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Keep buffer size manageable</span></span>
<span id="cb185-40"><a href="#cb185-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (logBuffer<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> MAX_LOGS) {</span>
<span id="cb185-41"><a href="#cb185-41" aria-hidden="true" tabindex="-1"></a>            ignore logBuffer<span class="op">.</span><span class="fu">remove</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb185-42"><a href="#cb185-42" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb185-43"><a href="#cb185-43" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-44"><a href="#cb185-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-45"><a href="#cb185-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">info</span>(<span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb185-46"><a href="#cb185-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span>(#INFO<span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb185-47"><a href="#cb185-47" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-48"><a href="#cb185-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-49"><a href="#cb185-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">warn</span>(<span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb185-50"><a href="#cb185-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span>(#WARN<span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb185-51"><a href="#cb185-51" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-52"><a href="#cb185-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-53"><a href="#cb185-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">error</span>(<span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb185-54"><a href="#cb185-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">log</span>(#ERROR<span class="op">,</span> message)<span class="op">;</span></span>
<span id="cb185-55"><a href="#cb185-55" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-56"><a href="#cb185-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-57"><a href="#cb185-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getLogs</span>(<span class="dt">count</span><span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> [LogEntry] {</span>
<span id="cb185-58"><a href="#cb185-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> size <span class="op">=</span> logBuffer<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb185-59"><a href="#cb185-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> start <span class="op">=</span> <span class="cf">if</span> (size <span class="op">&gt;</span> count) { size <span class="op">-</span> count } <span class="cf">else</span> { <span class="dv">0</span> }<span class="op">;</span></span>
<span id="cb185-60"><a href="#cb185-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Buffer</span><span class="op">.</span><span class="fu">toArray</span>(<span class="bu">Buffer</span><span class="op">.</span><span class="fu">subBuffer</span>(logBuffer<span class="op">,</span> start<span class="op">,</span> size <span class="op">-</span> start))</span>
<span id="cb185-61"><a href="#cb185-61" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-62"><a href="#cb185-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-63"><a href="#cb185-63" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">preupgrade</span>() {</span>
<span id="cb185-64"><a href="#cb185-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">logs</span> <span class="op">:=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="fu">toArray</span>(logBuffer)<span class="op">;</span></span>
<span id="cb185-65"><a href="#cb185-65" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-66"><a href="#cb185-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb185-67"><a href="#cb185-67" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb185-68"><a href="#cb185-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (entry <span class="kw">in</span> logs<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb185-69"><a href="#cb185-69" aria-hidden="true" tabindex="-1"></a>            logBuffer<span class="op">.</span><span class="fu">add</span>(entry)<span class="op">;</span></span>
<span id="cb185-70"><a href="#cb185-70" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb185-71"><a href="#cb185-71" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb185-72"><a href="#cb185-72" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="trap-analysis-and-error-handling">12.2.3 Trap Analysis and Error
Handling</h4>
<p>When a canister traps, it’s crucial to understand why. Implement
comprehensive error handling:</p>
<div class="sourceCode" id="cb186"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Result <span class="st">&quot;mo:base/Result&quot;</span><span class="op">;</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Error</span> <span class="st">&quot;mo:base/Error&quot;</span><span class="op">;</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>    type DatabaseError <span class="op">=</span> {</span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>        #NotFound<span class="op">;</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>        #<span class="dt">InvalidInput</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>        #<span class="dt">InternalError</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> storage <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> Nat<span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> <span class="bu">Text</span><span class="op">.</span><span class="at">equal</span><span class="op">,</span> <span class="bu">Text</span><span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad - will trap on errors</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">getValueUnsafe</span>(<span class="dt">key</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (storage<span class="op">.</span><span class="fu">get</span>(key)) {</span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> { assert <span class="kw">false</span><span class="op">;</span> <span class="dv">0</span> }<span class="op">;</span> <span class="co">// Traps!</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>v) v<span class="op">;</span></span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good - returns Result type</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">getValue</span>(<span class="dt">key</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>Nat<span class="op">,</span> DatabaseError<span class="op">&gt;</span> {</span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (storage<span class="op">.</span><span class="fu">get</span>(key)) {</span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> { #<span class="fu">err</span>(#NotFound) }<span class="op">;</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>v) { #<span class="fu">ok</span>(v) }<span class="op">;</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Better - with logging</span></span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">getValueWithLogging</span>(<span class="dt">key</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>Nat<span class="op">,</span> DatabaseError<span class="op">&gt;</span> {</span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Getting value for key: &quot;</span> # key)<span class="op">;</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (storage<span class="op">.</span><span class="fu">get</span>(key)) {</span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="kw">null</span> {</span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a>                Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Key not found: &quot;</span> # key)<span class="op">;</span></span>
<span id="cb186-36"><a href="#cb186-36" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">err</span>(#NotFound)</span>
<span id="cb186-37"><a href="#cb186-37" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb186-38"><a href="#cb186-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (<span class="op">?</span>v) {</span>
<span id="cb186-39"><a href="#cb186-39" aria-hidden="true" tabindex="-1"></a>                Debug<span class="op">.</span><span class="fu">print</span>(<span class="st">&quot;Found value: &quot;</span> # <span class="fu">debug_show</span>(v))<span class="op">;</span></span>
<span id="cb186-40"><a href="#cb186-40" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">ok</span>(v)</span>
<span id="cb186-41"><a href="#cb186-41" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb186-42"><a href="#cb186-42" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb186-43"><a href="#cb186-43" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb186-44"><a href="#cb186-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb186-45"><a href="#cb186-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle arithmetic safely</span></span>
<span id="cb186-46"><a href="#cb186-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">safeDivide</span>(<span class="dt">a</span><span class="op">:</span> Int<span class="op">,</span> <span class="dt">b</span><span class="op">:</span> Int) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>Int<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb186-47"><a href="#cb186-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (b <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb186-48"><a href="#cb186-48" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">err</span>(<span class="st">&quot;Division by zero&quot;</span>)</span>
<span id="cb186-49"><a href="#cb186-49" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb186-50"><a href="#cb186-50" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">ok</span>(a <span class="op">/</span> b)</span>
<span id="cb186-51"><a href="#cb186-51" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb186-52"><a href="#cb186-52" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb186-53"><a href="#cb186-53" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="state-inspection-and-query-functions">12.2.4 State Inspection
and Query Functions</h4>
<p>Create query functions to inspect canister state during
debugging:</p>
<div class="sourceCode" id="cb187"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">userCount</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> cache <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span><span class="bu">Text</span><span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> <span class="bu">Text</span><span class="op">.</span><span class="at">equal</span><span class="op">,</span> <span class="bu">Text</span><span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debug query functions</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">debug_getUserCount</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>        userCount</span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">debug_getCacheSize</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>        cache<span class="op">.</span><span class="fu">size</span>()</span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">debug_getCacheKeys</span>() <span class="op">:</span> <span class="kw">async</span> [<span class="bu">Text</span>] {</span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>        Iter<span class="op">.</span><span class="fu">toArray</span>(cache<span class="op">.</span><span class="fu">keys</span>())</span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">debug_getState</span>() <span class="op">:</span> <span class="kw">async</span> {</span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">userCount</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">cacheSize</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">memorySize</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>    } {</span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>            userCount <span class="op">=</span> userCount<span class="op">;</span></span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>            cacheSize <span class="op">=</span> cache<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>            memorySize <span class="op">=</span> Prim<span class="op">.</span><span class="fu">rts_memory_size</span>()<span class="op">;</span></span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="best-practices-2">12.3 Best Practices</h3>
<p>Following established best practices will help you write
maintainable, secure, and efficient Motoko code.</p>
<h4 id="code-organization">12.3.1 Code Organization</h4>
<p><strong>Modularization:</strong></p>
<div class="sourceCode" id="cb188"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co">// types.mo - Centralize type definitions</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>module Types {</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> type User <span class="op">=</span> {</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">id</span><span class="op">:</span> Principal<span class="op">;</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">email</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">createdAt</span><span class="op">:</span> Int<span class="op">;</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> type Post <span class="op">=</span> {</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">id</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">author</span><span class="op">:</span> Principal<span class="op">;</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">content</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> Int<span class="op">;</span></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a><span class="co">// utils.mo - Reusable utility functions</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>module Utils {</span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">validateEmail</span>(<span class="dt">email</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> Bool {</span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Text</span><span class="op">.</span><span class="fu">contains</span>(email<span class="op">,</span> #text <span class="st">&quot;@&quot;</span>) and <span class="bu">Text</span><span class="op">.</span><span class="fu">size</span>(email) <span class="op">&gt;</span> <span class="dv">3</span></span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">sanitizeInput</span>(<span class="dt">input</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Remove potentially dangerous characters</span></span>
<span id="cb188-28"><a href="#cb188-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Text</span><span class="op">.</span><span class="fu">trim</span>(input<span class="op">,</span> #text <span class="st">&quot; </span><span class="sc">\n\t\r</span><span class="st">&quot;</span>)</span>
<span id="cb188-29"><a href="#cb188-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb188-30"><a href="#cb188-30" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb188-31"><a href="#cb188-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-32"><a href="#cb188-32" aria-hidden="true" tabindex="-1"></a><span class="co">// main.mo - Main actor</span></span>
<span id="cb188-33"><a href="#cb188-33" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Types <span class="st">&quot;types&quot;</span><span class="op">;</span></span>
<span id="cb188-34"><a href="#cb188-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Utils <span class="st">&quot;utils&quot;</span><span class="op">;</span></span>
<span id="cb188-35"><a href="#cb188-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-36"><a href="#cb188-36" aria-hidden="true" tabindex="-1"></a>actor Main {</span>
<span id="cb188-37"><a href="#cb188-37" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users</span> <span class="op">:</span> [Types<span class="op">.</span><span class="at">User</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb188-38"><a href="#cb188-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb188-39"><a href="#cb188-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">registerUser</span>(<span class="dt">name</span><span class="op">:</span> <span class="bu">Text</span><span class="op">,</span> <span class="dt">email</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb188-40"><a href="#cb188-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (not Utils<span class="op">.</span><span class="fu">validateEmail</span>(email)) {</span>
<span id="cb188-41"><a href="#cb188-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #<span class="fu">err</span>(<span class="st">&quot;Invalid email format&quot;</span>)<span class="op">;</span></span>
<span id="cb188-42"><a href="#cb188-42" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb188-43"><a href="#cb188-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb188-44"><a href="#cb188-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="dt">newUser</span> <span class="op">:</span> Types<span class="op">.</span><span class="at">User</span> <span class="op">=</span> {</span>
<span id="cb188-45"><a href="#cb188-45" aria-hidden="true" tabindex="-1"></a>            id <span class="op">=</span> msg<span class="op">.</span><span class="at">caller</span><span class="op">;</span></span>
<span id="cb188-46"><a href="#cb188-46" aria-hidden="true" tabindex="-1"></a>            name <span class="op">=</span> Utils<span class="op">.</span><span class="fu">sanitizeInput</span>(name)<span class="op">;</span></span>
<span id="cb188-47"><a href="#cb188-47" aria-hidden="true" tabindex="-1"></a>            email <span class="op">=</span> email<span class="op">;</span></span>
<span id="cb188-48"><a href="#cb188-48" aria-hidden="true" tabindex="-1"></a>            createdAt <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb188-49"><a href="#cb188-49" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb188-50"><a href="#cb188-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb188-51"><a href="#cb188-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add user logic...</span></span>
<span id="cb188-52"><a href="#cb188-52" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>(())</span>
<span id="cb188-53"><a href="#cb188-53" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb188-54"><a href="#cb188-54" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="stable-memory-management">12.3.2 Stable Memory Management</h4>
<div class="sourceCode" id="cb189"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Iter <span class="st">&quot;mo:base/Iter&quot;</span><span class="op">;</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad - will lose data on upgrade</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> users <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> User<span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good - stable storage with upgrade hooks</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">stableUsers</span> <span class="op">:</span> [(Principal<span class="op">,</span> User)] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> users <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> User<span class="op">&gt;</span>(<span class="dv">10</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">preupgrade</span>() {</span>
<span id="cb189-14"><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stableUsers</span> <span class="op">:=</span> Iter<span class="op">.</span><span class="fu">toArray</span>(users<span class="op">.</span><span class="fu">entries</span>())<span class="op">;</span></span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb189-16"><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-17"><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb189-18"><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">users</span> <span class="op">:=</span> HashMap<span class="op">.</span><span class="at">fromIter</span><span class="op">&lt;</span>Principal<span class="op">,</span> User<span class="op">&gt;</span>(</span>
<span id="cb189-19"><a href="#cb189-19" aria-hidden="true" tabindex="-1"></a>            stableUsers<span class="op">.</span><span class="fu">vals</span>()<span class="op">,</span></span>
<span id="cb189-20"><a href="#cb189-20" aria-hidden="true" tabindex="-1"></a>            <span class="dv">10</span><span class="op">,</span></span>
<span id="cb189-21"><a href="#cb189-21" aria-hidden="true" tabindex="-1"></a>            Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span></span>
<span id="cb189-22"><a href="#cb189-22" aria-hidden="true" tabindex="-1"></a>            Principal<span class="op">.</span><span class="at">hash</span></span>
<span id="cb189-23"><a href="#cb189-23" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb189-24"><a href="#cb189-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stableUsers</span> <span class="op">:=</span> []<span class="op">;</span>  <span class="co">// Free memory</span></span>
<span id="cb189-25"><a href="#cb189-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb189-26"><a href="#cb189-26" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="cycle-management">12.3.3 Cycle Management</h4>
<p>Always monitor and manage cycles proactively:</p>
<div class="sourceCode" id="cb190"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Cycles <span class="st">&quot;mo:base/ExperimentalCycles&quot;</span><span class="op">;</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Error</span> <span class="st">&quot;mo:base/Error&quot;</span><span class="op">;</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">MINIMUM_CYCLES</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">1_000_000_000_000</span><span class="op">;</span> <span class="co">// 1T cycles</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="dt">CYCLE_THRESHOLD</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">5_000_000_000_000</span><span class="op">;</span> <span class="co">// 5T cycles</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">checkCycleBalance</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>        Cycles<span class="op">.</span><span class="fu">balance</span>()</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">acceptCycles</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> available <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">available</span>()<span class="op">;</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accepted <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">accept</span>(available)<span class="op">;</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>        accepted</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check cycles before expensive operations</span></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">ensureSufficientCycles</span>() <span class="op">:</span> Bool {</span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>        Cycles<span class="op">.</span><span class="fu">balance</span>() <span class="op">&gt;=</span> MINIMUM_CYCLES</span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">expensiveOperation</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (not <span class="fu">ensureSufficientCycles</span>()) {</span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #<span class="fu">err</span>(<span class="st">&quot;Insufficient cycles&quot;</span>)<span class="op">;</span></span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform operation...</span></span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>(())</span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Monitor and alert on low cycles</span></span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">needsCycleTopup</span>() <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a>        Cycles<span class="op">.</span><span class="fu">balance</span>() <span class="op">&lt;</span> CYCLE_THRESHOLD</span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="security-best-practices">12.3.4 Security Best Practices</h4>
<p><strong>Authentication and Authorization:</strong></p>
<div class="sourceCode" id="cb191"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Principal <span class="st">&quot;mo:base/Principal&quot;</span><span class="op">;</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Result <span class="st">&quot;mo:base/Result&quot;</span><span class="op">;</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>actor SecureCanister {</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">owner</span> <span class="op">:</span> Principal <span class="op">=</span> Principal<span class="op">.</span><span class="fu">fromText</span>(<span class="st">&quot;aaaaa-aa&quot;</span>)<span class="op">;</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">admins</span> <span class="op">:</span> [Principal] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Role-based access control</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    type Role <span class="op">=</span> {</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>        #Owner<span class="op">;</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>        #Admin<span class="op">;</span></span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>        #User<span class="op">;</span></span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">getRole</span>(<span class="dt">caller</span><span class="op">:</span> Principal) <span class="op">:</span> Role {</span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (caller <span class="op">==</span> owner) {</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #Owner<span class="op">;</span></span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="at">find</span><span class="op">&lt;</span>Principal<span class="op">&gt;</span>(admins<span class="op">,</span> <span class="fu">func</span>(p) { p <span class="op">==</span> caller }) <span class="op">!=</span> <span class="kw">null</span>) {</span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #Admin<span class="op">;</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>        #User</span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> func <span class="fu">requireRole</span>(<span class="dt">caller</span><span class="op">:</span> Principal<span class="op">,</span> <span class="dt">required</span><span class="op">:</span> Role) <span class="op">:</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> role <span class="op">=</span> <span class="fu">getRole</span>(caller)<span class="op">;</span></span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (role<span class="op">,</span> required) {</span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#Owner<span class="op">,</span> _) { #<span class="fu">ok</span>(()) }<span class="op">;</span>  <span class="co">// Owner can do anything</span></span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#Admin<span class="op">,</span> #Admin) { #<span class="fu">ok</span>(()) }<span class="op">;</span></span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#Admin<span class="op">,</span> #User) { #<span class="fu">ok</span>(()) }<span class="op">;</span></span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#User<span class="op">,</span> #User) { #<span class="fu">ok</span>(()) }<span class="op">;</span></span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (_<span class="op">,</span> _) { #<span class="fu">err</span>(<span class="st">&quot;Insufficient permissions&quot;</span>) }<span class="op">;</span></span>
<span id="cb191-34"><a href="#cb191-34" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb191-35"><a href="#cb191-35" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb191-36"><a href="#cb191-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-37"><a href="#cb191-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Always validate caller identity</span></span>
<span id="cb191-38"><a href="#cb191-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">adminOnlyFunction</span>() <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb191-39"><a href="#cb191-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> (<span class="fu">requireRole</span>(msg<span class="op">.</span><span class="at">caller</span><span class="op">,</span> #Admin)) {</span>
<span id="cb191-40"><a href="#cb191-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">ok</span>(_)) {</span>
<span id="cb191-41"><a href="#cb191-41" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Perform admin operation</span></span>
<span id="cb191-42"><a href="#cb191-42" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">ok</span>(())</span>
<span id="cb191-43"><a href="#cb191-43" aria-hidden="true" tabindex="-1"></a>            }<span class="op">;</span></span>
<span id="cb191-44"><a href="#cb191-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> (#<span class="fu">err</span>(e)) { #<span class="fu">err</span>(e) }<span class="op">;</span></span>
<span id="cb191-45"><a href="#cb191-45" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb191-46"><a href="#cb191-46" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb191-47"><a href="#cb191-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-48"><a href="#cb191-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prevent unauthorized access</span></span>
<span id="cb191-49"><a href="#cb191-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">shared</span>(msg) func <span class="fu">sensitiveOperation</span>(<span class="dt">amount</span><span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb191-50"><a href="#cb191-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate caller</span></span>
<span id="cb191-51"><a href="#cb191-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Principal<span class="op">.</span><span class="fu">isAnonymous</span>(msg<span class="op">.</span><span class="at">caller</span>)) {</span>
<span id="cb191-52"><a href="#cb191-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #<span class="fu">err</span>(<span class="st">&quot;Anonymous callers not allowed&quot;</span>)<span class="op">;</span></span>
<span id="cb191-53"><a href="#cb191-53" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb191-54"><a href="#cb191-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb191-55"><a href="#cb191-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate input</span></span>
<span id="cb191-56"><a href="#cb191-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (amount <span class="op">==</span> <span class="dv">0</span> or amount <span class="op">&gt;</span> <span class="dv">1_000_000</span>) {</span>
<span id="cb191-57"><a href="#cb191-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> #<span class="fu">err</span>(<span class="st">&quot;Invalid amount&quot;</span>)<span class="op">;</span></span>
<span id="cb191-58"><a href="#cb191-58" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb191-59"><a href="#cb191-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb191-60"><a href="#cb191-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform operation...</span></span>
<span id="cb191-61"><a href="#cb191-61" aria-hidden="true" tabindex="-1"></a>        #<span class="fu">ok</span>(())</span>
<span id="cb191-62"><a href="#cb191-62" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb191-63"><a href="#cb191-63" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p><strong>Input Validation:</strong></p>
<div class="sourceCode" id="cb192"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>module Validation {</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="bu">Text</span> <span class="st">&quot;mo:base/Text&quot;</span><span class="op">;</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> Nat <span class="st">&quot;mo:base/Nat&quot;</span><span class="op">;</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">validateText</span>(<span class="dt">input</span><span class="op">:</span> <span class="bu">Text</span><span class="op">,</span> <span class="dt">minLen</span><span class="op">:</span> Nat<span class="op">,</span> <span class="dt">maxLen</span><span class="op">:</span> Nat) <span class="op">:</span> Bool {</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> len <span class="op">=</span> <span class="bu">Text</span><span class="op">.</span><span class="fu">size</span>(input)<span class="op">;</span></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>        len <span class="op">&gt;=</span> minLen and len <span class="op">&lt;=</span> maxLen</span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">validateNat</span>(<span class="dt">input</span><span class="op">:</span> Nat<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> Nat<span class="op">,</span> <span class="dt">max</span><span class="op">:</span> Nat) <span class="op">:</span> Bool {</span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>        input <span class="op">&gt;=</span> min and input <span class="op">&lt;=</span> max</span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">sanitizeText</span>(<span class="dt">input</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Remove null bytes and control characters</span></span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Text</span><span class="op">.</span><span class="fu">translate</span>(input<span class="op">,</span> <span class="fu">func</span>(<span class="dt">c</span><span class="op">:</span> Char) <span class="op">:</span> <span class="bu">Text</span> {</span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (c <span class="op">==</span> <span class="st">&#39;</span><span class="sc">\0</span><span class="st">&#39;</span> or c <span class="op">&lt;</span> <span class="st">&#39; &#39;</span>) { <span class="st">&quot;&quot;</span> } <span class="cf">else</span> { <span class="bu">Text</span><span class="op">.</span><span class="fu">fromChar</span>(c) }</span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">isValidPrincipal</span>(<span class="dt">p</span><span class="op">:</span> Principal) <span class="op">:</span> Bool {</span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a>        not Principal<span class="op">.</span><span class="fu">isAnonymous</span>(p)</span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="performance-optimization">12.4 Performance Optimization</h3>
<h4 id="data-structure-selection">12.4.1 Data Structure Selection</h4>
<p>Choose the right data structure for your use case:</p>
<div class="sourceCode" id="cb193"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> HashMap <span class="st">&quot;mo:base/HashMap&quot;</span><span class="op">;</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> RBTree <span class="st">&quot;mo:base/RBTree&quot;</span><span class="op">;</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Buffer</span> <span class="st">&quot;mo:base/Buffer&quot;</span><span class="op">;</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> <span class="bu">Array</span> <span class="st">&quot;mo:base/Array&quot;</span><span class="op">;</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use HashMap for fast lookups by key (O(1) average)</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> userCache <span class="op">=</span> HashMap<span class="op">.</span><span class="at">HashMap</span><span class="op">&lt;</span>Principal<span class="op">,</span> User<span class="op">&gt;</span>(<span class="dv">100</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">equal</span><span class="op">,</span> Principal<span class="op">.</span><span class="at">hash</span>)<span class="op">;</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use RBTree for sorted data and range queries (O(log n))</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> sortedScores <span class="op">=</span> RBTree<span class="op">.</span><span class="at">RBTree</span><span class="op">&lt;</span>Nat<span class="op">,</span> User<span class="op">&gt;</span>(Nat<span class="op">.</span><span class="at">compare</span>)<span class="op">;</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use Buffer for dynamic arrays with frequent additions (O(1) amortized)</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> eventLog <span class="op">=</span> <span class="bu">Buffer</span><span class="op">.</span><span class="at">Buffer</span><span class="op">&lt;</span><span class="bu">Event</span><span class="op">&gt;</span>(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use Array for immutable, fixed-size collections</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">constants</span> <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> [<span class="st">&quot;value1&quot;</span><span class="op">,</span> <span class="st">&quot;value2&quot;</span><span class="op">,</span> <span class="st">&quot;value3&quot;</span>]<span class="op">;</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="minimize-state-access">12.4.2 Minimize State Access</h4>
<div class="sourceCode" id="cb194"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">largeState</span> <span class="op">:</span> [User] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad - multiple iterations over stable state</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getActiveUsersCount</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (user <span class="kw">in</span> largeState<span class="op">.</span><span class="fu">vals</span>()) {</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (user<span class="op">.</span><span class="at">active</span>) { count <span class="op">+=</span> <span class="dv">1</span> }<span class="op">;</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>        count</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Better - maintain derived state</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">activeUserCount</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addUser</span>(<span class="dt">user</span><span class="op">:</span> User) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">largeState</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(largeState<span class="op">,</span> [user])<span class="op">;</span></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (user<span class="op">.</span><span class="at">active</span>) {</span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>            activeUserCount <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getActiveUsersCountOptimized</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a>        activeUserCount  <span class="co">// O(1) instead of O(n)</span></span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="batch-operations-1">12.4.3 Batch Operations</h4>
<div class="sourceCode" id="cb195"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad - multiple separate calls</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">addUser</span>(<span class="dt">user</span><span class="op">:</span> User) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process one user</span></span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good - batch processing</span></span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">addUsers</span>(<span class="dt">users</span><span class="op">:</span> [User]) <span class="op">:</span> <span class="kw">async</span> [Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span>] {</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Array</span><span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>User<span class="op">,</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;&gt;</span>(</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>            users<span class="op">,</span></span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">func</span>(user) {</span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Validate and process each user</span></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Return result</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>                #<span class="fu">ok</span>(())</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="query-vs-update-calls">12.4.4 Query vs Update Calls</h4>
<div class="sourceCode" id="cb196"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">counter</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">cache</span> <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use query for read-only operations (faster, no consensus)</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getCounter</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>        counter</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getCache</span>() <span class="op">:</span> <span class="kw">async</span> <span class="bu">Text</span> {</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>        cache</span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use update calls only when modifying state</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">incrementCounter</span>() <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a>        counter</span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb196-20"><a href="#cb196-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use composite queries for efficient multi-canister reads</span></span>
<span id="cb196-21"><a href="#cb196-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> composite query func <span class="fu">getMultipleValues</span>() <span class="op">:</span> <span class="kw">async</span> {</span>
<span id="cb196-22"><a href="#cb196-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">local</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb196-23"><a href="#cb196-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">remote</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb196-24"><a href="#cb196-24" aria-hidden="true" tabindex="-1"></a>    } {</span>
<span id="cb196-25"><a href="#cb196-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> remoteValue <span class="op">=</span> <span class="cf">await</span> otherCanister<span class="op">.</span><span class="fu">getValue</span>()<span class="op">;</span>  <span class="co">// Query call</span></span>
<span id="cb196-26"><a href="#cb196-26" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb196-27"><a href="#cb196-27" aria-hidden="true" tabindex="-1"></a>            local <span class="op">=</span> counter<span class="op">;</span></span>
<span id="cb196-28"><a href="#cb196-28" aria-hidden="true" tabindex="-1"></a>            remote <span class="op">=</span> remoteValue<span class="op">;</span></span>
<span id="cb196-29"><a href="#cb196-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb196-30"><a href="#cb196-30" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb196-31"><a href="#cb196-31" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="testing-strategies-1">12.5 Testing Strategies</h3>
<h4 id="unit-testing-with-motoko-test">12.5.1 Unit Testing with Motoko
Test</h4>
<div class="sourceCode" id="cb197"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co">// test/utils.test.mo</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Debug <span class="st">&quot;mo:base/Debug&quot;</span><span class="op">;</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { test<span class="op">;</span> suite } <span class="st">&quot;mo:test&quot;</span><span class="op">;</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Utils <span class="st">&quot;../src/utils&quot;</span><span class="op">;</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a><span class="fu">suite</span>(<span class="st">&quot;Utils Tests&quot;</span><span class="op">,</span> <span class="fu">func</span>() {</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test</span>(<span class="st">&quot;validateEmail with valid email&quot;</span><span class="op">,</span> <span class="fu">func</span>() {</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> Utils<span class="op">.</span><span class="fu">validateEmail</span>(<span class="st">&quot;user@example.com&quot;</span>)<span class="op">;</span></span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>        assert result <span class="op">==</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test</span>(<span class="st">&quot;validateEmail with invalid email&quot;</span><span class="op">,</span> <span class="fu">func</span>() {</span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> Utils<span class="op">.</span><span class="fu">validateEmail</span>(<span class="st">&quot;invalid&quot;</span>)<span class="op">;</span></span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>        assert result <span class="op">==</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">test</span>(<span class="st">&quot;sanitizeInput removes whitespace&quot;</span><span class="op">,</span> <span class="fu">func</span>() {</span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> Utils<span class="op">.</span><span class="fu">sanitizeInput</span>(<span class="st">&quot;  test  &quot;</span>)<span class="op">;</span></span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a>        assert result <span class="op">==</span> <span class="st">&quot;test&quot;</span><span class="op">;</span></span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h4 id="integration-testing">12.5.2 Integration Testing</h4>
<div class="sourceCode" id="cb198"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="co"># test/integration.sh</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Start local replica</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> start <span class="at">--background</span> <span class="at">--clean</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy canisters</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> deploy</span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Run test scenarios</span></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister call my_canister addUser <span class="st">&#39;(record { name = &quot;Alice&quot;; email = &quot;alice@example.com&quot; })&#39;</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> canister call my_canister getUser <span class="st">&#39;(principal &quot;aaaaa-aa&quot;)&#39;</span></span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify results</span></span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a><span class="va">RESULT</span><span class="op">=</span><span class="va">$(</span><span class="ex">dfx</span> canister call my_canister getUserCount<span class="va">)</span></span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$RESULT</span><span class="st">&quot;</span> <span class="ot">!=</span> <span class="st">&quot;(1 : nat)&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Test failed: Expected user count 1&quot;</span></span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;All integration tests passed&quot;</span></span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a><span class="ex">dfx</span> stop</span></code></pre></div>
<h3 id="common-pitfalls-and-solutions">12.6 Common Pitfalls and
Solutions</h3>
<h4 id="integer-overflowunderflow">12.6.1 Integer
Overflow/Underflow</h4>
<div class="sourceCode" id="cb199"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Nat <span class="st">&quot;mo:base/Nat&quot;</span><span class="op">;</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> Int <span class="st">&quot;mo:base/Int&quot;</span><span class="op">;</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad - can trap on underflow</span></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">unsafeSubtract</span>(<span class="dt">a</span><span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span><span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Nat {</span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>        a <span class="op">-</span> b  <span class="co">// Traps if b &gt; a</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good - safe subtraction</span></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">safeSubtract</span>(<span class="dt">a</span><span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span><span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Result<span class="op">.</span><span class="at">Result</span><span class="op">&lt;</span>Nat<span class="op">,</span> <span class="bu">Text</span><span class="op">&gt;</span> {</span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (b <span class="op">&gt;</span> a) {</span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">err</span>(<span class="st">&quot;Underflow: b &gt; a&quot;</span>)</span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>            #<span class="fu">ok</span>(a <span class="op">-</span> b)</span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Use Int for values that can be negative</span></span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">safeDifference</span>(<span class="dt">a</span><span class="op">:</span> Nat<span class="op">,</span> <span class="dt">b</span><span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> Int {</span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>        Int<span class="op">.</span><span class="fu">abs</span>(a) <span class="op">-</span> Int<span class="op">.</span><span class="fu">abs</span>(b)</span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="memory-leaks">12.6.2 Memory Leaks</h4>
<div class="sourceCode" id="cb200"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ❌ Bad - unbounded growth</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="dt">logs</span> <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addLog</span>(<span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">logs</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(logs<span class="op">,</span> [message])<span class="op">;</span>  <span class="co">// Grows forever</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ✅ Good - bounded with rotation</span></span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">logs</span> <span class="op">:</span> [<span class="bu">Text</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> MAX_LOGS <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> func <span class="fu">addLogBounded</span>(<span class="dt">message</span><span class="op">:</span> <span class="bu">Text</span>) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">logs</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">append</span>(logs<span class="op">,</span> [message])<span class="op">;</span></span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (logs<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> MAX_LOGS) {</span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">logs</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">subArray</span>(logs<span class="op">,</span> logs<span class="op">.</span><span class="fu">size</span>() <span class="op">-</span> MAX_LOGS<span class="op">,</span> MAX_LOGS)<span class="op">;</span></span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb200-19"><a href="#cb200-19" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="upgrade-compatibility">12.6.3 Upgrade Compatibility</h4>
<div class="sourceCode" id="cb201"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>actor {</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Version 1</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users_v1</span> <span class="op">:</span> [(Principal<span class="op">,</span> <span class="bu">Text</span>)] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Version 2 - Adding fields</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>    type UserV2 <span class="op">=</span> {</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">name</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">email</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">createdAt</span><span class="op">:</span> Int<span class="op">;</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">users_v2</span> <span class="op">:</span> [(Principal<span class="op">,</span> UserV2)] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>    system func <span class="fu">postupgrade</span>() {</span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Migrate from v1 to v2</span></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (users_v1<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> <span class="dv">0</span> and users_v2<span class="op">.</span><span class="fu">size</span>() <span class="op">==</span> <span class="dv">0</span>) {</span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">users_v2</span> <span class="op">:=</span> <span class="bu">Array</span><span class="op">.</span><span class="at">map</span><span class="op">&lt;</span>(Principal<span class="op">,</span> <span class="bu">Text</span>)<span class="op">,</span> (Principal<span class="op">,</span> UserV2)<span class="op">&gt;</span>(</span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>                users_v1<span class="op">,</span></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>                <span class="fu">func</span>((id<span class="op">,</span> name)) {</span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>                    (id<span class="op">,</span> {</span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a>                        name <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>                        email <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span>  <span class="co">// Default value</span></span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>                        createdAt <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a>            <span class="dt">users_v1</span> <span class="op">:=</span> []<span class="op">;</span>  <span class="co">// Clear old data</span></span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="monitoring-and-maintenance-1">12.7 Monitoring and
Maintenance</h3>
<h4 id="health-checks">12.7.1 Health Checks</h4>
<div class="sourceCode" id="cb202"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>actor HealthMonitor {</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">lastHealthCheck</span> <span class="op">:</span> Int <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">healthStatus</span> <span class="op">:</span> <span class="bu">Text</span> <span class="op">=</span> <span class="st">&quot;OK&quot;</span><span class="op">;</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">health</span>() <span class="op">:</span> <span class="kw">async</span> {</span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">status</span><span class="op">:</span> <span class="bu">Text</span><span class="op">;</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">timestamp</span><span class="op">:</span> Int<span class="op">;</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">cycles</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">memorySize</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>    } {</span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> healthStatus<span class="op">;</span></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>            timestamp <span class="op">=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>            cycles <span class="op">=</span> Cycles<span class="op">.</span><span class="fu">balance</span>()<span class="op">;</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>            memorySize <span class="op">=</span> Prim<span class="op">.</span><span class="fu">rts_memory_size</span>()<span class="op">;</span></span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb202-18"><a href="#cb202-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb202-19"><a href="#cb202-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">performHealthCheck</span>() <span class="op">:</span> <span class="kw">async</span> Bool {</span>
<span id="cb202-20"><a href="#cb202-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">lastHealthCheck</span> <span class="op">:=</span> Time<span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb202-21"><a href="#cb202-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-22"><a href="#cb202-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check cycles</span></span>
<span id="cb202-23"><a href="#cb202-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Cycles<span class="op">.</span><span class="fu">balance</span>() <span class="op">&lt;</span> <span class="dv">1_000_000_000_000</span>) {</span>
<span id="cb202-24"><a href="#cb202-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">healthStatus</span> <span class="op">:=</span> <span class="st">&quot;WARN: Low cycles&quot;</span><span class="op">;</span></span>
<span id="cb202-25"><a href="#cb202-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb202-26"><a href="#cb202-26" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb202-27"><a href="#cb202-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-28"><a href="#cb202-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check memory</span></span>
<span id="cb202-29"><a href="#cb202-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (Prim<span class="op">.</span><span class="fu">rts_memory_size</span>() <span class="op">&gt;</span> <span class="dv">3_000_000_000</span>) {</span>
<span id="cb202-30"><a href="#cb202-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">healthStatus</span> <span class="op">:=</span> <span class="st">&quot;WARN: High memory usage&quot;</span><span class="op">;</span></span>
<span id="cb202-31"><a href="#cb202-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb202-32"><a href="#cb202-32" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb202-33"><a href="#cb202-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb202-34"><a href="#cb202-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">healthStatus</span> <span class="op">:=</span> <span class="st">&quot;OK&quot;</span><span class="op">;</span></span>
<span id="cb202-35"><a href="#cb202-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">true</span></span>
<span id="cb202-36"><a href="#cb202-36" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb202-37"><a href="#cb202-37" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h4 id="metrics-collection">12.7.2 Metrics Collection</h4>
<div class="sourceCode" id="cb203"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>actor Metrics {</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">requestCount</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">errorCount</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>    stable <span class="kw">var</span> <span class="dt">totalLatency</span> <span class="op">:</span> Nat <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">incrementRequests</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>        requestCount <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">recordError</span>() <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a>        errorCount <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> shared func <span class="fu">recordLatency</span>(<span class="dt">latency</span><span class="op">:</span> Nat) <span class="op">:</span> <span class="kw">async</span> () {</span>
<span id="cb203-15"><a href="#cb203-15" aria-hidden="true" tabindex="-1"></a>        totalLatency <span class="op">+=</span> latency<span class="op">;</span></span>
<span id="cb203-16"><a href="#cb203-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb203-17"><a href="#cb203-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb203-18"><a href="#cb203-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> query func <span class="fu">getMetrics</span>() <span class="op">:</span> <span class="kw">async</span> {</span>
<span id="cb203-19"><a href="#cb203-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">requests</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb203-20"><a href="#cb203-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">errors</span><span class="op">:</span> Nat<span class="op">;</span></span>
<span id="cb203-21"><a href="#cb203-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">avgLatency</span><span class="op">:</span> Float<span class="op">;</span></span>
<span id="cb203-22"><a href="#cb203-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">errorRate</span><span class="op">:</span> Float<span class="op">;</span></span>
<span id="cb203-23"><a href="#cb203-23" aria-hidden="true" tabindex="-1"></a>    } {</span>
<span id="cb203-24"><a href="#cb203-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> avgLatency <span class="op">=</span> <span class="cf">if</span> (requestCount <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb203-25"><a href="#cb203-25" aria-hidden="true" tabindex="-1"></a>            Float<span class="op">.</span><span class="fu">fromInt</span>(totalLatency) <span class="op">/</span> Float<span class="op">.</span><span class="fu">fromInt</span>(requestCount)</span>
<span id="cb203-26"><a href="#cb203-26" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb203-27"><a href="#cb203-27" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.0</span></span>
<span id="cb203-28"><a href="#cb203-28" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb203-29"><a href="#cb203-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb203-30"><a href="#cb203-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> errorRate <span class="op">=</span> <span class="cf">if</span> (requestCount <span class="op">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb203-31"><a href="#cb203-31" aria-hidden="true" tabindex="-1"></a>            Float<span class="op">.</span><span class="fu">fromInt</span>(errorCount) <span class="op">/</span> Float<span class="op">.</span><span class="fu">fromInt</span>(requestCount)</span>
<span id="cb203-32"><a href="#cb203-32" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb203-33"><a href="#cb203-33" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.0</span></span>
<span id="cb203-34"><a href="#cb203-34" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb203-35"><a href="#cb203-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb203-36"><a href="#cb203-36" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb203-37"><a href="#cb203-37" aria-hidden="true" tabindex="-1"></a>            requests <span class="op">=</span> requestCount<span class="op">;</span></span>
<span id="cb203-38"><a href="#cb203-38" aria-hidden="true" tabindex="-1"></a>            errors <span class="op">=</span> errorCount<span class="op">;</span></span>
<span id="cb203-39"><a href="#cb203-39" aria-hidden="true" tabindex="-1"></a>            avgLatency <span class="op">=</span> avgLatency<span class="op">;</span></span>
<span id="cb203-40"><a href="#cb203-40" aria-hidden="true" tabindex="-1"></a>            errorRate <span class="op">=</span> errorRate<span class="op">;</span></span>
<span id="cb203-41"><a href="#cb203-41" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb203-42"><a href="#cb203-42" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb203-43"><a href="#cb203-43" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<h3 id="summary-5">12.8 Summary</h3>
<p>Effective troubleshooting and following best practices are essential
for building production-ready Internet Computer applications. Key
takeaways:</p>
<ol type="1">
<li><strong>Understand Common Errors</strong>: Familiarize yourself with
compiler error codes and their solutions.</li>
<li><strong>Debug Effectively</strong>: Use structured logging and query
functions to inspect state.</li>
<li><strong>Handle Errors Gracefully</strong>: Always use Result types
for operations that can fail.</li>
<li><strong>Secure Your Code</strong>: Implement proper authentication,
authorization, and input validation.</li>
<li><strong>Optimize Performance</strong>: Choose appropriate data
structures and minimize state access.</li>
<li><strong>Test Thoroughly</strong>: Write unit and integration tests
for critical functionality.</li>
<li><strong>Monitor in Production</strong>: Implement health checks and
metrics collection.</li>
<li><strong>Plan for Upgrades</strong>: Design stable variables and
migration strategies from the start.</li>
</ol>
<p>By following these practices, you’ll write more robust, maintainable,
and efficient Motoko applications.</p>
<hr />
<hr />
<h1 id="resources">Resources</h1>
<p>This chapter provides a curated list of essential resources for
Motoko and Internet Computer development. Whether you’re just starting
out or looking for advanced references, these links will help you deepen
your knowledge and stay current with the ecosystem.</p>
<h2 id="official-documentation">Official Documentation</h2>
<h3 id="motoko-language">Motoko Language</h3>
<ul>
<li><p><strong>Motoko Programming Language Guide</strong><br />
<a
href="https://internetcomputer.org/docs/motoko/home">https://internetcomputer.org/docs/motoko/home</a><br />
The official guide to Motoko programming, covering syntax, features, and
best practices.</p></li>
<li><p><strong>Motoko Base Library</strong><br />
<a
href="https://internetcomputer.org/docs/motoko/base/">https://internetcomputer.org/docs/motoko/base/</a><br />
Complete reference for Motoko’s standard library modules.</p></li>
<li><p><strong>Motoko Language Reference</strong><br />
<a
href="https://internetcomputer.org/docs/motoko/language-manual">https://internetcomputer.org/docs/motoko/language-manual</a><br />
Comprehensive language specification and reference manual.</p></li>
</ul>
<h3 id="internet-computer-protocol">Internet Computer Protocol</h3>
<ul>
<li><p><strong>Internet Computer Developer Documentation</strong><br />
<a
href="https://internetcomputer.org/docs/home">https://internetcomputer.org/docs/home</a><br />
Main developer portal for Internet Computer documentation.</p></li>
<li><p><strong>Internet Computer Specification</strong><br />
<a
href="https://internetcomputer.org/docs/references/ic-interface-spec">https://internetcomputer.org/docs/references/ic-interface-spec</a><br />
Technical specification of the Internet Computer Protocol.</p></li>
<li><p><strong>ICP Developer Journey</strong><br />
<a
href="https://internetcomputer.org/docs/tutorials/developer-liftoff/">https://internetcomputer.org/docs/tutorials/developer-liftoff/</a><br />
Step-by-step tutorials for building on the Internet Computer.</p></li>
</ul>
<h2 id="service-nervous-system-sns">Service Nervous System (SNS)</h2>
<ul>
<li><p><strong>SNS Documentation</strong><br />
<a
href="https://internetcomputer.org/docs/building-apps/governing-apps/">https://internetcomputer.org/docs/building-apps/governing-apps/</a><br />
Complete guide to creating and managing decentralized autonomous
organizations.</p></li>
<li><p><strong>SNS Launch Guide</strong><br />
<a
href="https://internetcomputer.org/docs/building-apps/governing-apps/launching/">https://internetcomputer.org/docs/building-apps/governing-apps/launching/</a><br />
Step-by-step process for launching an SNS.</p></li>
</ul>
<h2 id="community-and-learning-resources">Community and Learning
Resources</h2>
<h3 id="official-community-channels">Official Community Channels</h3>
<ul>
<li><p><strong>DFINITY Forum</strong><br />
<a
href="https://forum.dfinity.org/">https://forum.dfinity.org/</a><br />
Official community forum for discussions, questions, and
announcements.</p></li>
<li><p><strong>Internet Computer Developer Discord</strong><br />
<a
href="https://discord.internetcomputer.org/">https://discord.internetcomputer.org/</a><br />
Real-time chat with the developer community.</p></li>
<li><p><strong>DFINITY GitHub</strong><br />
<a
href="https://github.com/dfinity">https://github.com/dfinity</a><br />
Official repositories including IC SDK, examples, and tools.</p></li>
</ul>
<h3 id="learning-platforms">Learning Platforms</h3>
<ul>
<li><p><strong>ICP Ninja</strong><br />
<a href="https://icp.ninja/">https://icp.ninja/</a><br />
Interactive in-browser environment for writing and testing Motoko
code.</p></li>
<li><p><strong>Motoko Bootcamp</strong><br />
<a
href="https://www.motokobootcamp.com/">https://www.motokobootcamp.com/</a><br />
Community-driven educational program for learning Motoko.</p></li>
<li><p><strong>Internet Computer Developer YouTube
Channel</strong><br />
<a href="https://www.youtube.com/@DFINITY">https://www.youtube.com/<span
class="citation" data-cites="DFINITY">@DFINITY</span></a><br />
Official video tutorials, talks, and demonstrations.</p></li>
</ul>
<h3 id="example-projects">Example Projects</h3>
<ul>
<li><p><strong>Motoko Examples</strong><br />
<a
href="https://github.com/dfinity/examples/tree/master/motoko">https://github.com/dfinity/examples/tree/master/motoko</a><br />
Official collection of Motoko code examples.</p></li>
<li><p><strong>Awesome Internet Computer</strong><br />
<a
href="https://github.com/dfinity/awesome-internet-computer">https://github.com/dfinity/awesome-internet-computer</a><br />
Curated list of resources, tools, and projects.</p></li>
</ul>
<h2 id="development-tools">Development Tools</h2>
<h3 id="ides-and-extensions">IDEs and Extensions</h3>
<ul>
<li><strong>Motoko VS Code Extension</strong><br />
<a
href="https://marketplace.visualstudio.com/items?itemName=dfinity-foundation.vscode-motoko">https://marketplace.visualstudio.com/items?itemName=dfinity-foundation.vscode-motoko</a><br />
Official Visual Studio Code extension with syntax highlighting and
language support.</li>
</ul>
<h2 id="staying-updated">Staying Updated</h2>
<ul>
<li><p><strong>DFINITY Blog</strong><br />
<a
href="https://medium.com/dfinity">https://medium.com/dfinity</a><br />
Official blog with updates, tutorials, and announcements.</p></li>
<li><p><strong>Internet Computer Twitter</strong><br />
<a
href="https://twitter.com/dfinity">https://twitter.com/dfinity</a><br />
Latest news and community highlights.</p></li>
<li><p><strong>Developer Release Notes</strong><br />
<a
href="https://github.com/dfinity/sdk/releases">https://github.com/dfinity/sdk/releases</a><br />
SDK release notes and changelogs.</p></li>
</ul>
<hr />
<h2 id="contributing-to-this-resource-list">Contributing to This
Resource List</h2>
<p>This resource list is maintained as part of the “Mastering Motoko”
book. If you discover broken links, new valuable resources, or have
suggestions for additions, please contribute through the book’s
repository:</p>
<p><strong>Repository</strong>: <a
href="https://github.com/niklabh/motokobook">https://github.com/niklabh/motokobook</a></p>
<hr />
<p><em>Last Updated: November 2025</em></p>
<p><em>Note: URLs and resources may change over time. Please check the
official Internet Computer documentation portal for the most current
links.</em></p>
<hr />
<h2 id="about-this-book">About This Book</h2>
<p>This book was created to provide a comprehensive guide to motoko!
smart contract development on ICP. It covers everything from basic
concepts to advanced production patterns.</p>
<h3 id="technical-specifications">Technical Specifications</h3>
<ul>
<li><strong>dfx! Version</strong>: 0.29.2</li>
<li><strong>Target Environment</strong>: WebAssembly (WASM)</li>
<li><strong>Blockchain Framework</strong>: Internet Computer Protocol
(ICP)</li>
</ul>
<h3 id="contributing">Contributing</h3>
<p>This book is designed to be a living resource for the motoko!
community. For updates, corrections, or contributions, please refer to
the project repository: https://github.com/niklabh/motokobook.</p>
<h3 id="license">License</h3>
<p>This work is intended for educational purposes and represents best
practices as of the publication date. Smart contract development
involves financial risks, and readers should conduct thorough testing
and security audits before deploying contracts in production
environments.</p>
<hr />
<p><em>End of Book</em></p>
</body>
</html>
